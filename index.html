<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Status Search</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Ensure Poppins font is used and provide a fallback */
        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6; /* Improve readability */
            overflow-x: hidden; /* Prevent horizontal scroll on small screens */
        }

        /* Custom styling for the responsive layout */
        /* Hide table headers on small screens */
        @media (max-width: 767px) { /* Tailwind's 'md' breakpoint is 768px, so this targets screens smaller than that */
            #invoiceTable thead {
                display: none;
            }

            #invoiceTable, #invoiceTable tbody, #invoiceTable tr, #invoiceTable td {
                display: block;
                width: 100%;
            }

            #invoiceTable tr {
                margin-bottom: 15px; /* Add space between rows */
                border: 1px solid #d1d5db; /* Add a border */
                border-radius: 0.5rem; /* Rounded corners */
                background-color: #ffffff; /* White background for default */
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); /* Add a subtle shadow */
                overflow: hidden; /* Ensure rounded corners apply */
            }

            /* Add alternating background colors for rows in mobile view */
            #invoiceTable tbody tr:nth-child(even) {
                background-color: #f9fafb; /* Tailwind gray-50 for even rows */
            }

            #invoiceTable td {
                border-bottom: 1px solid #e5e7eb; /* Tailwind gray-200 */
                position: relative;
                padding: 12px 15px 12px 50%; /* Adjust padding for label and content */
                text-align: right; /* Align data to the right */
                font-size: 0.9rem; /* Slightly smaller text for card items */
                min-height: 40px; /* Ensure a minimum height for the cell */
                display: flex; /* Use flexbox for better label/value alignment */
                align-items: center; /* Vertically center content */
                justify-content: flex-end; /* Align content to the right */
            }

            #invoiceTable td:last-child {
                border-bottom: 0; /* No border on the last item in the card */
            }

            /* Add data labels before the content on small screens */
            #invoiceTable td::before {
                content: attr(data-label);
                position: absolute; /* Keep absolute positioning for the label */
                left: 0;
                width: 45%;
                padding-left: 15px;
                font-weight: 600; /* Semi-bold weight for labels */
                text-align: left; /* Align label to the left */
                color: #4b5563; /* Tailwind gray-600 */
                /* Remove flex-related styles from pseudo-element if any were inherited */
                display: block;
                align-items: initial;
                justify-content: initial;
            }

            /* Emphasize SR ID column in mobile view */
            #invoiceTable td[data-label="SR ID:"] {
                background-color: #e0f2f7; /* A light blue background */
                font-weight: 700; /* Make the text bold */
            }

            /* Highlight Voucher No. on mobile */
            #invoiceTable td[data-label="Voucher No.:"].highlight-voucher {
                /* Removed background-color */
                color: #047857; /* Tailwind emerald-700 */
                font-weight: 600; /* Semi-bold */
            }

            /* Adjust button size and spacing on mobile */
            .mb-6.flex.flex-col.md\:flex-row.gap-4.items-center button {
                width: 100%; /* Make buttons full width on mobile */
                padding: 10px 15px; /* Adjust padding */
                font-size: 1rem; /* Standard font size */
            }

            /* Adjust search and reset button container on mobile */
            .search-reset-container {
                flex-direction: column;
                width: 100%;
            }

            .search-input-container {
                width: 100%;
                margin-bottom: 10px; /* Space between search and reset on mobile */
                position: relative; /* Ensure this is relative for absolute children */
                z-index: 100; /* High z-index for the input container */
            }

            .search-reset-container button {
                width: 100%;
            }

            /* Adjust export options container on mobile */
            .export-options {
                width: 100%;
            }

            .export-options button {
                width: 100%;
            }

            /* Mobile specific dropdown styling */
            .export-dropdown {
                position: static; /* Remove absolute positioning on mobile */
                width: 100%;
                margin-top: 10px; /* Space below the button */
                box-shadow: none; /* Remove shadow on mobile */
                border: 1px solid #d1d5db; /* Add border on mobile */
                border-radius: 0.5rem; /* Add border-radius */
            }

            .export-dropdown a {
                padding: 10px; /* Adjust padding */
                text-align: center; /* Center text */
            }

            /* Mobile header adjustments */
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .version-number {
                margin-top: 5px;
                font-size: 0.8rem;
            }

            /* Summary panel adjustments for mobile */
            #quantitySummaryPanel {
                font-size: 0.9rem;
                padding: 10px;
            }

            #consignmentSummaryList {
                margin-top: 5px;
                font-size: 0.85rem;
                list-style: disc; /* Add bullet points */
                padding-left: 20px; /* Add padding for bullet points */
            }

            #consignmentSummaryList li {
                margin-bottom: 3px;
            }

            /* Mobile suggestion list styling */
            #suggestionsList {
                position: absolute; /* Changed to absolute for better control */
                width: 100%;
                margin-top: 0; /* Remove default margin-top */
                border-radius: 0.5rem;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
                z-index: 99; /* High z-index, lower than input container */
                background-color: white; /* Ensure background is white */
                border: 1px solid #d1d5db; /* Add border */
                border-top: none; /* No top border */
                left: 0; /* Align with the left edge of the container */
                top: 100%; /* Position directly below the input container */
                max-height: 150px; /* Limit height */
                overflow-y: auto; /* Add scroll if needed */
            }
            #suggestionsList div {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            /* Style for the empty table message on mobile */
            #invoiceTable td.empty-table-message {
                text-align: left; /* Align text to the left */
                justify-content: flex-start; /* Align flex content to the start */
                padding-left: 15px; /* Restore left padding */
                padding-right: 15px; /* Ensure right padding */
            }

            /* Ensure the ::before pseudo-element is hidden for this specific cell */
            #invoiceTable td.empty-table-message::before {
                content: none;
            }

            /* Mobile specific input and icon positioning */
            .search-input-container input {
                padding-left: 45px; /* Increased padding for icon */
            }

            .search-input-container i {
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
                pointer-events: none;
                z-index: 101;
            }

            /* Mobile adjustments for loading overlay */
            #loadingOverlay {
                justify-content: center;
                padding: 0 1rem;
            }

            .loading-text {
                font-size: 2rem;
                margin-top: 30px;
                white-space: nowrap;
            }

            .version-suffix {
                font-size: 0.7em;
                color: #93c5fd;
                font-weight: 600;
                vertical-align: super;
                margin-left: 0.2em;
            }
        }

        /* Default table styling for larger screens (md and up) */
        @media (min-width: 768px) {
            #invoiceTable th,
            #invoiceTable td {
                border-bottom: 1px solid #e5e7eb;
                padding: 12px 16px;
                text-align: left;
            }
            #invoiceTable thead th {
                border-bottom-width: 2px;
                border-top: none;
                background-color: #f3f4f6;
                color: #4b5563;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.8rem;
                cursor: pointer;
                padding-right: 25px;
                position: relative;
            }

            /* Style for sort icons in table headers */
            #invoiceTable thead th i {
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
                font-size: 0.7em;
                visibility: hidden;
            }

            /* Show sort icon when parent th has 'sortable' class and data is filtered */
            #invoiceTable thead th.sortable i {
                visibility: visible;
            }

            /* Highlight Voucher No. on desktop */
            #invoiceTable td.highlight-voucher {
                color: #047857;
                font-weight: 600;
            }

            #invoiceTable tbody tr:last-child td {
                border-bottom: none;
            }
            /* Optional: Add alternating row colors for better readability */
            #invoiceTable tbody tr:nth-child(even) {
                background-color: #f9fafb;
            }
            #invoiceTable tbody tr:hover {
                background-color: #eef2ff;
                transition: background-color 0.2s ease-in-out;
            }

            /* Desktop header adjustments */
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .version-number {
                font-size: 0.9rem;
            }
            /* Summary panel adjustments for desktop */
            #quantitySummaryPanel {
                font-size: 1rem;
                padding: 1rem;
            }

            #consignmentSummaryList {
                margin-top: 8px;
                font-size: 0.9rem;
                list-style: disc;
                padding-left: 25px;
            }

            #consignmentSummaryList li {
                margin-bottom: 4px;
            }

            /* Desktop suggestion list styling */
            #suggestionsList {
                position: absolute;
                width: max-content;
                min-width: 100%;
                max-height: 300px;
                overflow-y: auto;
                background-color: white;
                border: 1px solid #d1d5db;
                border-top: none;
                border-bottom-left-radius: 0.5rem;
                border-bottom-right-radius: 0.5rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 20;
                top: 100%;
                left: 0;
                padding-right: 15px;
            }

            #suggestionsList div {
                padding: 10px 15px;
                cursor: pointer;
                font-size: 0.9rem;
                color: #4b5563;
                white-space: nowrap;
                max-width: none;
            }

            #suggestionsList div:hover {
                background-color: #f3f4f6;
            }
        }

        /* General button styling improvements */
        button {
            transition: all 0.15s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button i {
            margin-right: 8px;
        }

        /* Style for disabled export button */
        #exportButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Style for the search input container and icon */
        .search-input-container {
            position: relative;
            flex-grow: 1;
            overflow: visible;
        }

        /* Default padding for input (desktop and general) */
        .search-input-container input {
            padding-left: 40px;
        }

        /* Default icon positioning (desktop and general) */
        .search-input-container i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
            z-index: 1;
        }

        /* Header styling */
        .header {
            background-color: #1d4ed8;
            color: white;
            padding: 1.5rem;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .header-content {
            display: flex;
        }

        .version-number {
            color: #93c5fd;
            font-weight: 400;
        }

        /* Styling for the summary panel content */
        .summary-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-icon {
            font-size: 1.5rem;
            color: #1e3a8a;
        }

        /* Loading Overlay Styles */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1d4ed8;
            background-image: radial-gradient(circle at center, #1d4ed8 0%, #1e40af 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.5s ease-out;
        }

        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            font-size: 2.5rem;
            font-weight: 700;
            margin-top: 40px;
            animation: fadeInOut 2s infinite alternate;
        }

        .version-suffix {
            font-size: 1.5rem;
            color: #93c5fd;
            font-weight: 600;
            vertical-align: super;
            margin-left: 0.2em;
        }

        .loading-dots-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .loading-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #93c5fd;
            animation: bounce 1.4s infinite ease-in-out;
        }

        /* Specific colors for each dot */
        .loading-dot:nth-child(1) { background-color: #4285F4; }
        .loading-dot:nth-child(2) { background-color: #EA4335; animation-delay: 0.1s; }
        .loading-dot:nth-child(3) { background-color: #FBBC05; animation-delay: 0.2s; }
        .loading-dot:nth-child(4) { background-color: #34A853; animation-delay: 0.3s; }


        /* Keyframe Animations */
        @keyframes fadeInOut {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        /* New CSS for loading dots in message box */
        .loading-message-dots {
            display: inline-block;
            margin-left: 8px;
        }

        .loading-message-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
            margin: 0 2px;
            animation: pulse 1.4s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Styles for the Details Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white; /* Pure white background */
            background-image: none; /* Removed gradient */
            padding: 1.5rem; /* Reduced padding for a more compact receipt feel */
            border-radius: 0.25rem; /* Minimal border-radius for sharp edges like a receipt */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* Lighter, less spread shadow */
            width: 90%;
            max-width: 380px; /* Narrower for receipt-like feel */
            transform: translateY(-10px) scale(0.99); /* Subtle animation */
            transition: transform 0.2s ease-out; /* Quicker animation */
            position: relative;
            color: #1f2937; /* Dark gray for main text, good for print */
            border: 1px solid #e5e7eb; /* Subtle light gray border */
            
            /* Added for button positioning */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Distributes space between items, pushing footer to bottom */
            min-height: 250px; /* Ensure enough height for space-between to work */
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            display: flex;
            flex-direction: column; /* Stack title and close button */
            align-items: center; /* Center header content */
            border-bottom: 1px dashed #d1d5db; /* Dashed line for receipt feel */
            padding-bottom: 1rem;
            margin-bottom: 1.25rem;
            position: relative; /* For positioning close button */
        }

        .modal-header h2 {
            font-size: 1.5rem; /* Slightly smaller title for receipt */
            font-weight: 700;
            color: #1f2937; /* Darker title color */
            text-shadow: none;
            margin-bottom: 0.5rem; /* Space between title and close button */
        }

        .modal-close-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
            padding: 0.25rem;
        }

        .modal-close-button:hover {
            color: #dc2626; /* Red-600 on hover */
            transform: rotate(90deg);
        }

        .modal-body {
            flex-grow: 1; /* Allow modal body to take up available space */
        }

        .modal-body p {
            margin-bottom: 0.25rem; /* Reduced space between lines */
            font-size: 0.85rem; /* Slightly smaller text for receipt */
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 0.1rem 0; /* Minimal vertical padding */
            border-bottom: none; /* No border for each line */
        }

        .modal-body strong {
            color: #4b5563; /* Tailwind gray-600 */
            font-weight: normal; /* No bold for labels */
            flex-shrink: 0;
            margin-right: 0.5rem; /* Reduced space */
            width: 55%; /* Give more space to label */
            text-align: left; /* Ensure labels are left-aligned */
        }

        .modal-body span {
            color: #1f2937; /* Dark gray for values, good for print */
            font-weight: 600; /* Semi-bold for values to stand out slightly */
            text-align: right;
            flex-grow: 1; /* Allow value to take remaining space */
        }

        .modal-footer {
            display: flex;
            flex-direction: column; /* Stack content in footer */
            align-items: center; /* Center footer content */
            gap: 1rem;
            border-top: 1px dashed #d1d5db; /* Dashed line for receipt feel */
            padding-top: 1.25rem;
            margin-top: 1.5rem;
        }

        .modal-footer button {
            padding: 0.6rem 1.2rem; /* Smaller buttons */
            border-radius: 0.375rem; /* Slightly less rounded */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Even lighter shadow */
        }

        .modal-print-button {
            background-color: #22c55e;
            color: white;
            border: 1px solid #22c55e;
        }

        .modal-print-button:hover {
            background-color: #16a34a;
            box-shadow: 0 2px 5px rgba(34, 197, 94, 0.2);
        }

        .modal-cancel-button {
            background-color: white;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }

        .modal-cancel-button:hover {
            background-color: #f9fafb; /* Lighter hover background */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .modal-note {
            font-size: 0.8rem; /* Smaller font for the note */
            color: #6b7280; /* Gray text for notes */
            text-align: left; /* Aligned left as requested */
            margin-top: 0.75rem; /* Space above the note */
            line-height: 1.4;
        }
        /* Print specific styles */
        @media print {
            body.print-active > *:not(.modal-overlay) {
                display: none;
            }
            body.print-active .modal-overlay {
                position: static;
                background-color: transparent;
                display: block;
                width: auto;
                height: auto;
                overflow: visible;
            }
            body.print-active .modal-content {
                width: 80mm; /* A common width for thermal receipts */
                max-width: 80mm; /* Ensure it doesn't expand beyond this */
                box-shadow: none;
                border: none;
                padding: 8mm; /* Increased padding for margin on all sides */
                transform: none;
                border-radius: 0; /* No rounded corners for print */
                margin: 0; /* Remove auto margins to align left */
                float: left; /* Float left to ensure it's on the left side of the paper */
                min-height: auto; /* Remove min-height for print */
            }
            body.print-active .modal-header {
                border-bottom: 1px dashed #d1d5db; /* Keep dashed border for header */
                padding-bottom: 0.5rem; /* Reduced padding for header */
                margin-bottom: 0.5rem; /* Reduced margin for header */
                align-items: flex-start; /* Align header content to the left */
            }
            body.print-active .modal-footer {
                border-top: none; /* Remove existing border-top */
                padding-top: 0; /* Adjust padding as separator will handle spacing */
                margin-top: 0; /* Adjust margin as separator will handle spacing */
                align-items: flex-start; /* Align footer content to the left */
            }
            body.print-active .modal-close-button,
            body.print-active .modal-footer button {
                display: none; /* Hide buttons when printing */
            }
            body.print-active .modal-header h2 {
                font-size: 1.1rem; /* Even smaller for print */
                margin-bottom: 0; /* Remove margin-bottom from h2 in print */
                font-family: 'Courier New', Courier, monospace; /* Changed font to courier-like */
                font-weight: 600; /* Adjusted weight for courier font */
                text-align: left; /* Ensure title is left-aligned in print */
            }
            body.print-active .modal-body p {
                font-size: 0.75rem; /* Slightly smaller for print to make it lighter */
                margin-bottom: 0.1rem; /* Very little space between lines */
                padding: 0.1rem 0;
                font-family: 'Poppins', sans-serif; /* Reverted to Poppins */
            }
            body.print-active .modal-body strong {
                font-weight: 400; /* Lighter font weight for labels */
                margin-right: 0.5rem; /* Reduced margin for labels */
                width: 55%; /* Allocate more width to labels */
                flex-shrink: 0; /* Prevent labels from shrinking */
                text-align: left; /* Ensure labels are left-aligned */
                font-family: 'Poppins', sans-serif; /* Reverted to Poppins */
            }
            body.print-active .modal-body span {
                font-weight: 500; /* Slightly lighter bold for values */
                flex-grow: 1; /* Allow values to take remaining space */
                text-align: right; /* Ensure values are right-aligned */
                font-family: 'Poppins', sans-serif; /* Reverted to Poppins */
            }
            body.print-active .modal-note {
                font-size: 0.6rem; /* Made smaller */
                font-style: italic; /* Italicize the note */
                margin-top: 1rem; /* Space after date line */
                text-align: left; /* Align note to the left */
                color: #a1a1aa; /* Even lighter gray for notes (tailwind gray-400) */
                line-height: 1.3; /* Slightly tighter line height */
            }

            /* Styles for the new print separator */
            .print-separator {
                display: block; /* Show only when printing */
                width: 100%;
                margin-top: 1.5rem; /* Space above the separator */
                margin-bottom: 1rem; /* Space below the separator */
                border-bottom: 1px dashed #d1d5db; /* Dashed line */
            }

            /* Styles for signature section */
            .signature-section {
                display: flex; /* Show only when printing */
                flex-direction: column;
                align-items: flex-start; /* Left-align the whole section */
                width: 100%;
                margin-top: 0; /* Controlled by print-separator */
                padding-top: 0; /* No top padding */
                border-top: none; /* No border here */
                font-family: 'Poppins', sans-serif;
                color: #1f2937;
            }

            .signature-block-centered { /* Wrapper for line and text to center them */
                display: flex;
                flex-direction: column;
                align-items: flex-start; /* Left-align its children (line and text) */
                width: 100%; /* Take full width of its centered parent */
                margin: 0; /* Remove auto margins, alignment handled by parent */
                margin-top: 0.75rem; /* Reduced space from the separator */
            }

            .signature-line {
                border-bottom: 1px solid #a1a1aa; /* Changed to gray-400 for lighter appearance */
                width: 75%; /* Adjusted width to make it shorter */
                margin-bottom: 0.15rem; /* Reduced space below the line */
            }

            .signature-text {
                font-size: 0.4rem; /* Further reduced font size for "Signature over Printed Name" */
                color: #4b5563; /* Medium gray */
                text-align: left; /* Align text to the left */
                width: 75%; /* Adjusted width to match line */
                margin-top: 0; /* No extra top margin */
                line-height: 1; /* Tighter line height */
            }

            .date-line {
                margin-top: 0.75rem; /* Reduced space above date */
                font-size: 0.4rem; /* Further reduced font size for date */
                color: #4b5563; /* Changed to match signature-text color */
                width: 100%; /* Ensure it takes full width */
                text-align: left; /* Left-align the date line */
            }
        }

        /* Hide signature section by default for both desktop and mobile modal views */
        .signature-section {
            display: none;
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="loading-dots-container">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
        <h1 class="loading-text">ConsignTracker <span class="version-suffix">v2</span></h1>
    </div>

    <div id="mainContent" class="hidden">
        <div class="container mx-auto max-w-screen-lg bg-white rounded-xl shadow-2xl border border-gray-200 mt-10 mb-10">
            <div class="header">
                <div class="header-content">
                    <div>
                        <h1 class="text-3xl font-bold">ConsignTracker</h1>
                        <p class="text-blue-200 mt-1 text-sm">Smart lookup for consignors: reported sales, invoices, and vouchers at a glance.</p>
                    </div>
                    <div class="version-number">Version: 2.0 build 6</div>
                </div>
            </div>

            <div class="p-6">
                <div class="mb-6 flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex gap-4 flex-grow search-reset-container">
                        <div class="search-input-container">
                            <input type="text" id="searchInput" placeholder="Search by, Consignment Order Number, SR ID, or Invoice No."
                                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent text-gray-700 shadow-sm">
                            <i class="fas fa-search"></i>
                            <div id="suggestionsList" class="hidden"></div>
                        </div>
                        <button id="resetButton"
                                class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-opacity-50 transition duration-150 ease-in-out shadow-sm">
                            <i class="fas fa-sync-alt"></i> Reset
                        </button>
                    </div>

                    <div class="export-options relative">
                        <button id="exportButton" disabled
                                class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50 transition duration-150 ease-in-out shadow-sm">
                            <i class="fas fa-download"></i> Export <i class="fas fa-caret-down ml-2"></i>
                        </button>
                        <div id="exportDropdown" class="export-dropdown hidden absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-xl z-10">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="csv">Export as CSV</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="html" id="exportHtmlOption">Export as HTML</a>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-2">Type your SR ID, Consignment Order #, or Invoice # to search. Select a suggestion or press Enter.</p>
                <div id="quantitySummaryPanel" class="mt-4 p-4 bg-blue-100 border border-blue-200 rounded-lg text-blue-800 font-semibold hidden">
                    <div class="summary-content">
                        <i class="fas fa-info-circle summary-icon"></i> <div id="overallSummary"></div>
                    </div>
                    <ul id="consignmentSummaryList" class="mt-2 text-sm font-normal">
                    </ul>
                    </div>

                <div id="tableContainer" class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm mt-4 px-4">
                    <table id="invoiceTable" class="min-w-full bg-white">
                        <thead class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left" data-sort="SR ID">SR ID</th>
                                <th class="py-3 px-6 text-left" data-sort="Name of Company">Name of Company</th>
                                <th class="py-3 px-6 text-left sortable" data-sort="Consignment Order Number">Consignment Order Number <i class="fas fa-sort"></i></th>
                                <th class="py-3 px-6 text-left" data-sort="Quantity Sold">Quantity Sold</th>
                                <th class="py-3 px-6 text-left" data-sort="Amount">Amount</th>
                                <th class="py-3 px-6 text-left" data-sort="Invoice No.">Invoice No.</th>
                                <th class="py-3 px-6 text-left" data-sort="Voucher No.">Voucher No.</th>
                                <th class="py-3 px-6 text-left" data-sort="Voucher Date">Voucher Date</th>
                                <th class="py-3 px-6 text-left">Details</th> </tr>
                        </thead>
                        <tbody id="invoiceTableBody" class="text-gray-700 text-sm font-light">
                            <tr>
                                <td colspan="9" class="text-center py-4 text-gray-500 empty-table-message">Enter a search term and press Enter or select a suggestion.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="paginationContainer" class="mt-6 flex flex-col md:flex-row justify-between items-center">
                    <div class="flex gap-4 mb-4 md:mb-0">
                        <button id="prevPageButton"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out shadow-sm">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button id="nextPageButton"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out shadow-sm">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <span id="pageInfo" class="text-gray-700 text-sm"></span>
                </div>

                <div id="messageBox" class="mt-4 p-4 rounded-md hidden"></div>

            </div>
        </div>
    </div>

    <div id="detailsModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>S.R. Acknowledgement Slip</h2>
                <button class="modal-close-button" id="closeModalButton">&times;</button>
            </div>
            <div class="modal-body" id="modalDetailsBody">
                </div>
            <div class="modal-footer">
                <button class="modal-print-button" id="printDetailsButton"><i class="fas fa-print"></i> Print</button>
                
                <div class="print-separator"></div>

                <div class="signature-section">
                    <div class="signature-block-centered">
                        <div class="signature-line"></div>
                        <p class="signature-text">Signature over Printed Name</p>
                    </div>
                    <p class="date-line">Date: _______________</p>
                </div>
                <p class="modal-note">
                    <strong>Note to Supplier:</strong> Please attach this form to your sales invoice upon submission. Failure to attach may result in delays in verifying and processing your invoice.
                </p>
            </div>
        </div>
    </div>

<script>
        const jsonUrl = "https://raw.githubusercontent.com/moonandjupiter/my-json-data/refs/heads/main/Sheet1_data.json";
        const itemsPerPage = 5;
        let currentPage = 1;
        let allData = [];
        let filteredData = []; // This will now only be updated on search/reset
        let currentSortColumn = null;
        let currentSortDirection = 'asc'; // 'asc' or 'desc'

        const searchInput = document.getElementById('searchInput');
        const resetButton = document.getElementById('resetButton');
        const exportButton = document.getElementById('exportButton');
        const exportDropdown = document.getElementById('exportDropdown');
        const exportHtmlOption = document.getElementById('exportHtmlOption');
        const invoiceTableBody = document.getElementById('invoiceTableBody');
        const prevPageButton = document.getElementById('prevPageButton');
        const nextPageButton = document.getElementById('nextPageButton');
        const pageInfoSpan = document.getElementById('pageInfo');
        const messageBox = document.getElementById('messageBox');
        const quantitySummaryPanel = document.getElementById('quantitySummaryPanel');
        const overallSummaryDiv = document.getElementById('overallSummary');
        const consignmentSummaryList = document.getElementById('consignmentSummaryList');
        const suggestionsList = document.getElementById('suggestionsList');
        const sortableTableHeaders = document.querySelectorAll('#invoiceTable th.sortable');
        const tableContainer = document.getElementById('tableContainer');
        const paginationContainer = document.getElementById('paginationContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainContent = document.getElementById('mainContent');

        // Modal elements
        const detailsModalOverlay = document.getElementById('detailsModalOverlay');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalDetailsBody = document.getElementById('modalDetailsBody');
        const printDetailsButton = document.getElementById('printDetailsButton');
        const signatureSection = document.querySelector('.signature-section'); // Get signature section
        const modalNote = document.querySelector('.modal-note'); // Get modal note
        const printSeparator = document.querySelector('.print-separator'); // Get print separator
        
        // Function to show messages
        function showMessage(message, type = 'info') {
            // Clear all relevant classes first to ensure a clean slate
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-center');
            messageBox.innerHTML = ''; // Clear previous content

            if (message === "Loading results, please wait..." && type === 'info') {
                messageBox.classList.add('bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-content-center');
                messageBox.innerHTML = `
                    <span>${message}</span>
                    <span class="loading-message-dots">
                        <span class="loading-message-dot"></span>
                        <span class="loading-message-dot"></span>
                        <span class="loading-message-dot"></span>
                    </span>
                `;
            } else {
                messageBox.classList.add('mt-4', 'p-4', 'rounded-md'); // Re-add base styling
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                } else {
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                }
                messageBox.textContent = message; // Use textContent for simple messages
            }
            messageBox.classList.remove('hidden'); // Ensure message box is visible
        }

        // Function to hide messages
        function hideMessageBox() {
            messageBox.classList.add('hidden');
            messageBox.innerHTML = ''; // Clear content when hidden
            messageBox.classList.remove('bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-content-center'); // Also remove styling classes
        }

        // Function to calculate and display the total quantity of the filtered data and per consignment
        function calculateAndDisplaySummary() {
            const totalResults = filteredData.length;
            const resultWord = totalResults === 1 ? 'result' : 'results';
            overallSummaryDiv.textContent = `Found ${totalResults} ${resultWord}:`;

            // Aggregate by Consignment Order Number only for the summary panel
            const consignmentTotals = filteredData.reduce((acc, item) => {
                const consignmentNumber = String(item['Consignment Order Number'] || 'N/A');
                const quantity = parseInt(item['Quantity Sold'], 10);
                const amount = parseFloat(String(item['Amount'] || '0').replace(/[^0-9.-]+/g,""));
                
                if (!acc[consignmentNumber]) {
                    acc[consignmentNumber] = {
                        consignmentOrder: consignmentNumber,
                        quantity: 0,
                        amount: 0
                    };
                }
                
                if (!isNaN(quantity)) {
                    acc[consignmentNumber].quantity += quantity;
                }
                if (!isNaN(amount)) {
                    acc[consignmentNumber].amount += amount;
                }
                return acc;
            }, {});

            consignmentSummaryList.innerHTML = '';

            if (Object.keys(consignmentTotals).length > 0) {
                const sortedConsignments = Object.entries(consignmentTotals).sort(([keyA, valA], [keyB, valB]) => {
                    return String(valA.consignmentOrder).localeCompare(String(valB.consignmentOrder));
                });

                sortedConsignments.forEach(([compositeKey, totals]) => {
                    const formattedQuantity = totals.quantity.toLocaleString();
                    const formattedAmount = totals.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const pcWord = totals.quantity === 1 ? 'pc' : 'pcs';
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `CO Number ${totals.consignmentOrder} : <span class="font-bold text-blue-700">${formattedQuantity} ${pcWord}</span>, Total Amount <span class="font-bold text-blue-700">${formattedAmount}</span> reported sold.`;
                    consignmentSummaryList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'No consignment breakdown available.';
                consignmentSummaryList.appendChild(listItem);
            }

            if (searchInput.value.trim() !== '' && filteredData.length > 0) {
                quantitySummaryPanel.classList.remove('hidden');
            } else {
                quantitySummaryPanel.classList.add('hidden');
            }
        }

        // Function to update pagination button states and info
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            pageInfoSpan.textContent = filteredData.length === 0 ? 'No data' : `Page ${currentPage} of ${totalPages}`;

            prevPageButton.disabled = currentPage === 1 || filteredData.length === 0;
            nextPageButton.disabled = currentPage >= totalPages || filteredData.length === 0;
        }

        // Function to update sort icons in table headers
        function updateSortIcons() {
            sortableTableHeaders.forEach(header => {
                const sortColumn = header.getAttribute('data-sort');
                const icon = header.querySelector('i');
                if (icon) {
                    if (filteredData.length === 0) {
                        icon.style.visibility = 'hidden';
                        header.classList.remove('sorted-asc', 'sorted-desc');
                    } else {
                        icon.style.visibility = 'visible';
                        icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down');
                        if (sortColumn === currentSortColumn) {
                            icon.classList.add(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                            header.classList.add(currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                        } else {
                            icon.classList.add('fa-sort');
                            header.classList.remove('sorted-asc', 'sorted-desc');
                        }
                    }
                }
            });
        }

        // Function to sort data
        function sortData(column) {
            if (filteredData.length === 0) {
                return;
            }

            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            filteredData.sort((a, b) => {
                const valueA = a[column] || '';
                const valueB = b[column] || '';

                // Handle numeric sorting for Quantity Sold and Amount
                if (column === 'Quantity Sold' || column === 'Amount') {
                    const numA = parseFloat(String(valueA).replace(/[^0-9.-]+/g,"")) || 0;
                    const numB = parseFloat(String(valueB).replace(/[^0-9.-]+/g,"")) || 0;
                    if (numA < numB) {
                        return currentSortDirection === 'asc' ? -1 : 1;
                    }
                    if (numA > numB) {
                        return currentSortDirection === 'asc' ? 1 : -1;
                    }
                    return 0;
                }
                // Default to string comparison for other columns
                if (valueA < valueB) {
                    return currentSortDirection === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return currentSortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });

            currentPage = 1;
            renderTable();
            calculateAndDisplaySummary();
        }

        // Function to render the table for the current page
        function renderTable() {
            invoiceTableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const dataToDisplay = filteredData.slice(startIndex, endIndex);

            if (filteredData.length === 0) {
                const message = searchInput.value.trim() === '' ? 'Enter a search term and press Enter or select a suggestion.' : 'No data found for your search.';
                // Changed colspan from 8 to 9 due to new column
                invoiceTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500 empty-table-message">${message}</td></tr>`;

                // Explicitly hide table and pagination when no data is found
                tableContainer.style.display = 'none';
                paginationContainer.style.display = 'none';

            } else {
                dataToDisplay.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    // Determine if voucher number exists to apply highlight class
                    // A voucher is considered valid if it's not empty, not '0', and not '-'
                    const voucherValue = String(item['Voucher No.'] || '').trim();
                    const hasValidVoucher = voucherValue !== '' && voucherValue !== '0' && voucherValue !== '-';
                    const voucherClass = hasValidVoucher ? 'highlight-voucher' : '';

                    row.innerHTML = `
                        <td data-label="SR ID:" class="px-6 py-3">${item['SR ID'] || ''}</td>
                        <td data-label="Company:" class="px-6 py-3">${item['Name of Company'] || ''}</td>
                        <td data-label="Order Number:" class="px-6 py-3">${item['Consignment Order Number'] || ''}</td>
                        <td data-label="Quantity:" class="px-6 py-3">${item['Quantity Sold'] || ''}</td>
                        <td data-label="Amount:" class="px-6 py-3">${item['Amount'] || ''}</td>
                        <td data-label="Invoice No.:" class="px-6 py-3">${item['Invoice No.'] || ''}</td>
                        <td data-label="Voucher No.:" class="px-6 py-3 ${voucherClass}">${item['Voucher No.'] || ''}</td>
                        <td data-label="Voucher Date:" class="px-6 py-3">${item['Voucher Date'] || ''}</td>
                        <td data-label="Details:" class="px-6 py-3 text-center">
                            <button class="details-button text-blue-600 hover:text-blue-800 transition-colors duration-150"
                                data-sr-id="${item['SR ID'] || ''}"
                                data-consignment-order="${item['Consignment Order Number'] || ''}">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                    invoiceTableBody.appendChild(row);
                });

                // Explicitly show table and pagination when data is present
                tableContainer.style.display = 'block';
                paginationContainer.style.display = 'flex';
            }

            updatePaginationControls();
            exportButton.disabled = filteredData.length === 0;
            updateSortIcons();
            addDetailsButtonListeners(); // Add listeners after rendering
        }

        // Function to fetch data from the JSON URL
        async function fetchData() {
            // Show loading overlay immediately
            loadingOverlay.classList.remove('hidden');
            mainContent.classList.add('hidden');

            // Hide table and pagination initially to prevent flicker if they were visible
            tableContainer.style.display = 'none';
            paginationContainer.style.display = 'none';

            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allData = await response.json();
                filteredData = []; // Reset filtered data on initial load
                hideMessageBox();
                quantitySummaryPanel.classList.add('hidden');

            } catch (error) {
                console.error("Error fetching data:", error);
                showMessage(`Failed to load data: ${error.message}`, 'error');
                // Still hide overlay even on error, but show error message
                invoiceTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-red-500 empty-table-message">Error loading data.</td></tr>'; // Changed colspan
                quantitySummaryPanel.classList.add('hidden');
                // Ensure main content is visible even on error
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                }, 500); // Shorter delay for error
                return; // Exit if data fetching failed
            } finally {
                // After data is fetched (successfully or not), render the table and then hide the overlay
                renderTable(); // This will show the table/pagination if data is present
                // Add a slightly longer delay for the animation to play before hiding the overlay
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                }, 3000); // Increased to 3 seconds for a longer animation
            }
        }

        // Function to perform the search
        // Accepts an optional searchValue to filter by a specific key value (used for suggestion clicks)
        function performSearch(searchValue = null) {
            // Show loading message and hide table/pagination immediately
            showMessage("Loading results, please wait...", 'info');
            tableContainer.style.display = 'none';
            paginationContainer.style.display = 'none';
            quantitySummaryPanel.classList.add('hidden'); // Hide summary panel during loading

            // Delay the actual search and rendering
            setTimeout(() => {
                if (searchValue !== null) {
                    const searchConsignmentNumber = String(searchValue).toLowerCase();
                    filteredData = allData.filter(item => {
                        const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                        return consignmentOrderNumber === searchConsignmentNumber;
                    });

                } else {
                    const searchTerm = searchInput.value.toLowerCase();

                    if (searchTerm) {
                        let exactMatchFound = false;
                        let exactMatchValue = null;

                        for (const item of allData) {
                            const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                            const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                            const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';

                            if (srId === searchTerm || consignmentOrderNumber === searchTerm || invoiceNo === searchTerm) {
                                exactMatchFound = true;
                                if (srId === searchTerm) exactMatchValue = item['SR ID'];
                                else if (consignmentOrderNumber === searchTerm) exactMatchValue = item['Consignment Order Number'];
                                else if (invoiceNo === searchTerm) exactMatchValue = item['Invoice No.'];
                                break;
                            }
                        }

                        if (exactMatchFound && exactMatchValue !== null) {
                            filteredData = allData.filter(item => {
                                const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                                const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                                const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';
                                return srId === searchTerm || consignmentOrderNumber === searchTerm || invoiceNo === searchTerm;
                            });

                        } else {
                            filteredData = allData.filter(item => {
                                const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                                const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                                const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';

                                return srId.includes(searchTerm) ||
                                    consignmentOrderNumber.includes(searchTerm) ||
                                    invoiceNo.includes(searchTerm);
                            });
                        }
                    } else {
                        filteredData = [];
                    }
                }

                currentPage = 1;
                calculateAndDisplaySummary();
                renderTable();
                
                // Ensure message box is hidden after search completes, regardless of results
                hideMessageBox();

                // If no results for a non-empty search, show "No matching results found."
                if (filteredData.length === 0 && searchInput.value.trim() !== '') {
                    showMessage("No matching results found.", 'info');
                }

            }, 1500);
        }

        // Optional: Allow pressing Enter in the search field to trigger search
        searchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                performSearch();
                suggestionsList.classList.add('hidden');
            }
        });

        // Event listener for input changes in the search field for suggestions
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            suggestionsList.innerHTML = '';

            if (searchTerm.length > 2 && allData.length > 0) {
                const matchedItems = new Map();

                allData.forEach(item => {
                    const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                    const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']) : 'N/A';
                    const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';
                    const companyName = item['Name of Company'] ? String(item['Name of Company']) : 'Unknown Company';

                    if (srId.includes(searchTerm) || consignmentOrderNumber.toLowerCase().includes(searchTerm) || invoiceNo.includes(searchTerm)) {
                        const suggestionValue = consignmentOrderNumber;
                        const suggestionKey = suggestionValue;

                        if (suggestionValue !== 'N/A' && !matchedItems.has(suggestionKey)) {
                            matchedItems.set(suggestionKey, {
                                display: `${companyName} – ${consignmentOrderNumber}`,
                                value: suggestionValue
                            });
                        }
                    }
                });

                if (matchedItems.size > 0) {
                    const sortedSuggestions = Array.from(matchedItems.values()).sort((a, b) => a.display.localeCompare(b.display));

                    sortedSuggestions.forEach(suggestion => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.textContent = suggestion.display;
                        suggestionItem.setAttribute('data-value', suggestion.value);
                        suggestionItem.classList.add('px-4', 'py-2', 'cursor-pointer', 'hover:bg-gray-100', 'text-gray-700');
                        suggestionItem.addEventListener('click', () => {
                            searchInput.value = suggestion.display;
                            suggestionsList.classList.add('hidden');
                            performSearch(suggestion.value); // Trigger search with animation
                        });
                        suggestionsList.appendChild(suggestionItem);
                    });
                    suggestionsList.classList.remove('hidden');
                } else {
                    suggestionsList.classList.add('hidden');
                }
            } else {
                suggestionsList.classList.add('hidden');
            }
            // Ensure message box is hidden when suggestions appear
            hideMessageBox();
        });

        // Event listener for the reset button
        resetButton.addEventListener('click', () => {
            searchInput.value = '';
            filteredData = [];
            currentPage = 1;
            hideMessageBox();
            currentSortColumn = null;
            currentSortDirection = 'asc';
            calculateAndDisplaySummary();
            renderTable();
            suggestionsList.classList.add('hidden');
            suggestionsList.innerHTML = '';

            // Ensure table and pagination are hidden on reset
            tableContainer.style.display = 'none';
            paginationContainer.style.display = 'none';
        });

        // Hide the dropdown if the user clicks outside of it
        window.addEventListener('click', (event) => {
            if (!exportButton.contains(event.target) && !exportDropdown.contains(event.target) && !searchInput.contains(event.target) && !suggestionsList.contains(event.target)) {
                exportDropdown.classList.add('hidden');
                suggestionsList.classList.add('hidden');
            }
        });

        // Function to update the HTML export option label based on screen size
        function updateHtmlOptionLabel() {
            if (window.innerWidth <= 767) {
                exportHtmlOption.textContent = 'Export for Mobile Browser';
            } else {
                exportHtmlOption.textContent = 'Export as HTML';
            }
        }

        // Update label on page load and window resize
        window.addEventListener('load', updateHtmlOptionLabel);
        window.addEventListener('resize', updateHtmlOptionLabel);

        // Event listener for the previous page button
        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        // Event listener for the next page button
        nextPageButton.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        // Add event listener for the export button to toggle the dropdown visibility
        exportButton.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            exportDropdown.classList.toggle('hidden');
        });

        // Add event listeners for the export dropdown options
        exportDropdown.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const format = link.getAttribute('data-format');

                if (format === 'csv') {
                    exportTableToCSV();
                } else if (format === 'html') {
                    exportTableToHTML();
                }

                exportDropdown.classList.add('hidden');
            });
        });

        // Function to export table data to CSV
        function exportTableToCSV() {
            if (filteredData.length === 0) {
                showMessage("No data to export.", 'info');
                return;
            }

            const headers = Object.keys(filteredData[0]);
            const csvRows = [];

            csvRows.push(headers.map(header => `"${header.replace(/"/g, '""')}"`).join(','));

            filteredData.forEach(item => {
                const values = headers.map(header => {
                    const value = item[header] === null || item[header] === undefined ? '' : String(item[header]);
                    return `"${value.replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'invoice_data.csv');

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => URL.revokeObjectURL(link.href), 10000);

            showMessage("Data exported as CSV.", 'success');
        }

        // Function to export table data to HTML
        function exportTableToHTML() {
            if (filteredData.length === 0) {
                showMessage("No data to export.", 'info');
                return;
            }

            const headers = Object.keys(filteredData[0]);
            let htmlString = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Invoice Data Export</title>
                    <style>
                        body { font-family: sans-serif; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <h1>Invoice Data Export</h1>
                    <table>
                        <thead>
                            <tr>
                                ${headers.map(header => `<th>${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredData.forEach(item => {
                htmlString += '<tr>';
                headers.forEach(header => {
                    const value = item[header] === null || item[header] === undefined ? '' : String(item[header]);
                    htmlString += `<td>${value}</td>`;
                });
                htmlString += '</tr>';
            });

            htmlString += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob([htmlString], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');

            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'invoice_data.html');

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => URL.revokeObjectURL(link.href), 10000);

            showMessage("Data exported as HTML.", 'success');
        }

        // Add event listeners for sortable headers
        sortableTableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortColumn = header.getAttribute('data-sort');
                if (sortColumn) {
                    sortData(sortColumn);
                }
            });
        });

        // Function to show the details modal
        function showDetailsModal(srId, consignmentOrder) {
            // Filter all data (not just current filteredData) to ensure we get all related records
            const relatedRecords = allData.filter(item => 
                String(item['SR ID'] || 'N/A') === String(srId) &&
                String(item['Consignment Order Number'] || 'N/A') === String(consignmentOrder)
            );

            let totalQuantity = 0;
            let totalAmount = 0;

            relatedRecords.forEach(item => {
                const quantity = parseInt(item['Quantity Sold'], 10);
                const amount = parseFloat(String(item['Amount'] || '0').replace(/[^0-9.-]+/g,""));

                if (!isNaN(quantity)) {
                    totalQuantity += quantity;
                }
                if (!isNaN(amount)) {
                    totalAmount += amount;
                }
            });

            modalDetailsBody.innerHTML = `
                <p><strong>SR ID:</strong> <span>${srId}</span></p>
                <p><strong>Consignment Order Number:</strong> <span>${consignmentOrder}</span></p>
                <p><strong>Total Quantity Sold:</strong> <span>${totalQuantity.toLocaleString()} pcs</span></p>
                <p><strong>Total Amount:</strong> <span>${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></p>
            `;
            detailsModalOverlay.classList.add('show');
        }

        // Function to hide the details modal
        function hideDetailsModal() {
            detailsModalOverlay.classList.remove('show');
        }

        // Function to update the print/download button label and icon
        function updatePrintButtonLabel() {
            if (window.innerWidth <= 767) { // Mobile view
                printDetailsButton.innerHTML = '<i class="fas fa-download"></i> Download';
            } else { // Desktop view
                printDetailsButton.innerHTML = '<i class="fas fa-print"></i> Print';
            }
        }

        // Function to download the modal content as a PNG image
        async function downloadModalAsPng() {
            const modalContent = document.querySelector('.modal-content');
            
            // Temporarily hide elements that should not appear in the screenshot
            const closeButton = modalContent.querySelector('.modal-close-button');
            const printButton = modalContent.querySelector('#printDetailsButton');
            
            // Store original display styles
            const originalCloseButtonDisplay = closeButton.style.display;
            const originalPrintButtonDisplay = printButton.style.display;
            const originalSignatureSectionDisplay = signatureSection.style.display;
            const originalModalNoteDisplay = modalNote.style.display;
            const originalPrintSeparatorDisplay = printSeparator.style.display;

            closeButton.style.display = 'none';
            printButton.style.display = 'none';
            
            // Ensure signature section, note, and separator are visible for the PNG capture
            signatureSection.style.display = 'flex'; 
            modalNote.style.display = 'block';
            printSeparator.style.display = 'block';

            try {
                // Use html2canvas to render the modal content to a canvas
                const canvas = await html2canvas(modalContent, {
                    scale: 2, // Increase scale for better resolution
                    useCORS: true, // Enable cross-origin images if any (though not used here)
                    logging: false // Disable logging for cleaner console
                });

                // Convert canvas to PNG data URL
                const imageUrl = canvas.toDataURL('image/png');

                // Create a temporary link element to trigger the download
                const link = document.createElement('a');
                link.href = imageUrl;
                link.setAttribute('download', 'acknowledgement_slip.png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage("Acknowledgement slip downloaded as PNG.", 'success');

            } catch (error) {
                console.error("Error generating PNG:", error);
                showMessage("Failed to download image. Please try again.", 'error');
            } finally {
                // Restore the hidden elements to their original display states
                closeButton.style.display = originalCloseButtonDisplay;
                printButton.style.display = originalPrintButtonDisplay;
                signatureSection.style.display = originalSignatureSectionDisplay;
                modalNote.style.display = originalModalNoteDisplay;
                printSeparator.style.display = originalPrintSeparatorDisplay;
            }
        }

        // Event listener for details buttons (delegated for dynamic content)
        function addDetailsButtonListeners() {
            document.querySelectorAll('.details-button').forEach(button => {
                button.onclick = (event) => {
                    const srId = event.currentTarget.dataset.srId;
                    const consignmentOrder = event.currentTarget.dataset.consignmentOrder;
                    showDetailsModal(srId, consignmentOrder);
                };
            });
        }

        // Event listeners for modal buttons
        closeModalButton.addEventListener('click', hideDetailsModal);
        
        printDetailsButton.addEventListener('click', () => {
            if (window.innerWidth <= 767) { // Mobile view, download as PNG
                downloadModalAsPng();
            } else { // Desktop view, print
                // Add a class to the body to trigger print-specific styles
                document.body.classList.add('print-active');
                // Temporarily ensure signature section is visible for printing
                const originalSignatureDisplay = signatureSection.style.display;
                signatureSection.style.display = 'flex'; // Ensure it's visible for printing

                // Call the browser's print function
                window.print();
                
                // Remove the class after printing (or immediately after print dialog opens)
                setTimeout(() => {
                    document.body.classList.remove('print-active');
                    signatureSection.style.display = originalSignatureDisplay; // Restore original display
                    hideDetailsModal(); // Close modal after print dialog
                }, 500); // A small delay to allow print dialog to initialize
            }
        });

        // Initial data fetch and button label update when the page loads, wrapped in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            updatePrintButtonLabel(); // Set initial button label
        });

        // Update button label on window resize
        window.addEventListener('resize', updatePrintButtonLabel);
    </script>

</body>
</html>
