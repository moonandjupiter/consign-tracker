<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Status Search</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Existing styles remain the same */
        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* General style for Acknowledge button */
        .acknowledge-button {
            background-color: #dc2626; /* Pure Red for critical status */
            color: white;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            border: none;
            cursor: pointer;
        }

        .acknowledge-button:hover:not([disabled]) {
            background-color: #b91c1c; /* Darker red on hover */
            box-shadow: 0 2px 5px rgba(220, 38, 38, 0.2);
        }

        .acknowledge-button[disabled] {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: #a1a1aa; /* Grey for disabled state */
            color: #e5e7eb; /* Lighter text for disabled state */
        }

        /* Style for the clear button inside the search input */
        .search-clear-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.6;
            font-size: 1rem;
            color: #6b7280;
            padding: 0;
            margin: 0;
            z-index: 102; /* Ensure it's above the search icon */
        }

        .search-clear-button:hover {
            opacity: 1;
            color: #4b5563;
        }

        @media (max-width: 767px) {
            #invoiceTable thead {
                display: none;
            }

            #invoiceTable, #invoiceTable tbody, #invoiceTable tr, #invoiceTable td {
                display: block;
                width: 100%;
            }

            #invoiceTable tr {
                margin-bottom: 15px;
                border: 1px solid #d1d5db;
                border-radius: 0.5rem;
                background-color: #ffffff;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
                overflow: hidden;
            }

            #invoiceTable tbody tr:nth-child(even) {
                background-color: #f9fafb;
            }

            #invoiceTable td {
                border-bottom: 1px solid #e5e7eb;
                position: relative;
                padding: 12px 15px 12px 50%;
                text-align: right;
                font-size: 0.9rem;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }

            #invoiceTable td:last-child {
                border-bottom: 0;
            }

            #invoiceTable td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 45%;
                padding-left: 15px;
                font-weight: 600;
                text-align: left;
                color: #4b5563;
                display: block;
                align-items: initial;
                justify-content: initial;
            }

            #invoiceTable td[data-label="SR ID:"] {
                background-color: #e0f2f7;
                font-weight: 700;
            }

            #invoiceTable td[data-label="Voucher No.:"].highlight-voucher {
                color: #dc2626; /* Changed to red */
                font-weight: 600;
            }

            /* Mobile specific alignment for Status column */
            #invoiceTable td[data-label="Status:"] {
                justify-content: flex-end; /* Align right */
                text-align: right; /* Ensure text alignment is also right */
            }

            .status-button {
                padding: 0.3em 0.6em;
                border-radius: 0.5em;
                font-size: 0.8em;
                border: none;
                white-space: nowrap; /* Prevent text wrapping */
            }

            .status-waiting {
                background-color: #fde047; /* Yellow for waiting */
                color: black; /* Changed font color to black for readability */
                font-weight: normal; /* No longer bold */
            }

            .status-waiting-clickable {
                cursor: pointer;
            }

            .status-processing {
                background-color: #3b82f6; /* Light blue */
                color: white;
                font-weight: bold; /* Keep bold */
            }

            .status-done {
                background-color: #16a34a; /* Light green */
                color: white;
                font-weight: bold; /* Keep bold */
            }

            /* Mobile specific style for Acknowledge button */
            .acknowledge-button {
                font-size: 0.8em; /* Smaller font size */
                padding: 0.3em 0.6em; /* Adjust padding to match status button */
            }

            .mb-6.flex.flex-col.md\:flex-row.gap-4.items-center {
                flex-direction: column;
            }

            .search-reset-container {
                width: 100%;
                margin-bottom: 0; /* No margin as reset button is gone */
                position: relative;
                z-index: 100;
            }

            .export-options {
                width: 100%;
                margin-top: 10px; /* Add some space below the search on mobile */
            }

            .export-options button {
                width: 100%;
            }

            .export-dropdown {
                position: static;
                width: 100%;
                margin-top: 10px;
                box-shadow: none;
                border: 1px solid #d1d5db;
                border-radius: 0.5rem;
            }

            .export-dropdown a {
                padding: 10px;
                text-align: center;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .version-number {
                margin-top: 5px;
                font-size: 0.8rem;
            }

            #quantitySummaryPanel {
                font-size: 0.9rem;
                padding: 10px;
            }

            #consignmentSummaryList {
                margin-top: 5px;
                font-size: 0.85rem;
                list-style: disc;
                padding-left: 20px;
            }

            #consignmentSummaryList li {
                margin-bottom: 3px;
            }

            #suggestionsList {
                position: absolute;
                width: 100%;
                margin-top: 0;
                border-radius: 0.5rem;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
                z-index: 99;
                background-color: white;
                border: 1px solid #d1d5db;
                border-top: none;
                left: 0;
                top: 100%;
                max-height: 150px;
                overflow-y: auto;
            }
            #suggestionsList div {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            #invoiceTable td.empty-table-message {
                text-align: left;
                justify-content: flex-start;
                padding-left: 15px;
                padding-right: 15px;
            }

            #invoiceTable td.empty-table-message::before {
                content: none;
            }

            .search-input-container {
                width: 100%; /* Make search input fill the width on mobile */
                position: relative;
            }

            .search-input-container input {
                padding-left: 45px;
                padding-right: 35px; /* Added space for clear button */
                width: 100%; /* Ensure input fills the container */
            }

            .search-input-container i.fa-search {
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
                pointer-events: none;
                z-index: 101;
            }

            #loadingOverlay {
                justify-content: center;
                padding: 0 1rem;
            }

            .loading-text {
                font-size: 2rem;
                margin-top: 30px;
                white-space: nowrap;
            }

            .version-suffix {
                font-size: 0.7em;
                color: #93c5fd;
                font-weight: 600;
                vertical-align: super;
                margin-left: 0.2em;
            }

            /* START: Mobile Acknowledgement Slip Specific Styles */
            .modal-content {
                padding: 1rem; /* Reduced overall padding */
                max-width: 95%; /* Allow it to take more width on smaller screens */
            }

            .modal-header {
                padding: 1rem 1rem 0.5rem 1rem; /* Adjust header padding */
                margin-bottom: 0.75rem; /* Less margin below header */
            }

            .print-header {
                font-size: 0.7rem; /* Slightly smaller print header font */
                margin-bottom: 0.5rem;
            }

            .print-header p {
                line-height: 1.1;
            }

            .modal-header h2 {
                font-size: 1rem; /* Smaller main title */
                margin-bottom: 0.25rem;
            }

            .modal-body p {
                font-size: 0.8rem; /* Slightly smaller body text */
                margin-bottom: 0.1rem;
                display: block; /* Stack label and value on separate lines */
            }

            .modal-body strong {
                display: block; /* Make labels take full width */
                margin-bottom: 0.1rem; /* Add a little space below the label */
                width: 100%;
                text-align: left;
                font-weight: normal; /* Less emphasis on labels */
            }

            .modal-body span {
                display: block; /* Make values take full width */
                font-weight: 600; /* Keep values bold */
                text-align: left;
            }

            .modal-note {
                font-size: 0.65rem; /* Smaller note text */
                margin-top: 0.5rem;
                line-height: 1.3;
            }

            .signature-block-centered {
                margin-top: 0.5rem;
            }

            .signature-text {
                font-size: 0.6rem;
            }

            .date-line {
                font-size: 0.6rem;
                margin-top: 0.5rem;
            }
            /* END: Mobile Acknowledgement Slip Specific Styles */
        }

        @media (min-width: 768px) {
            #invoiceTable th,
            #invoiceTable td {
                border-bottom: 1px solid #e5e7eb;
                padding: 12px 16px;
                text-align: left;
            }
            #invoiceTable thead th {
                border-bottom-width: 2px;
                border-top: none;
                background-color: #f3f4f6;
                color: #4b5563;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.8rem;
                cursor: pointer;
                padding-right: 25px;
                position: relative;
            }

            #invoiceTable thead th i {
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
                font-size: 0.7em;
                visibility: hidden;
            }

            #invoiceTable thead th.sortable i {
                visibility: visible;
            }

            #invoiceTable td.highlight-voucher {
                color: #dc2626; /* Changed to red */
                font-weight: 600;
            }

            #invoiceTable tbody tr:last-child td {
                border-bottom: none;
            }
            #invoiceTable tbody tr:nth-child(even) {
                background-color: #f9fafb;
            }
            #invoiceTable tbody tr:hover {
                background-color: #eef2ff;
                transition: background-color 0.2s ease-in-out;
            }

            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .version-number {
                font-size: 0.9rem;
            }

            #quantitySummaryPanel {
                font-size: 1rem;
                padding: 1rem;
            }

            #consignmentSummaryList {
                margin-top: 8px;
                font-size: 0.9rem;
                list-style: disc;
                padding-left: 25px;
            }

            #consignmentSummaryList li {
                margin-bottom: 4px;
            }

            #suggestionsList {
                position: absolute;
                width: max-content;
                min-width: 100%;
                max-height: 300px;
                overflow-y: auto;
                background-color: white;
                border: 1px solid #d1d5db;
                border-top: none;
                border-bottom-left-radius: 0.5rem;
                border-bottom-right-radius: 0.5rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 20;
                top: 100%;
                left: 0;
                padding-right: 15px;
            }

            #suggestionsList div {
                padding: 10px 15px;
                cursor: pointer;
                font-size: 0.9rem;
                color: #4b5563;
                white-space: nowrap;
                max-width: none;
            }

            #suggestionsList div:hover {
                background-color: #f3f4f6;
            }

            #invoiceTable td[data-label="Status:"] {
                justify-content: center; /* Center the status button in desktop view */
            }

            .status-button {
                padding: 0.3em 0.6em;
                border-radius: 0.5em;
                font-size: 0.8em;
                border: none;
                white-space: nowrap; /* Prevent text wrapping */
            }

            .status-waiting {
                background-color: #fde047; /* Yellow for waiting */
                color: black; /* Changed font color to black for readability */
                font-weight: normal; /* No longer bold */
            }

            .status-waiting-clickable {
                cursor: pointer; /* Explicitly make it clickable */
            }

            .status-processing {
                background-color: #3b82f6; /* Light blue */
                color: white;
                font-weight: bold; /* Keep bold */
            }

            .status-done {
                background-color: #16a34a; /* Light green */
                color: white;
                font-weight: bold; /* Keep bold */
            }

            /* Desktop specific style for Acknowledge button */
            .acknowledge-button {
                font-size: 0.8em; /* Smaller font size */
                padding: 0.3em 0.6em; /* Adjust padding to match status button */
                white-space: nowrap; /* Prevent text from wrapping */
            }

            .mb-6.flex.flex-col.md\:flex-row.gap-4.items-center {
                flex-direction: row;
                align-items: center;
            }

            .search-reset-container {
                width: auto;
                margin-bottom: 0;
                position: relative;
                flex-grow: 1;
            }

            .export-options {
                width: auto;
            }

            .export-options button {
                width: auto;
            }

            .export-dropdown {
                position: absolute;
                width: 150px;
                margin-top: 2px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                border: 1px solid #d1d5db;
                border-radius: 0.5rem;
            }

            .search-input-container input {
                padding-right: 35px; /* Added space for clear button */
                /* ADDED THIS LINE TO INCREASE LEFT PADDING ON DESKTOP */
                padding-left: 45px;
            }
        }

        button {
            transition: all 0.15s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button i {
            margin-right: 8px;
        }

        #exportButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-input-container {
            position: relative;
            flex-grow: 1;
            overflow: visible;
        }

        .search-input-container i.fa-search {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
            z-index: 1;
        }

        .header {
            background-color: #1d4ed8;
            color: white;
            padding: 1.5rem;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .header-content {
            display: flex;
        }

        .version-number {
            color: #93c5fd;
            font-weight: 400;
        }

        .summary-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-icon {
            font-size: 1.5rem;
            color: #1e3a8a;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1d4ed8;
            background-image: radial-gradient(circle at center, #1d4ed8 0%, #1e40af 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.5s ease-out;
        }

        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 40px;
            animation: fadeInOut 5s infinite alternate;
            padding: 0 1rem;
            white-space: nowrap;
        }

        .version-suffix {
            font-size: 1.5rem;
            color: #93c5fd;
            font-weight: 600;
            vertical-align: super;
            margin-left: 0.2em;
        }

        .loading-dots-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .loading-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #93c5fd;
            animation: bounce 1.4s infinite ease-in-out;
        }

        /* Specific colors for each dot */
        .loading-dot:nth-child(1) { background-color: #4285F4; }
        .loading-dot:nth-child(2) { background-color: #EA4335; animation-delay: 0.1s; }
        .loading-dot:nth-child(3) { background-color: #FBBC05; animation-delay: 0.2s; }
        .loading-dot:nth-child(4) { background-color: #34A853; animation-delay: 0.3s; }


        /* Keyframe Animations */
        @keyframes fadeInOut {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        /* New CSS for loading dots in message box */
        .loading-message-dots {
            display: inline-block;
            margin-left: 8px;
        }

        .loading-message-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
            margin: 0 2px;
            animation: pulse 1.4s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Styles for the Details Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white; /* Pure white background */
            background-image: none; /* Removed gradient */
            padding: 1.5rem; /* Reduced padding for a more compact receipt feel */
            border-radius: 0.25rem; /* Minimal border-radius for sharp edges like a receipt */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* Lighter, less spread shadow */
            width: 90%;
            max-width: 380px; /* Narrower for receipt-like feel */
            transform: translateY(-10px) scale(0.99); /* Subtle animation */
            transition: transform 0.2s ease-out; /* Quicker animation */
            position: relative;
            color: #1f2937; /* Dark gray for main text, good for print */
            border: 1px solid #e5e7eb; /* Subtle light gray border */

            /* Added for button positioning */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Distributes space between items, pushing footer to bottom */
            min-height: 250px; /* Ensure enough height for space-between to work */
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0) scale(1);
        }

        /* Specific styles for the new message modal */
        #messageModalOverlay .modal-content {
            min-height: unset; /* Remove min-height for simpler message modal */
            max-width: 350px; /* Slightly smaller for message */
            padding: 1.25rem;
        }

        #messageModalOverlay .modal-header {
            padding: 0.75rem 1.25rem 0.75rem 1.25rem; /* Added top and right padding for better X button placement */
            margin-bottom: 1rem;
            display: flex; /* Ensure flex for icon and title */
            flex-direction: row; /* Explicitly set to row */
            align-items: center; /* Vertically align icon and title */
            gap: 0.5rem; /* Space between icon and title */
            position: relative; /* Crucial for positioning the close button */
        }

        #messageModalOverlay .modal-header h2 {
            font-size: 1.1rem; /* Slightly smaller title for message modal */
            font-weight: 700; /* Made bolder */
            margin-bottom: 0;
            color: #1f2937; /* Darker text */
            flex-grow: 1; /* Allow h2 to grow and take available space */
            /* Removed white-space, overflow, and text-overflow to allow wrapping */
        }

        #messageModalOverlay .modal-header i.fas {
            font-size: 1.2rem; /* Size for the icon */
            color: #3b82f6; /* Blue color for info icon */
            margin-right: 0.25rem; /* Add a small margin to the right of the icon */
        }

        /* Positioning for the close button in the message modal */
        #messageModalOverlay .modal-close-button {
            position: absolute;
            top: 0.5rem; /* Adjusted to be within the new padding */
            right: 0.5rem; /* Adjusted to be within the new padding */
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
            padding: 0.25rem;
        }

        #messageModalOverlay .modal-close-button:hover {
            color: #dc2626;
            transform: rotate(90deg);
        }


        #messageModalOverlay .modal-body {
            font-size: 0.9rem;
            line-height: 1.5;
            color: #374151;
            flex-grow: unset; /* Don't let it grow */
            padding: 0 0.5rem; /* Add horizontal padding */
        }

        #messageModalOverlay .modal-footer {
            border-top: none; /* No footer border for message modal */
            padding-top: 0;
            margin-top: 1rem;
            justify-content: flex-end; /* Align button to the right */
            align-items: flex-end; /* Align button to the right */
        }

        #messageModalOverlay .modal-footer button {
            background-color: #1d4ed8; /* Blue button for message modal */
            color: white;
            padding: 0.5rem 1rem;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 0.375rem; /* Rounded corners */
        }

        #messageModalOverlay .modal-footer button:hover {
            background-color: #1e40af;
            box-shadow: 0 2px 5px rgba(29, 78, 216, 0.2);
        }


        /* General Modal Header Styles */
        .modal-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            border-bottom: 1px dashed #d1d5db;
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            margin-bottom: 1.25rem;
            position: relative;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            text-shadow: none;
            margin-bottom: 0.5rem;
            text-align: left;
            width: calc(100% - 2.5rem);
        }

        .modal-close-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
            padding: 0.25rem;
        }

        .modal-close-button:hover {
            color: #dc2626;
            transform: rotate(90deg);
        }

        /* Details Modal Body Styles */
        .modal-body {
            flex-grow: 1;
        }

        .modal-body p {
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
            display: flex; /* Keep flex for horizontal layout */
            align-items: baseline;
            padding: 0.1rem 0;
            border-bottom: none;
        }

        .modal-body strong {
            color: #4b5563;
            font-weight: normal;
            flex-shrink: 0;
            margin-right: 0.5rem;
            width: 45%; /* Set a fixed width for the label to create the barrier */
            text-align: left;
        }

        .modal-body span {
            color: #1f2937;
            font-weight: 600;
            text-align: left; /* Align value to the left from the barrier */
            flex-grow: 1; /* Allow value to take remaining space */
            word-wrap: break-word; /* Ensure long words break and wrap */
        }

        /* Details Modal Footer Styles */
        .modal-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            border-top: 1px dashed #d1d5db;
            padding-top: 1.25rem;
            margin-top: 1.5rem;
        }

        .modal-footer button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .modal-print-button {
            background-color: #22c55e;
            color: white;
            border: 1px solid #22c55e;
        }

        .modal-print-button:hover {
            background-color: #16a34a;
            box-shadow: 0 2px 5px rgba(34, 197, 94, 0.2);
        }

        .modal-cancel-button {
            background-color: white;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }

        .modal-cancel-button:hover {
            background-color: #f9fafb;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .modal-note {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: left;
            margin-top: 0.75rem;
            line-height: 1.4;
        }
        /* Print specific styles */
        @media print {
            body.print-active > *:not(.modal-overlay) {
                display: none;
            }
            body.print-active .modal-overlay {
                position: static;
                background-color: transparent;
                display: block;
                width: auto;
                height: auto;
                overflow: visible;
                /* Ensure it's not centered by default */
                justify-content: flex-start;
                align-items: flex-start;
            }
            body.print-active .modal-content {
                width: 100mm; /* Increased width for better size */
                max-width: 100mm; /* Increased max-width */
                box-shadow: none;
                border: none;
                padding: 10mm; /* Increased padding */
                transform: none;
                border-radius: 0;
                margin: 0; /* Reset margin */
                float: left; /* Position to the left */
                margin-left: 10mm; /* Add some margin from the left edge */
                min-height: auto;
            }
            body.print-active .modal-header {
                border-bottom: 1px dashed #d1d5db;
                padding-bottom: 0.5rem;
                margin-bottom: 0.5rem;
                align-items: flex-start; /* Align items to the start (left) */
                text-align: left; /* Ensure text within the header is left-aligned */
                display: flex; /* Use flexbox for alignment control */
                flex-direction: column; /* Stack the header content vertically */
                /* NEW: Remove left/right padding that might be causing the offset */
                padding-left: 0;
                padding-right: 0;
            }
            body.print-active .modal-header h2 {
                font-size: 1.3rem; /* Increased font size */
                margin-bottom: 0;
                font-family: 'Poppins', sans-serif; /* Changed to Poppins for consistency */
                font-weight: 700; /* Made bolder */
                text-align: left;
                width: 100%;
            }
            /* New print header styles */
            body.print-active .print-header {
                font-family: 'Poppins', sans-serif;
                font-size: 0.8rem; /* Adjusted font size for print header */
                margin-bottom: 0.75rem; /* Space below the new header */
                color: #1f2937;
                text-align: left;
                width: 100%;
                display: block; /* Ensure it behaves as a block-level element */
            }
            body.print-active .print-header p {
                margin: 0; /* Remove default paragraph margins */
                line-height: 1.2; /* Adjust line height for compactness */
                text-align: left; /* Ensure text inside <p> is also left-aligned */
            }

            body.print-active .modal-footer {
                border-top: none;
                padding-top: 0;
                margin-top: 0;
                align-items: flex-start;
            }
            body.print-active .modal-close-button,
            body.print-active .modal-footer button {
                display: none;
            }

            body.print-active .modal-body p {
                font-size: 0.9rem; /* Increased font size */
                margin-bottom: 0.1rem;
                padding: 0.1rem 0;
                font-family: 'Poppins', sans-serif;
                /* No change needed here for flex as it's handled by strong/span */
            }
            body.print-active .modal-body strong {
                font-weight: 400;
                margin-right: 0.5rem;
                width: 45%; /* Set a fixed width for the label to create the barrier */
                flex-shrink: 0;
                text-align: left;
                font-family: 'Poppins', sans-serif;
            }
            body.print-active .modal-body span {
                font-weight: 600; /* Increased font weight for values */
                flex-grow: 1;
                text-align: left; /* Align value to the left from the barrier */
                font-family: 'Poppins', sans-serif;
                word-wrap: break-word; /* Ensure long words break and wrap */
            }
            body.print-active .modal-note {
                font-size: 0.7rem; /* Increased font size */
                font-style: normal; /* Changed to normal */
                margin-top: 1rem;
                text-align: left;
                color: #6b7280; /* Darker color for better contrast */
                line-height: 1.4;
            }

            .print-separator {
                display: block;
                width: 100%;
                margin-top: 1.5rem;
                margin-bottom: 1rem;
                border-bottom: 1px dashed #d1d5db;
            }

            .signature-section {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
                margin-top: 0;
                padding-top: 0;
                border-top: none;
                font-family: 'Poppins', sans-serif;
                color: #1f2937;
            }

            .signature-block-centered {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
                margin: 0;
                margin-top: 0.75rem;
            }

            .signature-line {
                border-bottom: 1px solid #a1a1aa;
                width: 75%;
                margin-bottom: 0.15rem;
            }

            .signature-text {
                font-size: 0.75rem; /* Increased font size */
                color: #4b5563;
                text-align: left;
                width: 75%;
                margin-top: 0;
                line-height: 1.1;
            }

            .date-line {
                margin-top: 0.75rem;
                font-size: 0.75rem; /* Increased font size */
                color: #4b5563;
                width: 100%;
                text-align: left;
            }
        }

        .signature-section {
            display: none;
        }

        /* Table specific loading overlay */
        .table-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7); /* Semi-transparent white overlay */
            z-index: 50; /* Above the table content */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease-out; /* Smooth fade in/out */
        }

        .table-loading-overlay.hidden {
            opacity: 0;
            pointer-events: none; /* Allow clicks through when hidden */
        }

        .table-loading-overlay .loading-dots-container {
            position: relative; /* For absolute positioning of dots */
            width: 80px; /* Size of the spinner area */
            height: 80px; /* Size of the spinner area */
        }

        .table-loading-overlay .loading-dot {
            position: absolute;
            width: 18px; /* Slightly larger dot */
            height: 18px; /* Slightly larger dot */
            border-radius: 50%;
            background-color: #e0e0e0; /* Lighter grey for unlit */
            opacity: 0.3; /* Start with lower opacity */
            animation: sequential-fill 1s infinite ease-in-out; /* Main animation */
        }

        /* Positioning for 8 dots in a circle */
        .table-loading-overlay .loading-dot:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); }
        .table-loading-overlay .loading-dot:nth-child(2) { top: 14.64%; right: 14.64%; transform: translate(50%, -50%); }
        .table-loading-overlay .loading-dot:nth-child(3) { top: 50%; right: 0; transform: translateY(-50%); }
        .table-loading-overlay .loading-dot:nth-child(4) { bottom: 14.64%; right: 14.64%; transform: translate(50%, 50%); }
        .table-loading-overlay .loading-dot:nth-child(5) { bottom: 0; left: 50%; transform: translateX(-50%); }
        .table-loading-overlay .loading-dot:nth-child(6) { bottom: 14.64%; left: 14.64%; transform: translate(-50%, 50%); }
        .table-loading-overlay .loading-dot:nth-child(7) { top: 50%; left: 0; transform: translateY(-50%); }
        .table-loading-overlay .loading-dot:nth-child(8) { top: 14.64%; left: 14.64%; transform: translate(-50%, -50%); }

        /* Animation delays for sequential effect */
        .table-loading-overlay .loading-dot:nth-child(1) { animation-delay: 0s; }
        .table-loading-overlay .loading-dot:nth-child(2) { animation-delay: 0.125s; } /* 1s / 8 dots = 0.125s per dot */
        .table-loading-overlay .loading-dot:nth-child(3) { animation-delay: 0.25s; }
        .table-loading-overlay .loading-dot:nth-child(4) { animation-delay: 0.375s; }
        .table-loading-overlay .loading-dot:nth-child(5) { animation-delay: 0.5s; }
        .table-loading-overlay .loading-dot:nth-child(6) { animation-delay: 0.625s; }
        .table-loading-overlay .loading-dot:nth-child(7) { animation-delay: 0.75s; }
        .table-loading-overlay .loading-dot:nth-child(8) { animation-delay: 0.875s; }

        @keyframes sequential-fill {
            0%, 100% {
                opacity: 0.3;
                background-color: #e0e0e0; /* Lighter grey for unlit */
                transform: scale(0.8); /* Slightly smaller when unlit */
            }
            50% {
                opacity: 1;
                background-color: #1d4ed8; /* Main blue when lit */
                transform: scale(1.2); /* Slightly larger when lit */
            }
        }

        /* Ensure tableContainer is relative for absolute positioning of overlay */
        #tableContainer {
            position: relative;
            min-height: 150px; /* Ensure there's space for the spinner */
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="loading-dots-container">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
        <h1 class="loading-text">ConsignTracker <span class="version-suffix">v2</span></h1>
    </div>

    <div id="mainContent" class="hidden">
        <div class="container mx-auto max-w-screen-lg bg-white rounded-xl shadow-2xl border border-gray-200 mt-10 mb-10">
            <div class="header">
                <div class="header-content">
                    <div>
                        <h1 class="text-3xl font-bold">ConsignTracker</h1>
                        <p class="text-blue-200 mt-1 text-sm">Smart lookup for consignors: reported sales, invoices, and vouchers at a glance.</p>
                    </div>
                    <div class="version-number">Version: 2.0 build 6</div>
                </div>
            </div>

            <div class="p-6">
                <div class="mb-6 flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-grow search-reset-container">
                        <div class="search-input-container">
                            <input type="text" id="searchInput" placeholder="Search by, Consignment Order Number, SR ID, or Invoice No."
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent text-gray-700 shadow-sm">
                            <i class="fas fa-search"></i>
                            <button id="clearSearchButton" class="search-clear-button hidden" title="Clear search">
                                <i class="fas fa-times-circle"></i>
                            </button>
                            <div id="suggestionsList" class="hidden"></div>
                        </div>
                    </div>

                    <div class="export-options relative hidden"> <button id="exportButton" disabled
                                                                        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50 transition duration-150 ease-in-out shadow-sm">
                                <i class="fas fa-download"></i> Export <i class="fas fa-caret-down ml-2"></i>
                            </button>
                            <div id="exportDropdown" class="export-dropdown hidden absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-xl z-10">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="csv">Export as CSV</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="html" id="exportHtmlOption">Export as HTML</a>
                            </div>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-2">Type your SR ID, Consignment Order #, or Invoice # to search. Select a suggestion or press Enter.</p>
                <div id="quantitySummaryPanel" class="mt-4 p-4 bg-blue-100 border border-blue-200 rounded-lg text-blue-800 font-semibold hidden">
                    <div class="summary-content">
                        <i class="fas fa-info-circle summary-icon"></i> <div id="overallSummary"></div>
                    </div>
                    <ul id="consignmentSummaryList" class="mt-2 text-sm font-normal">
                    </ul>
                </div>

                <div id="messageBox" class="mt-4 p-4 rounded-md hidden"></div> <div id="tableContainer" class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm mt-4 px-4 py-4">
                    <table id="invoiceTable" class="min-w-full bg-white">
                        <thead class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left" data-sort="SR ID">SR ID</th>
                                <th class="py-3 px-6 text-left" data-sort="Name of Company">Name of Company</th>
                                <th class="py-3 px-6 text-left sortable" data-sort="Consignment Order Number">C.O. Number <i class="fas fa-sort"></i></th>
                                <th class="py-3 px-6 text-left" data-sort="Quantity Sold">Quantity Sold</th>
                                <th class="py-3 px-6 text-left" data-sort="Amount">Amount</th>
                                <th class="py-3 px-6 text-left" data-sort="Invoice No.">Invoice No.</th>
                                <th class="py-3 px-6 text-left" data-sort="Voucher No.">Voucher No.</th>
                                <th class="py-3 px-6 text-left" data-sort="Voucher Date">Voucher Date</th>
                                <th class="py-3 px-6 text-left" data-sort="Status">Status</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody" class="text-gray-700 text-sm font-light">
                            <tr>
                                <td colspan="9" class="text-center py-4 text-gray-500 empty-table-message">Enter a search term and press Enter or select a suggestion.</td>
                            </tr>
                        </tbody>
                    </table>
                    <div id="tableLoadingOverlay" class="table-loading-overlay hidden">
                        <div class="loading-dots-container">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                </div>

                <div id="paginationContainer" class="mt-6 flex flex-col md:flex-row justify-between items-center">
                    <div class="flex gap-4 mb-4 md:mb-0">
                        <button id="prevPageButton"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out shadow-sm">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button id="nextPageButton"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out shadow-sm">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <span id="pageInfo" class="text-gray-700 text-sm"></span>
                </div>

            </div>
        </div>
    </div>

    <div id="detailsModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="print-header">
                    <p>Philippine General Hospital</p>
                    <p>The National University Hospital</p>
                    <p>University of Philippines - Manila</p>
                </div>
                <h2>Sales Report Acknowledgement Slip</h2> <button class="modal-close-button" id="closeModalButton">&times;</button>
            </div>
            <div class="modal-body" id="modalDetailsBody">
            </div>
            <div class="modal-footer">
                <button class="modal-print-button" id="printDetailsButton"></button>

                <div class="print-separator"></div>

                <div class="signature-section">
                    <div class="signature-block-centered">
                        <div class="signature-line"></div>
                        <p class="signature-text">Signature over Printed Name</p>
                    </div>
                    <p class="date-line">Date: _______________</p>
                </div>
                <p class="modal-note">
                    <strong>Note to Supplier:</strong> Please attach this form to your sales invoice upon submission. Failure to attach may result in delays in verifying and processing your invoice.
                </p>
            </div>
        </div>
    </div>

    <div id="messageModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fas fa-info-circle"></i><h2 id="messageModalTitle"></h2>
                <button class="modal-close-button" id="closeMessageModalButton">&times;</button>
            </div>
            <div class="modal-body" id="messageModalBody">
            </div>
            <div class="modal-footer">
                <button id="messageModalOkButton">OK</button>
            </div>
        </div>
    </div>

<script>
        const jsonUrl = "https://raw.githubusercontent.com/moonandjupiter/my-json-data/refs/heads/main/Sheet1_data.json";
        const itemsPerPage = 5;
        let currentPage = 1;
        let allData = []; // Raw data from JSON
        let processedData = []; // Merged/processed data
        let filteredData = []; // Filtered subset of processedData
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        let lastClickedConsignmentOrder = null; // New global variable to store the consignment order of the last clicked button

        const searchInput = document.getElementById('searchInput');
        const clearSearchButton = document.getElementById('clearSearchButton'); // New clear button
        const exportButton = document.getElementById('exportButton');
        const exportDropdown = document.getElementById('exportDropdown');
        const exportHtmlOption = document.getElementById('exportHtmlOption');
        const invoiceTableBody = document.getElementById('invoiceTableBody');
        const prevPageButton = document.getElementById('prevPageButton');
        const nextPageButton = document.getElementById('nextPageButton');
        const pageInfoSpan = document.getElementById('pageInfo');
        const messageBox = document.getElementById('messageBox'); // This is the old message box, now used for general info/errors
        const quantitySummaryPanel = document.getElementById('quantitySummaryPanel');
        const overallSummaryDiv = document.getElementById('overallSummary');
        const consignmentSummaryList = document.getElementById('consignmentSummaryList');
        const suggestionsList = document.getElementById('suggestionsList');
        const sortableTableHeaders = document.querySelectorAll('#invoiceTable th.sortable');
        const tableContainer = document.getElementById('tableContainer');
        const paginationContainer = document.getElementById('paginationContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainContent = document.getElementById('mainContent');
        const exportOptionsDiv = document.querySelector('.export-options'); // Get the export options div

        // NEW: Table specific loading overlay element
        const tableLoadingOverlay = document.getElementById('tableLoadingOverlay');

        // Modal elements
        const detailsModalOverlay = document.getElementById('detailsModalOverlay');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalDetailsBody = document.getElementById('modalDetailsBody');
        const printDetailsButton = document.getElementById('printDetailsButton');
        const signatureSection = document.querySelector('.signature-section');
        const modalNote = document.querySelector('.modal-note');
        const printSeparator = document.querySelector('.print-separator');

        // New Message Modal elements
        const messageModalOverlay = document.getElementById('messageModalOverlay');
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalBody = document.getElementById('messageModalBody');
        const closeMessageModalButton = document.getElementById('closeMessageModalButton');
        const messageModalOkButton = document.getElementById('messageModalOkButton');

        // This Set will store consignment order numbers that have been "acknowledged" in the current session
        const acknowledgedConsignments = new Set();

        // Function to show messages (for the general message box at the bottom)
        function showMessage(message, type = 'info') {
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-center');
            messageBox.innerHTML = '';

            // MODIFIED: Simplified message for table loading, removed inline dots
            if (message === "Retrieving consignments..." && type === 'info') {
                messageBox.classList.add('bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-content-center');
                messageBox.textContent = "Retrieving consignments..."; // Updated message
            } else {
                messageBox.classList.add('mt-4', 'p-4', 'rounded-md');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                } else {
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                }
                messageBox.textContent = message;
            }
            messageBox.classList.remove('hidden');
        }

        // Function to hide messages (for the general message box at the bottom)
        function hideMessageBox() {
            messageBox.classList.add('hidden');
            messageBox.innerHTML = '';
            messageBox.classList.remove('bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-content-center');
        }

        // Function to show the new message modal
        function showInfoModal(title, message) {
            console.log('Attempting to show info modal...');
            messageModalTitle.textContent = title;
            messageModalBody.textContent = message;
            // Directly set display properties
            messageModalOverlay.style.display = 'flex';
            messageModalOverlay.style.opacity = '1';
            messageModalOverlay.style.visibility = 'visible';
            console.log('Modal display properties set: display=flex, opacity=1, visibility=visible');
        }

        // Function to hide the new message modal
        function hideInfoModal() {
            console.log('Attempting to hide info modal...');
            // Directly set display properties to hide
            messageModalOverlay.style.opacity = '0';
            messageModalOverlay.style.visibility = 'hidden';
            // Use a slight delay before setting display to 'none' to allow transition (if any)
            setTimeout(() => {
                messageModalOverlay.style.display = 'none';
                console.log('Modal display properties reset: display=none, opacity=0, visibility=hidden');
            }, 300); // Match this with your CSS transition duration if you re-enable it
        }

        // Function to calculate and display the total quantity of the filtered data and per consignment
        function calculateAndDisplaySummary() {
            const totalResults = filteredData.length;
            const resultWord = totalResults === 1 ? 'result' : 'results';
            overallSummaryDiv.textContent = `Found ${totalResults} ${resultWord}:`;

            const consignmentTotals = filteredData.reduce((acc, item) => {
                const consignmentNumber = String(item['Consignment Order Number'] || 'N/A');
                const quantity = parseInt(item['Quantity Sold'], 10);
                const amount = parseFloat(String(item['Amount'] || '0').replace(/[^0-9.-]+/g,"")) || 0;

                if (!acc[consignmentNumber]) {
                    acc[consignmentNumber] = {
                        consignmentOrder: consignmentNumber,
                        quantity: 0,
                        amount: 0
                    };
                }

                if (!isNaN(quantity)) {
                    acc[consignmentNumber].quantity += quantity;
                }
                if (!isNaN(amount)) {
                    acc[consignmentNumber].amount += amount;
                }
                return acc;
            }, {});

            consignmentSummaryList.innerHTML = '';

            if (Object.keys(consignmentTotals).length > 0) {
                const sortedConsignments = Object.entries(consignmentTotals).sort(([keyA, valA], [keyB, valB]) => {
                    return String(valA.consignmentOrder).localeCompare(String(valB.consignmentOrder));
                });

                sortedConsignments.forEach(([compositeKey, totals]) => {
                    const formattedQuantity = totals.quantity.toLocaleString();
                    const formattedAmount = totals.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const pcWord = totals.quantity === 1 ? 'pc' : 'pcs';
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `CO Number ${totals.consignmentOrder} : <span class="font-bold text-blue-700">${formattedQuantity} ${pcWord}</span>, Total Amount <span class="font-bold text-blue-700">${formattedAmount}</span> reported sold.`;
                    consignmentSummaryList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'No consignment breakdown available.';
                consignmentSummaryList.appendChild(listItem);
            }

            if (searchInput.value.trim() !== '' && filteredData.length > 0) {
                quantitySummaryPanel.classList.remove('hidden');
            } else {
                quantitySummaryPanel.classList.add('hidden');
            }
        }

        // Function to update pagination button states and info
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            pageInfoSpan.textContent = filteredData.length === 0 ? 'No data' : `Page ${currentPage} of ${totalPages}`;

            prevPageButton.disabled = currentPage === 1 || filteredData.length === 0;
            nextPageButton.disabled = currentPage >= totalPages || filteredData.length === 0;
        }

        // Function to update sort icons in table headers
        function updateSortIcons() {
            sortableTableHeaders.forEach(header => {
                const sortColumn = header.getAttribute('data-sort');
                const icon = header.querySelector('i');
                if (icon) {
                    if (filteredData.length === 0) {
                        icon.style.visibility = 'hidden';
                        header.classList.remove('sorted-asc', 'sorted-desc');
                    } else {
                        icon.style.visibility = 'visible';
                        icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down');
                        if (sortColumn === currentSortColumn) {
                            icon.classList.add(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                            header.classList.add(currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                        } else {
                            icon.classList.add('fa-sort');
                            header.classList.remove('sorted-asc', 'sorted-desc');
                        }
                    }
                }
            });
        }

        // Function to sort data
        function sortData(column) {
            if (filteredData.length === 0) {
                return;
            }

            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            filteredData.sort((a, b) => {
                const valueA = a[column] || '';
                const valueB = b[column] || '';

                // Handle numeric sorting for Quantity Sold and Amount
                if (column === 'Quantity Sold' || column === 'Amount') {
                    const numA = parseFloat(String(valueA).replace(/[^0-9.-]+/g,"")) || 0;
                    const numB = parseFloat(String(valueB).replace(/[^0-9.-]+/g,"")) || 0;
                    if (numA < numB) {
                        return currentSortDirection === 'asc' ? -1 : 1;
                    }
                    if (numA > numB) {
                        return currentSortDirection === 'asc' ? 1 : -1;
                    }
                    return 0;
                }
                // Default to string comparison for other columns
                if (valueA < valueB) {
                    return currentSortDirection === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return currentSortDirection === 'asc' ? 1 : -1;
                }
                    return 0;
            });

            currentPage = 1;
            renderTable();
            calculateAndDisplaySummary();
        }

        // Function to determine the status and return appropriate HTML
        function getStatusHtml(item) {
            const invoiceNo = String(item['Invoice No.'] || '').trim();
            const voucherNo = String(item['Voucher No.'] || '').trim();

            let statusText = '';
            let statusClass = '';
            let clickableClass = ''; // New variable for clickable class

            if (invoiceNo === '' || invoiceNo === '-') {
                statusText = 'Waiting for Invoice';
                statusClass = 'status-waiting';
                clickableClass = 'status-waiting-clickable'; // Add specific class for click event
            } else if (voucherNo === '' || voucherNo === '-' || voucherNo === '0') {
                statusText = 'Processing Voucher';
                statusClass = 'status-processing';
            } else {
                statusText = 'Complete'; // Changed "Done" to "Complete"
                statusClass = 'status-done';
            }

            return `<span class="status-button ${statusClass} ${clickableClass}">${statusText}</span>`;
        }


        // Function to render the table for the current page
        function renderTable() {
            invoiceTableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const dataToDisplay = filteredData.slice(startIndex, endIndex);

            if (filteredData.length === 0) {
                const message = searchInput.value.trim() === '' ? 'Enter a search term and press Enter or select a suggestion.' : 'No data found for your search.';
                invoiceTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500 empty-table-message">${message}</td></tr>`;

                // Hide export options when no data
                exportOptionsDiv.classList.add('hidden');

            } else {
                dataToDisplay.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';

                    const invoiceNo = item['Invoice No.'] || '';
                    let invoiceNoCellContent = invoiceNo;

                    const consignmentOrderNumber = String(item['Consignment Order Number'] || 'N/A');
                    const isAcknowledged = acknowledgedConsignments.has(consignmentOrderNumber);

                    // Check if Invoice No. is blank or dash AND if it's not already acknowledged
                    if ((invoiceNo.trim() === '' || invoiceNo.trim() === '-') && !isAcknowledged) {
                        invoiceNoCellContent = `
                            <button class="acknowledge-button py-1 px-2 focus:outline-none focus:shadow-outline"
                                data-sr-id="${item['SR ID'] || ''}"
                                data-consignment-order="${item['Consignment Order Number'] || ''}">
                                Click here
                            </button>
                        `;
                    } else if (isAcknowledged) {
                        // If it's already acknowledged, display the acknowledged state
                        invoiceNoCellContent = `
                            <button class="acknowledge-button bg-green-200 text-green-800 font-normal py-1 px-2 rounded cursor-not-allowed" disabled>
                                <i class="fas fa-check mr-1"></i> Acknowledged
                            </button>
                        `;
                    }
                    // If invoiceNo is not blank/dash and not acknowledged, it will just display invoiceNo as is.

                    // Determine if voucher number exists to apply highlight class
                    const voucherValue = String(item['Voucher No.'] || '').trim();
                    const hasValidVoucher = voucherValue !== '' && voucherValue !== '0' && voucherValue !== '-';
                    const voucherClass = hasValidVoucher ? 'highlight-voucher' : '';

                    // Get status HTML
                    const statusHtml = getStatusHtml(item);

                    // Format Quantity Sold
                    const quantitySold = item['Quantity Sold'] ? parseInt(item['Quantity Sold'], 10).toLocaleString() : '';

                    // Format Amount
                    const amount = item['Amount'] ? parseFloat(String(item['Amount']).replace(/[^0-9.-]+/g,"")).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';


                    row.innerHTML = `
                        <td data-label="SR ID:" class="px-6 py-3">${item['SR ID'] || ''}</td>
                        <td data-label="Company:" class="px-6 py-3">${item['Name of Company'] || ''}</td>
                        <td data-label="C.O. Number:" class="px-6 py-3">${item['Consignment Order Number'] || ''}</td>
                        <td data-label="Quantity:" class="px-6 py-3">${quantitySold}</td>
                        <td data-label="Amount:" class="px-6 py-3">${amount}</td>
                        <td data-label="Invoice No.:" class="px-6 py-3">${invoiceNoCellContent}</td>
                        <td data-label="Voucher No.:" class="px-6 py-3 ${voucherClass}">${item['Voucher No.'] || ''}</td>
                        <td data-label="Voucher Date:" class="px-6 py-3">${item['Voucher Date'] || ''}</td>
                        <td data-label="Status:" class="px-6 py-3">${statusHtml}</td>
                    `;
                    invoiceTableBody.appendChild(row);
                });

                // Show export options when data is present
                exportOptionsDiv.classList.remove('hidden');
            }

            // Ensure table and pagination containers are always visible
            tableContainer.style.display = 'block';
            paginationContainer.style.display = 'flex';

            updatePaginationControls();
            exportButton.disabled = filteredData.length === 0;
            updateSortIcons();
            addAcknowledgeButtonListeners(); // New listener for the buttons
            // Removed addStatusButtonListeners() call from here, as it's now handled by delegation
        }

        // New function to merge data
        function mergeData(data) {
            const mergedMap = new Map();

            data.forEach(item => {
                const srId = item['SR ID'] || '';
                const consignmentOrderNumber = item['Consignment Order Number'] || '';
                const key = `${srId}-${consignmentOrderNumber}`; // Unique key for merging

                const quantity = parseInt(item['Quantity Sold'], 10) || 0;
                const amount = parseFloat(String(item['Amount'] || '0').replace(/[^0-9.-]+/g,"")) || 0;

                if (mergedMap.has(key)) {
                    const existing = mergedMap.get(key);
                    existing['Quantity Sold'] += quantity;
                    existing['Amount'] += amount;
                    // For other fields, we primarily want the first encountered value or a representative one.
                    // For 'Invoice No.', 'Voucher No.', 'Voucher Date', we'll keep the first one encountered.
                    // This is acceptable because the merging is primarily for quantity/amount.
                } else {
                    // Create a copy to avoid modifying the original data directly
                    const newItem = { ...item };
                    newItem['Quantity Sold'] = quantity; // Ensure it's a number
                    newItem['Amount'] = amount; // Ensure it's a number
                    mergedMap.set(key, newItem);
                }
            });

            return Array.from(mergedMap.values());
        }

        // Function to fetch data from the JSON URL
        async function fetchData() {
            // Show loading overlay immediately
            loadingOverlay.classList.remove('hidden');
            mainContent.classList.add('hidden');
            console.log('Loading overlay shown, main content hidden.');

            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allData = await response.json(); // Store raw data
                processedData = mergeData(allData); // Process and merge data
                filteredData = []; // Initialize filteredData as empty on initial load
                hideMessageBox();
                quantitySummaryPanel.classList.add('hidden');

                console.log('Data fetched and processed successfully. Rendering table...');
                renderTable(); // Render table with initial empty filteredData

                // ONLY on successful fetch, apply the 5-second delay
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    console.log('Loading overlay hidden and main content shown after successful fetch (5000ms delay).');
                }, 5000);

            } catch (error) {
                console.error("Error fetching data:", error);
                showMessage(`Failed to load data: ${error.message}`, 'error');
                invoiceTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-red-500 empty-table-message">Error loading data.</td></tr>'; // Changed colspan to 9
                quantitySummaryPanel.classList.add('hidden');

                // On error, hide loading overlay quickly
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    console.log('Loading overlay hidden and main content shown after error (500ms delay).');
                }, 500);
            }
        }

        // Function to perform the search
        // Accepts an optional searchValue to filter by a specific key value (used for suggestion clicks)
        function performSearch(searchValue = null) {
            console.log("performSearch called. Search term (raw):", searchInput.value);
            console.log("Processed Data Length:", processedData.length);

            hideMessageBox();
            // MODIFIED: Simpler message for table loading
            showMessage("Retrieving consignments...", 'info');
            tableContainer.style.display = 'block';
            paginationContainer.style.display = 'flex';
            quantitySummaryPanel.classList.add('hidden');

            setTimeout(() => {
                // Clear the table body here before rendering new results
                invoiceTableBody.innerHTML = '';
                tableLoadingOverlay.classList.add('hidden'); // Remove loading class from table

                let searchTerm;
                if (searchValue !== null) {
                    searchTerm = String(searchValue).toLowerCase();
                    console.log("Searching by suggestion value (Consignment Order Number):", searchTerm);
                    // When a suggestion is clicked, we specifically search by consignment order number
                    filteredData = processedData.filter(item => {
                        const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                        return consignmentOrderNumber === searchTerm;
                    });
                } else {
                    searchTerm = searchInput.value.toLowerCase();
                    console.log("Searching by typed input:", searchTerm);
                    if (searchTerm) {
                        // Filter for partial matches across SR ID, Consignment Order Number, or Invoice No.
                        filteredData = processedData.filter(item => {
                            const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                            const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                            const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';

                            const match = srId.includes(searchTerm) ||
                                          consignmentOrderNumber.includes(searchTerm) ||
                                          invoiceNo.includes(searchTerm);
                            // console.log(`Item: ${item['SR ID']}, CO: ${item['Consignment Order Number']}, Invoice: ${item['Invoice No.']} -> Match: ${match}`); // Detailed debug log
                            return match;
                        });
                    } else {
                        filteredData = []; // If no search term, keep filtered data empty
                    }
                }

                console.log("Filtered Data Length after search:", filteredData.length);
                currentPage = 1;
                calculateAndDisplaySummary();
                renderTable();
                hideMessageBox();

                if (filteredData.length === 0 && searchInput.value.trim() !== '') {
                    showMessage("No matching results found.", 'info');
                }
            }, 1500);
        }

        // Optional: Allow pressing Enter in the search field to trigger search
        searchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                performSearch();
                suggestionsList.classList.add('hidden');
            }
        });

        // Event listener for input changes in the search field for suggestions and clear button
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            suggestionsList.innerHTML = '';

            // Toggle clear button visibility
            if (searchInput.value.length > 0) {
                clearSearchButton.classList.remove('hidden');
            } else {
                clearSearchButton.classList.add('hidden');
            }

            if (searchTerm.length > 2 && processedData.length > 0) { // Use processedData for suggestions
                const matchedItems = new Map();

                processedData.forEach(item => {
                    const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                    const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']) : 'N/A';
                    const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';
                    const companyName = item['Name of Company'] ? String(item['Name of Company']) : 'Unknown Company';

                    if (srId.includes(searchTerm) || consignmentOrderNumber.toLowerCase().includes(searchTerm) || invoiceNo.includes(searchTerm)) {
                        const suggestionValue = consignmentOrderNumber;
                        const suggestionKey = suggestionValue;

                        if (suggestionValue !== 'N/A' && !matchedItems.has(suggestionKey)) {
                            matchedItems.set(suggestionKey, {
                                display: `${companyName} – ${consignmentOrderNumber}`,
                                value: suggestionValue
                            });
                        }
                    }
                });

                if (matchedItems.size > 0) {
                    const sortedSuggestions = Array.from(matchedItems.values()).sort((a, b) => a.display.localeCompare(b.display));

                    sortedSuggestions.forEach(suggestion => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.textContent = suggestion.display;
                        suggestionItem.setAttribute('data-value', suggestion.value);
                        suggestionItem.classList.add('px-4', 'py-2', 'cursor-pointer', 'hover:bg-gray-100', 'text-gray-700');
                        suggestionItem.addEventListener('click', (event) => { // Added event parameter
                            event.stopPropagation(); // Stop propagation for suggestion click
                            searchInput.value = suggestion.display;
                            suggestionsList.classList.add('hidden');
                            tableLoadingOverlay.classList.remove('hidden'); // Add loading class to table overlay
                            performSearch(suggestion.value);
                        });
                        suggestionsList.appendChild(suggestionItem);
                    });
                    suggestionsList.classList.remove('hidden');
                } else {
                    suggestionsList.classList.add('hidden');
                }
            } else {
                suggestionsList.classList.add('hidden');
            }
            // Ensure message box is hidden when suggestions appear
            hideMessageBox();
        });

        // Event listener for the clear search button
        clearSearchButton.addEventListener('click', () => {
            searchInput.value = '';
            clearSearchButton.classList.add('hidden'); // Hide clear button after clearing
            hideMessageBox();
            suggestionsList.classList.add('hidden');
            suggestionsList.innerHTML = '';
        });

        // Hide the dropdown if the user clicks outside of it
        window.addEventListener('click', (event) => {
            // Check if the click is outside the export button, dropdown, search input, suggestions list, and message modal
            const isClickOutsideExport = !exportButton.contains(event.target) && !exportDropdown.contains(event.target);
            const isClickOutsideSearch = !searchInput.contains(event.target) && !suggestionsList.contains(event.target) && !clearSearchButton.contains(event.target);
            // Check if the modal is currently displayed before trying to hide it
            const isClickOutsideMessageModal = messageModalOverlay.style.display === 'flex' && !messageModalOverlay.contains(event.target);
            const isClickOutsideDetailsModal = detailsModalOverlay.style.display === 'flex' && !detailsModalOverlay.contains(event.target);


            if (isClickOutsideExport) {
                exportDropdown.classList.add('hidden');
            }
            if (isClickOutsideSearch) {
                suggestionsList.classList.add('hidden');
            }
            if (isClickOutsideMessageModal) {
                console.log('Click outside message modal detected. Hiding message modal.');
                hideInfoModal();
            }
            if (isClickOutsideDetailsModal) {
                console.log('Click outside details modal detected. Hiding details modal.');
                hideDetailsModal();
            }
        });

        // Function to show the details modal
        function showDetailsModal(srId, consignmentOrder) {
            console.log('Attempting to show details modal...');
            // Find the specific item that was clicked in the PROCESSED data
            const clickedItem = processedData.find(item =>
                String(item['SR ID'] || 'N/A') === String(srId) &&
                String(item['Consignment Order Number'] || 'N/A') === String(consignmentOrder)
            );

            const companyName = clickedItem ? (clickedItem['Name of Company'] || 'N/A') : 'N/A';
            const totalQuantity = clickedItem ? (clickedItem['Quantity Sold'] || 0) : 0;
            const totalAmount = clickedItem ? (clickedItem['Amount'] || 0) : 0;
            const displaySrId = clickedItem ? (clickedItem['SR ID'] || 'N/A') : srId;

            modalDetailsBody.innerHTML = `
                <p><strong>Company:</strong> <span>${companyName}</span></p>
                <p><strong>SR ID:</strong> <span>${displaySrId}</span></p>
                <p><strong>C.O.#:</strong> <span>${consignmentOrder}</span></p>
                <p><strong>Total Qty. Sold:</strong> <span>${totalQuantity.toLocaleString()} pcs</span></p> <p><strong>Total Amount:</strong> <span>${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></p>
            `;
            // Directly set display properties
            detailsModalOverlay.style.display = 'flex';
            detailsModalOverlay.style.opacity = '1';
            detailsModalOverlay.style.visibility = 'visible';
            console.log('Details Modal display properties set: display=flex, opacity=1, visibility=visible');
        }

        // Function to hide the details modal
        function hideDetailsModal() {
            console.log('Attempting to hide details modal...');
            // Directly set display properties to hide
            detailsModalOverlay.style.opacity = '0';
            detailsModalOverlay.style.visibility = 'hidden';
            // Use a slight delay before setting display to 'none' to allow transition (if any)
            setTimeout(() => {
                detailsModalOverlay.style.display = 'none';
                console.log('Details Modal display properties reset: display=none, opacity=0, visibility=hidden');
            }, 300); // Match this with your CSS transition duration if you re-enable it
        }

        // Function to update the print/download button label and icon
        function updatePrintButtonLabel() {
            if (window.innerWidth <= 767) { // Mobile view
                printDetailsButton.innerHTML = '<i class="fas fa-share-alt"></i> Confirm and Share';
            } else { // Desktop view
                printDetailsButton.innerHTML = '<i class="fas fa-print"></i> Confirm and Print';
            }
        }

        // New function to generate PNG Blob
        async function generateModalPngBlob() {
            const modalContent = document.querySelector('#detailsModalOverlay .modal-content'); // Target specific modal content
            // Temporarily hide elements that should not appear in the screenshot
            const closeButton = modalContent.querySelector('.modal-close-button');
            const printButton = modalContent.querySelector('#printDetailsButton');

            // Store original display styles
            const originalCloseButtonDisplay = closeButton.style.display;
            const originalPrintButtonDisplay = printButton.style.display;

            // Apply specific styles for PNG capture (same as before)
            const signatureSection = modalContent.querySelector('.signature-section');
            const signatureBlockCentered = modalContent.querySelector('.signature-block-centered');
            const signatureText = modalContent.querySelector('.signature-text');
            const dateLine = modalContent.querySelector('.date-line');
            const modalNote = modalContent.querySelector('.modal-note');
            const printSeparator = modalContent.querySelector('.print-separator');

            const originalSignatureSectionDisplay = signatureSection.style.display;
            const originalSignatureSectionFlexDirection = signatureSection.style.flexDirection;
            const originalSignatureSectionAlignItems = signatureSection.style.alignItems;
            const originalSignatureSectionWidth = signatureSection.style.width;
            const originalSignatureSectionMarginTop = signatureSection.style.marginTop;

            const originalSignatureBlockCenteredDisplay = signatureBlockCentered.style.display;
            const originalSignatureBlockCenteredFlexDirection = signatureBlockCentered.style.flexDirection;
            const originalSignatureBlockCenteredAlignItems = signatureBlockCentered.style.alignItems;
            const originalSignatureBlockCenteredWidth = signatureBlockCentered.style.width;
            const originalSignatureBlockCenteredMarginTop = signatureBlockCentered.style.marginTop;

            const originalSignatureTextFontSize = signatureText.style.fontSize;
            const originalSignatureTextLineHeight = signatureText.style.lineHeight;
            const originalSignatureTextWidth = signatureText.style.width;
            const originalSignatureTextAlign = signatureText.style.textAlign;

            const originalDateLineFontSize = dateLine.style.fontSize;
            const originalDateLineMarginTop = dateLine.style.marginTop;
            const originalDateLineTextAlign = dateLine.style.textAlign;

            const originalModalNoteDisplay = modalNote.style.display;
            const originalModalNoteFontSize = modalNote.style.fontSize;
            const originalPrintSeparatorDisplay = printSeparator.style.display;

            closeButton.style.display = 'none';
            printButton.style.display = 'none';

            signatureSection.style.display = 'flex';
            signatureSection.style.flexDirection = 'column';
            signatureSection.style.alignItems = 'flex-start';
            signatureSection.style.width = '100%';
            signatureSection.style.marginTop = '0';

            signatureBlockCentered.style.display = 'flex';
            signatureBlockCentered.style.flexDirection = 'column';
            signatureBlockCentered.style.alignItems = 'flex-start';
            signatureBlockCentered.style.width = '100%';
            signatureBlockCentered.style.marginTop = '0.75rem';

            signatureText.style.fontSize = '0.6rem';
            signatureText.style.lineHeight = '1.1';
            signatureText.style.textAlign = 'left';
            signatureText.style.width = '75%';

            dateLine.style.fontSize = '0.6rem';
            dateLine.style.marginTop = '0.75rem';
            dateLine.style.textAlign = 'left';

            modalNote.style.display = 'block';
            modalNote.style.fontSize = '0.55rem';
            printSeparator.style.display = 'block';

            try {
                const canvas = await html2canvas(modalContent, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    windowWidth: modalContent.offsetWidth
                });

                // Restore elements immediately after canvas capture
                closeButton.style.display = originalCloseButtonDisplay;
                printButton.style.display = originalPrintButtonDisplay;
                signatureSection.style.display = originalSignatureSectionDisplay;
                signatureSection.style.flexDirection = originalSignatureSectionFlexDirection;
                signatureSection.style.alignItems = originalSignatureSectionAlignItems;
                signatureSection.style.width = originalSignatureSectionWidth;
                signatureSection.style.marginTop = originalSignatureSectionMarginTop;
                signatureBlockCentered.style.display = originalSignatureBlockCenteredDisplay;
                signatureBlockCentered.style.flexDirection = originalSignatureBlockCenteredFlexDirection;
                signatureBlockCentered.style.alignItems = originalSignatureBlockCenteredAlignItems;
                signatureBlockCentered.style.width = originalSignatureBlockCenteredWidth;
                signatureBlockCentered.style.marginTop = originalSignatureBlockCenteredMarginTop;
                signatureText.style.fontSize = originalSignatureTextFontSize;
                signatureText.style.lineHeight = originalSignatureTextLineHeight;
                signatureText.style.width = originalSignatureTextWidth;
                signatureText.style.textAlign = originalSignatureTextAlign;
                dateLine.style.fontSize = originalDateLineFontSize;
                dateLine.style.marginTop = originalDateLineMarginTop;
                dateLine.style.textAlign = originalDateLineTextAlign;
                modalNote.style.display = originalModalNoteDisplay;
                modalNote.style.fontSize = originalModalNoteFontSize;
                printSeparator.style.display = originalPrintSeparatorDisplay;

                return new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/png');
                });
            } catch (error) {
                console.error("Error generating PNG:", error);
                throw error; // Re-throw to be caught by the caller
            }
        }

        // Helper function to trigger download (for fallback)
        function triggerDownload(blob, filename, mimeType) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => URL.revokeObjectURL(url), 10000);

            showMessage("Acknowledgement slip downloaded as PNG.", 'success'); // Show success message after download
        }

        // Function to update the state of acknowledge buttons
        function updateAcknowledgeButtonsState(consignmentOrder) {
            // Add the consignment order to the set of acknowledged ones
            acknowledgedConsignments.add(consignmentOrder);

            // Re-render the table to reflect the updated button states
            renderTable();
        }

        // Event listener for acknowledge buttons (delegated for dynamic content)
        function addAcknowledgeButtonListeners() {
            document.querySelectorAll('.acknowledge-button').forEach(button => {
                // Only add click listener if the button is not already disabled
                if (!button.disabled) {
                    button.onclick = (event) => {
                        console.log('Acknowledge button clicked:', event.currentTarget);
                        event.stopPropagation(); // Stop propagation to prevent window click listener from immediately hiding
                        const srId = event.currentTarget.dataset.srId;
                        const consignmentOrder = event.currentTarget.dataset.consignmentOrder;
                        lastClickedConsignmentOrder = consignmentOrder; // Store the consignment order
                        showDetailsModal(srId, consignmentOrder);
                    };
                }
            });
        }

        // New function to set up event delegation for status buttons
        function setupStatusButtonDelegation() {
            invoiceTableBody.addEventListener('click', (event) => {
                console.log('Click on invoiceTableBody detected. Event target:', event.target); // Debugging log
                const clickedButton = event.target.closest('.status-waiting-clickable');
                if (clickedButton) {
                    console.log('Clicked element has class status-waiting-clickable:', clickedButton); // Debugging log
                    event.stopPropagation(); // Stop propagation to prevent window click listener from immediately hiding
                    const statusText = clickedButton.textContent.trim();
                    console.log('Status button text (trimmed):', statusText); // Debugging log

                    if (statusText === 'Waiting for Invoice') {
                        console.log('Condition met: statusText is "Waiting for Invoice". Calling showInfoModal...'); // Debugging log
                        showInfoModal(
                            "Invoice Status Information",
                            "No invoice has been received in the past 42 hours. If already submitted, you may ignore this message or call local 3018 for assistance."
                        );
                    } else {
                        console.log('Clicked status button is not "Waiting for Invoice". Text:', statusText);
                    }
                } else {
                    console.log('Clicked element is not a status-waiting-clickable button.');
                }
            });
        }

        // Event listeners for modal buttons
        closeModalButton.addEventListener('click', hideDetailsModal);

        printDetailsButton.addEventListener('click', async (event) => {
            console.log('Print/Confirm button clicked.');
            event.stopPropagation(); // Stop propagation to prevent window click listener from immediately hiding
            // Update acknowledge state before print/download/share
            if (lastClickedConsignmentOrder) {
                updateAcknowledgeButtonsState(lastClickedConsignmentOrder);
                lastClickedConsignmentOrder = null; // Clear the stored value
            }

            if (window.innerWidth <= 767) { // Mobile view
                try {
                    console.log('Generating PNG blob for mobile share...');
                    const pngBlob = await generateModalPngBlob(); // New function to get the blob
                    const file = new File([pngBlob], 'acknowledgement_slip.png', { type: 'image/png' });

                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        // Use Web Share API
                        console.log('Using Web Share API.');
                        await navigator.share({
                            files: [file],
                            title: 'Acknowledgement Slip',
                            text: 'Here is your acknowledgement slip.'
                        });
                        showMessage("Acknowledgement slip shared successfully.", 'success');
                    } else {
                        // Fallback to download if Web Share API is not available or cannot share files
                        console.log('Web Share API not available, falling back to download.');
                        triggerDownload(pngBlob, 'acknowledgement_slip.png', 'image/png');
                    }
                } catch (error) {
                    console.error("Error handling share/download:", error);
                    showMessage("Failed to share or download image. Please try again.", 'error');
                }
            } else { // Desktop view, print
                console.log('Initiating print for desktop.');
                // Existing print logic
                document.body.classList.add('print-active');
                const originalSignatureDisplay = signatureSection.style.display;
                signatureSection.style.display = 'flex';
                window.print();
                setTimeout(() => {
                    document.body.classList.remove('print-active');
                    signatureSection.style.display = originalSignatureDisplay;
                }, 500);
            }
            hideDetailsModal(); // Close modal after action
        });

        // Event listeners for the new message modal
        closeMessageModalButton.addEventListener('click', hideInfoModal);
        messageModalOkButton.addEventListener('click', hideInfoModal);

        // Initial data fetch and button label update when the page loads, wrapped in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired. Initializing...');
            // Initially hide mainContent and show loading overlay
            mainContent.classList.add('hidden');
            loadingOverlay.classList.remove('hidden');

            fetchData();
            updatePrintButtonLabel(); // Set initial button label
            setupStatusButtonDelegation(); // Setup the delegated listener once on load
        });

        // Update button label on window resize
        window.addEventListener('resize', updatePrintButtonLabel);
    </script>

</body>
</html>
