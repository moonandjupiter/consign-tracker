<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Status Search</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Color Palette:
            Primary Blue: #4A90E2
            Darker Blue: #2C5F9B
            Light Blue: #EBF4FF
            Accent Green: #6DD47E
            Darker Green: #4CAF50
            Even Darker Green: #065F46
            Light Grey: #A0AEC0
            Dark Grey: #4A5568
            Red (for errors/warnings): #EF4444 / #B91C1C / #FEE2E2 / #FCA5A5
            Yellow (for warnings/pending): #FBBF24 / #92400E / #FEF3C7
        */

        /* Base styles */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
            background-color: #F0F2F5; /* Light background for the page */
            display: flex;
            flex-direction: column;
        }

        /* Header block */
        header.app-header {
            background-color: #4A90E2; /* Primary Blue */
            color: white;
        }

        .version-number {
            color: #EBF4FF; /* Light Blue */
            font-weight: 400;
            font-size: 0.9rem;
        }

        /* Main content area wrapper */
        main#mainContent {
            /* flex-grow is on body's flex-direction: column child */
        }

        /* White content block - now full width */
        .page-content-wrapper {
            background-color: white;
        }


        /* Search input and related elements */
        .search-input-container {
            position: relative;
            flex-grow: 1;
            overflow: visible;
            display: flex;
            align-items: center;
            border: 1px solid #A0AEC0;
            border-radius: 9999px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
            padding-right: 0.5rem;
        }

        .search-input-container:focus-within {
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25);
        }

        .search-input-container input {
            flex-grow: 1;
            padding: 0.75rem 0 0.75rem 1rem;
            border: none;
            background: transparent;
            color: #4A5568;
        }

        .search-input-container input:focus {
            outline: none;
        }

        .search-icon-left {
            margin-left: 1rem;
            color: #A0AEC0;
            pointer-events: none;
            z-index: 1;
        }

        .search-icons-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
        }

        .search-clear-button, .export-button-inside {
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.6;
            font-size: 1.1rem;
            color: #4A5568;
            padding: 0.2rem;
            margin: 0;
            z-index: 102;
            border-radius: 50%;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-clear-button:hover, .export-button-inside:hover:not([disabled]) {
            opacity: 1;
            color: #EF4444;
            background-color: #FFF5F5;
        }

        .export-button-inside:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: none;
            box-shadow: none;
            transform: none;
        }

        #suggestionsList {
            position: absolute;
            background-color: white;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 999;
        }
        #suggestionsList.hidden { display: none; }
        #suggestionsList div {
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: #4A5568;
            font-size: 0.9rem;
            transition: background-color 0.2s ease-in-out;
        }
        #suggestionsList div:hover {
            background-color: #EBF4FF;
            color: #2C5F9B;
        }
        #suggestionsList .load-more-results {
            font-weight: 600;
            text-align: center;
            border-top: 1px solid #E2E8F0;
            color: #4A90E2;
        }
        #suggestionsList .load-more-results:hover {
            background-color: #F8FAFC;
            color: #2C5F9B;
        }

        .soft-dropdown {
            border-radius: 1.5rem;
            padding: 0.75rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18), 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: white;
            opacity: 0;
            visibility: hidden;
            transform: translateY(15px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0.3s;
            border: none;
        }
        .soft-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .soft-dropdown a {
            padding: 0.75rem 1.25rem;
            border-radius: 1rem;
            color: #4A5568;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            display: block;
            text-align: left;
            font-weight: 500;
        }
        .soft-dropdown a:hover {
            background-color: #EBF4FF;
            color: #2C5F9B;
        }

        #quantitySummaryPanel {
            background-color: #EBF4FF;
            border: none;
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            color: #2C5F9B;
            font-weight: 600;
            transition: all 0.3s ease-in-out;
        }
        .summary-content { display: flex; align-items: center; gap: 0.75rem; }
        .summary-icon { font-size: 1.8rem; color: #4A90E2; }
        #consignmentSummaryList {
            margin-top: 1rem;
            font-size: 0.95rem;
            list-style: disc;
            padding-left: 1.5rem;
            color: #4A5568;
        }
        #consignmentSummaryList li { margin-bottom: 0.4rem; }
        #consignmentSummaryList span { font-weight: 700; color: #2C5F9B; }

        .dashboard-section {
            background-color: #F8FAFC;
            border: none;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(0, 0, 0, 0.06);
        }
        .dashboard-main-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1A202C;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .collapsible-section {
            background-color: white;
            border: none;
            border-radius: 1.25rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 1.25rem;
            transition: all 0.3s ease-in-out;
        }
        .collapsible-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #E2E8F0;
            cursor: pointer;
            background-color: #F8FAFC;
            transition: background-color 0.2s ease-in-out;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible-header:hover { background-color: #F3F4F6; }
        .collapsible-content {
            box-sizing: border-box;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease-in-out, padding-top 0.35s ease-in-out, padding-bottom 0.35s ease-in-out;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 0;
            padding-bottom: 0;
        }
        .collapsible-content.expanded {
            max-height: 500px;
            overflow-y: auto;
            padding-top: 1.25rem;
            padding-bottom: 1.25rem;
        }
        .collapsible-icon {
            transition: transform 0.3s ease-in-out;
            border: 1px solid #A0AEC0;
            border-radius: 50%;
            padding: 0.4rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.8rem;
            height: 1.8rem;
            color: #718096;
            background-color: #EEF2F7;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .collapsible-icon.rotate { transform: rotate(180deg); }
        .collapsible-header-summary { display: flex; flex-direction: column; align-items: flex-start; }
        .collapsible-header-summary .sr-id-text { font-size: 1.2rem; font-weight: 600; color: #333; }
        .collapsible-header-summary .status-text-summary { font-size: 0.85rem; font-weight: 500; color: #666; margin-top: 0.15rem; }

        .badge.badge-error { /* For "Awaiting for Invoice" in collapsible header */
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.6rem;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 9999px;
            background-color: #FEE2E2; /* red-100 */
            color: #B91C1C; /* red-700 */
            gap: 0.25rem;
            line-height: 1;
        }
        .badge.badge-error svg {
            width: 0.75rem;
            height: 0.75rem;
        }


        .progress-bar-container { margin-bottom: 0; border: none; box-shadow: none; padding: 0; }
        .progress-bar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .progress-bar-header h4 { font-size: 1.1rem; font-weight: 600; color: #333; margin: 0; }
        .acknowledge-sr-button {
            padding: 0.4em 0.8em;
            border-radius: 9999px;
            font-size: 0.8em;
            font-weight: 600;
            background-color: #FBBF24; /* Yellow for acknowledge */
            color: #78350F; /* Dark amber text */
            border: 1px solid #F59E0B;
            transition: all 0.2s ease-in-out;
            margin-left: 0.5rem; /* Space next to h4 */
        }
        .acknowledge-sr-button:hover:not([disabled]) {
            background-color: #F59E0B;
            color: white;
        }
        .acknowledge-sr-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* DaisyUI-like Steps Styling */
        .progress-bar-stages {
            display: flex;
            align-items: flex-start;
            position: relative;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            color: #A0AEC0; /* Default text color for inactive steps */
        }
        .progress-stage-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            flex: 1;
        }
        .progress-stage-item .progress-stage-circle {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background-color: #E0E0E0;
            border: 2px solid #E0E0E0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.3rem;
            z-index: 2;
            position: relative;
        }
        /* Active step (blue) */
        .progress-stage-item.active .progress-stage-circle {
            background-color: #4A90E2;
            border-color: #4A90E2;
        }
        .progress-stage-item.active {
            color: #2C5F9B;
        }
        .progress-stage-item.active:not(:last-child)::after {
             background-color: #4A90E2;
        }

        /* Completed step (green) */
        .progress-stage-item.completed .progress-stage-circle {
            background-color: #4CAF50; /* Darker Green */
            border-color: #4CAF50;
        }
        .progress-stage-item.completed {
            color: #065F46; /* Even Darker Green for text */
        }
         .progress-stage-item.completed:not(:last-child)::after {
            background-color: #4CAF50; /* Darker Green for line */
        }


        .progress-stage-item.step-pending-invoice .progress-stage-circle {
            background-color: #FEE2E2;
            border-color: #EF4444;
        }
        .progress-stage-item.step-pending-invoice { color: #EF4444; }

        .progress-stage-item.step-pending-voucher .progress-stage-circle {
            background-color: #FEF3C7;
            border-color: #FBBF24;
        }
        .progress-stage-item.step-pending-voucher { color: #FBBF24;}

        .progress-stage-item:not(:last-child)::after {
            content: "";
            position: absolute;
            left: calc(50% + 0.625rem);
            right: calc(-50% + 0.625rem);
            top: 0.625rem;
            transform: translateY(-1px);
            height: 2px;
            background-color: #E0E0E0;
            z-index: 1;
        }
        /* Line color for active step leading to next */
        .progress-stage-item.active:not(:last-child)::after {
            background-color: #4A90E2;
        }
        .progress-stage-item:last-child::after {
            display: none;
        }

        #tableContainer {
            position: relative;
            min-height: 150px;
            border: none;
            border-radius: 1.5rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            background-color: white;
            overflow-x: auto;
        }
        #invoiceTable { min-width: 100%; border-collapse: separate; border-spacing: 0; }
        #invoiceTable thead th {
            background-color: #EBF4FF; color: #2C5F9B; font-weight: 600; text-transform: uppercase;
            font-size: 0.85rem; cursor: pointer; padding: 1rem 1.25rem; position: relative;
            border-bottom: 2px solid #A0AEC0;
        }
        #invoiceTable thead th:first-child { border-top-left-radius: 1rem; }
        #invoiceTable thead th:last-child { border-top-right-radius: 1rem; }
        #invoiceTable tbody tr:last-child td { border-bottom: none; }
        #invoiceTable tbody tr { transition: background-color 0.2s ease-in-out; }
        #invoiceTable tbody tr:nth-child(even) { background-color: #F9FAFB; }
        #invoiceTable tbody tr:hover { background-color: #EBF4FF; }
        #invoiceTable td {
            border-bottom: 1px solid #E2E8F0; padding: 0.85rem 1.25rem; text-align: left;
            font-size: 0.9rem; color: #4A5568;
        }

        .status-button {
            padding: 0.4em 0.8em; border-radius: 9999px; font-size: 0.85em; font-weight: 600;
            white-space: nowrap; transition: all 0.2s ease-in-out; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            display: inline-flex; align-items: center; justify-content: center; cursor: pointer;
            width: max-content; min-width: unset; max-width: 100%;
        }
        .status-button { border: 1px solid; }
        .status-waiting { /* Now for "awaiting for invoice" in table */
            background-color: #FEE2E2; /* Light red */
            color: #B91C1C; /* Darker red text */
            border-color: #FCA5A5; /* Reddish border */
        }
        .status-waiting:hover { /* Optional: Darken on hover */
            background-color: #FECACA; /* red-200 */
            border-color: #F87171; /* red-400 */
        }
        .status-processing { background-color: #BFDBFE; color: #1E40AF; border-color: #93C5FD; }
        .status-processing:hover { background-color: #93C5FD; box-shadow: 0 2px 5px rgba(59, 130, 246, 0.2); }
        .status-done { background-color: #D1FAE5; color: #065F46; border-color: #A7F3D0; }
        .status-done:hover { background-color: #A7F3D0; box-shadow: 0 2px 5px rgba(34, 197, 94, 0.2); }

        /* New Pagination Styles */
        .pagination-join {
            display: inline-flex;
        }
        .pagination-join .btn {
            border: 1px solid #D1D5DB; /* Tailwind gray-300 */
            background-color: white;
            padding: 0.5rem 1rem;
            line-height: 1.25rem;
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* gray-700 */
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            margin-left: -1px; /* Overlap borders */
        }
        .pagination-join .btn:first-child {
            margin-left: 0;
            border-top-left-radius: 0.375rem; /* rounded-md */
            border-bottom-left-radius: 0.375rem;
        }
        .pagination-join .btn:last-child {
            border-top-right-radius: 0.375rem; /* rounded-md */
            border-bottom-right-radius: 0.375rem;
        }
        .pagination-join .btn:hover:not([disabled]):not(.active) {
            background-color: #F3F4F6; /* gray-100 */
            border-color: #9CA3AF; /* gray-400 */
        }
        .pagination-join .btn.active {
            background-color: #4A90E2; /* Primary Blue */
            color: white;
            border-color: #4A90E2;
            z-index: 10;
        }
        .pagination-join .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #F9FAFB; /* gray-50 */
            color: #9CA3AF; /* gray-400 */
        }
        .pagination-join .pagination-arrow {
            font-weight: 600;
        }
        .pagination-join .pagination-number {
            min-width: 2.5rem;
            text-align: center;
        }


        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #4A90E2; background-image: radial-gradient(circle at center, #4A90E2 0%, #2C5F9B 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; color: white; transition: opacity 0.5s ease-out;
        }
        #loadingOverlay.hidden { opacity: 0; pointer-events: none; }
        .loading-text { font-size: 2.5rem; font-weight: 700; margin-top: 2.5rem; animation: fadeInOut 5s infinite alternate; padding: 0 1rem; white-space: nowrap; }
        .version-suffix { font-size: 1.8rem; color: #EBF4FF; font-weight: 600; vertical-align: super; margin-left: 0.2em; }
        .loading-dots-container { display: flex; gap: 1.25rem; margin-bottom: 1.5rem; }
        .loading-dot { width: 1.5rem; height: 1.5rem; border-radius: 50%; background-color: #EBF4FF; animation: bounce 1.4s infinite ease-in-out; }
        .loading-dot:nth-child(1) { background-color: #4A90E2; }
        .loading-dot:nth-child(2) { background-color: #6DD47E; animation-delay: 0.1s; }
        .loading-dot:nth-child(3) { background-color: #FBBF24; animation-delay: 0.2s; }
        .loading-dot:nth-child(4) { background-color: #EF4444; animation-delay: 0.3s; }
        @keyframes fadeInOut { 0% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        .table-loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.85); z-index: 50; display: flex;
            justify-content: center; align-items: center; border-radius: 1.5rem;
        }
        .table-loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .table-loading-overlay .loading-dots-container { width: 5rem; height: 5rem; }
        .table-loading-overlay .loading-dot { width: 1.2rem; height: 1.2rem; animation: sequential-fill 1.2s infinite ease-in-out; }
        @keyframes sequential-fill { 0%, 100% { opacity: 0.3; background-color: #E0E0E0; transform: scale(0.8); } 50% { opacity: 1; background-color: #4A90E2; transform: scale(1.2); } }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; border-radius: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.1);
            padding: 2rem; width: 90%; max-width: 450px; transform: translateY(-20px) scale(0.95);
            transition: transform 0.3s ease-out; border: none; color: #1F2937;
            display: flex; flex-direction: column; justify-content: space-between; min-height: 280px;
        }
        .modal-overlay.show .modal-content { transform: translateY(0) scale(1); }
        .modal-header { display: flex; flex-direction: column; align-items: flex-start; border-bottom: 1px dashed #D1D5DB; padding: 0 0 1rem 0; margin-bottom: 1.5rem; position: relative; }
        .modal-header h2 { font-size: 1.5rem; font-weight: 700; color: #1F2937; text-shadow: none; margin-bottom: 0.75rem; text-align: left; width: calc(100% - 3rem); }
        .modal-close-button { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6B7280; transition: all 0.2s ease-in-out; padding: 0.3rem; border-radius: 50%; }
        .modal-close-button:hover { color: #DC2626; background-color: #FFF5F5; transform: rotate(90deg); }
        .modal-body { flex-grow: 1; padding: 0 0.5rem; display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; }
        .modal-body p { margin-bottom: 0.5rem; font-size: 0.95rem; padding: 0.2rem 0; display: contents; }
        .modal-body strong { color: #4A5568; font-weight: 500; text-align: left; grid-column: 1; }
        .modal-body span { color: #1F2937; font-weight: 600; text-align: left; word-wrap: break-word; grid-column: 2; }
        .modal-footer { display: flex; flex-direction: column; align-items: center; gap: 1.25rem; border-top: 1px dashed #D1D5DB; padding-top: 1.5rem; margin-top: 1rem; }
        .modal-footer button { padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .modal-print-button { background-color: #6DD47E; color: white; border: none; }
        .modal-print-button:hover:not([disabled]) { background-color: #4CAF50; box-shadow: 0 6px 15px rgba(109, 212, 126, 0.25); transform: translateY(-1px); }
        .modal-print-button:disabled {
            background-color: #A0AEC0; /* Tailwind gray-400 */
            color: #EBF4FF;
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border: 1px solid #718096; /* Tailwind gray-500 */
        }
        .modal-note { font-size: 0.8rem; color: #6B7280; text-align: left; margin-top: 1rem; line-height: 1.5; }

        .confirmation-section {
            text-align: left;
            margin-bottom: 1rem;
        }
        .confirmation-section label {
            font-size: 0.85rem;
            line-height: 1.4;
            display: flex;
            align-items: flex-start;
        }
         .confirmation-section input[type="checkbox"] {
            margin-top: 0.2rem;
         }


        @media print {
            body.print-active > *:not(.modal-overlay) { display: none; }
            body.print-active .modal-overlay { position: static; background-color: transparent; display: block; width: auto; height: auto; overflow: visible; justify-content: flex-start; align-items: flex-start; }
            body.print-active .modal-content { width: 100mm; max-width: 100mm; box-shadow: none; border: none; padding: 10mm; transform: none; border-radius: 0; margin: 0; float: left; /* margin-left: 10mm; */ min-height: auto; } /* Removed margin-left */
            body.print-active .modal-header { border-bottom: 1px dashed #D1D5DB; padding-bottom: 0.5rem; margin-bottom: 0.5rem; align-items: flex-start; text-align: left; display: flex; flex-direction: column; padding-left: 0; padding-right: 0; }
            body.print-active .print-header { font-family: 'Poppins', sans-serif; font-size: 0.8rem; margin-bottom: 0.75rem; color: #1F2937; text-align: left; width: 100%; display: block; }
            body.print-active .print-header p { margin: 0; line-height: 1.2; text-align: left; }
            body.print-active .modal-header h2 { font-size: 1.3rem; margin-bottom: 0; font-family: 'Poppins', sans-serif; font-weight: 700; text-align: left; width: 100%; }
            body.print-active .modal-footer { border-top: none; padding-top: 0; margin-top: 0; align-items: flex-start; }
            body.print-active .modal-close-button, body.print-active .modal-footer button.modal-print-button, .no-print { display: none !important; } /* Specifically hide print button in print */
            .only-print { display: block !important; } /* This is for the note */
            body.print-active .modal-body { display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.9rem; margin-bottom: 0.1rem; padding: 0.1rem 0; font-family: 'Poppins', sans-serif; }
            body.print-active .modal-body p { display: contents; }
            body.print-active .modal-body strong { font-weight: 400; text-align: left; font-family: 'Poppins', sans-serif; grid-column: 1; }
            body.print-active .modal-body span { font-weight: 600; text-align: left; font-family: 'Poppins', sans-serif; word-wrap: break-word; grid-column: 2; }
            body.print-active .modal-note.only-print { font-size: 0.7rem; font-style: normal; margin-top: 1rem; text-align: left; color: #6B7280; line-height: 1.4; }

            .print-separator { display: none !important; } /* Hide this separator for print */

            /* Updated Signature Section for Print */
            .signature-section {
                display: flex !important; /* Important to override potential JS inline style if it was 'none' */
                flex-direction: row;
                justify-content: space-between;
                align-items: baseline;
                width: 100%;
                margin-top: 1rem; /* Space above signature area */
                padding-top: 0;
                font-family: 'Poppins', sans-serif;
                color: #1F2937;
            }
            .signature-block-centered { /* Container for signature line and text */
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                width: 60%; /* Adjust as needed */
                margin: 0;
            }
            .signature-line {
                border-bottom: 1px solid #A1A1AA;
                width: 100%; /* Full width of its container */
                margin-bottom: 0.25em; /* Space between line and text */
            }
            .signature-text {
                font-size: 0.75rem;
                text-align: left;
                width: 100%;
                margin-top: 0;
                line-height: 1.2;
            }
            .date-line {
                font-size: 0.75rem;
                width: 35%; /* Adjust as needed */
                text-align: left; /* Or 'right' if date should be right-aligned */
                margin: 0;
                line-height: 1.2; /* Match signature-text */
            }
        }
        .signature-section { display: none; } /* Hidden by default, shown by print CSS or JS for canvas */
        .only-print { display: none; } /* Hidden by default, shown only for print */
        .no-print { /* Visible by default, hidden for print */ }
        .print-separator { display: none; } /* Hidden by default, and now also for print and PNG */


        #messageModalOverlay .modal-content { min-height: unset; max-width: 380px; padding: 1.5rem; }
        #messageModalOverlay .modal-header { padding: 0 0 1rem 0; margin-bottom: 1rem; flex-direction: row; align-items: center; gap: 0.75rem; }
        #messageModalOverlay .modal-header h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0; color: #1F2937; flex-grow: 1; }
        #messageModalOverlay .modal-header i.fas { font-size: 1.5rem; color: #4A90E2; margin-right: 0.25rem; }
        #messageModalOverlay .modal-close-button { top: 0.5rem; right: 0.5rem; font-size: 1.3rem; }
        #messageModalOverlay .modal-body { font-size: 0.95rem; line-height: 1.6; color: #4A5568; flex-grow: unset; padding: 0 0.5rem; }
        #messageModalOverlay .modal-footer { border-top: none; padding-top: 0; margin-top: 1.5rem; justify-content: flex-end; align-items: flex-end; }
        #messageModalOverlay .modal-footer button { background-color: #4A90E2; color: white; padding: 0.6rem 1.2rem; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 9999px; }
        #messageModalOverlay .modal-footer button:hover { background-color: #2C5F9B; box-shadow: 0 6px 15px rgba(74, 144, 226, 0.2); transform: translateY(-1px); }

        /* Footer block */
        footer.app-footer {
            background-color: #4A90E2; /* Primary Blue, matches header */
            color: white; /* Base text color for footer */
            border-top: none;
        }

        .app-footer p {
            margin: 0.2rem 0; /* Adjusted margin for tighter packing */
            color: #EBF4FF;
            font-size: 0.85rem; /* Base for footer p tags */
        }
        .app-footer .copyright {
            font-style: normal;
            color: #EBF4FF;
            font-weight: normal;
        }
        .app-footer .designer {
            font-style: normal;
            color: #EBF4FF;
            font-size: 0.9em; /* Slightly smaller than copyright */
        }

        @media (max-width: 767px) {
            .app-footer p {
                font-size: 0.8rem; /* Mobile footer p font size */
            }

            .dashboard-section { border-radius: 1.5rem; padding: 1.25rem; }
            .collapsible-section { border-radius: 1.25rem; margin-bottom: 1rem; }
            .collapsible-header { padding: 1rem 1.25rem; }
            .collapsible-content.expanded { max-height: 250px; padding-top: 1rem; padding-bottom: 1rem; }
            .collapsible-icon { width: 1.6rem; height: 1.6rem; padding: 0.3rem; }
            #tableContainer { border-radius: 1.25rem; padding: 1rem; }
            #invoiceTable thead th:first-child { border-top-left-radius: 0.75rem; }
            #invoiceTable thead th:last-child { border-top-right-radius: 0.75rem; }
            #invoiceTable thead { display: none; }
            #invoiceTable, #invoiceTable tbody, #invoiceTable tr { display: block; width: 100%; }
            #invoiceTable tr { margin-bottom: 1rem; border: 1px solid #E2E8F0; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            #invoiceTable td { display: grid; grid-template-columns: minmax(80px, max-content) 1fr; gap: 0.75rem; padding: 0.75rem 1rem; align-items: center; min-height: 40px; border-bottom: 1px solid #E2E8F0; font-size: 0.9rem; color: #4A5568; }
            #invoiceTable td:last-child { border-bottom: none; }
            #invoiceTable td::before { content: attr(data-label); display: inline-block; font-weight: 600; color: #4A5568; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            #invoiceTable td > *:not(::before) { text-align: right; word-break: break-word; overflow-wrap: break-word; justify-self: end; }
            #invoiceTable td[data-label="Status:"] { justify-content: flex-end; text-align: right; }
            #invoiceTable td[data-label="Status:"] > *:not(::before) { text-align: right; }
            .modal-content { border-radius: 1rem; padding: 1.25rem; max-width: 95%; }
            .modal-header h2 { font-size: 1.2rem; }
            .modal-footer { padding-top: 1rem; margin-top: 1.5rem; gap: 1rem; }
            .modal-footer button { padding: 0.5rem 1rem; font-size: 0.9rem; }
            .modal-note { font-size: 0.7rem; }
            .print-header { font-size: 0.65rem; }
            .loading-text { font-size: 2rem; margin-top: 30px; }
            .version-suffix { font-size: 1.5rem; }
            .loading-dots-container { gap: 1rem; margin-bottom: 1rem; }
            .loading-dot { width: 1.2rem; height: 1.2rem; }
            .mb-6.flex.flex-row { flex-wrap: nowrap; justify-content: space-between; }
            .search-reset-container { flex-grow: 1; min-width: 200px; margin-bottom: 0; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-100"> <div id="loadingOverlay">
        <div class="loading-dots-container">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
        <h1 class="loading-text">ConsignTracker <span class="version-suffix">v2</span></h1>
    </div>

    <header class="app-header mx-auto max-w-screen-lg w-full px-4 sm:px-6 lg:px-8 py-4 md:py-6 rounded-t-2xl md:rounded-t-xl md:mt-8">
        <div class="flex flex-col md:flex-row justify-between md:items-center h-full">
            <div>
                <h1 class="text-3xl font-bold">ConsignTracker</h1>
                <p class="text-blue-200 mt-1 text-sm">Smart lookup for consignors: reported sales, invoices, and vouchers at a glance.</p>
            </div>
            <div class="version-number mt-2 md:mt-0 self-end text-right md:self-auto md:text-left">Version: 2.0 build 6</div>
        </div>
    </header>

    <main id="mainContent" class="flex-grow w-full flex flex-col">
        <div class="page-content-wrapper mx-auto max-w-screen-lg w-full bg-white shadow-xl flex-grow rounded-none">
            <div class="p-6">
                <div class="mb-6 flex flex-row gap-4 items-center flex-nowrap">
                    <div class="flex-grow search-reset-container">
                        <div class="search-input-container">
                            <i class="fas fa-search search-icon-left"></i>
                            <input type="text" id="searchInput" placeholder="Search by, Consignment Order Number, SR ID, or Invoice No."
                                class="w-full p-3 focus:outline-none text-gray-700">
                            <div class="search-icons-right">
                                <button id="clearSearchButton" class="search-clear-button hidden" title="Clear search">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                                <div class="export-options-inside relative">
                                    <button id="exportButton" disabled class="export-button-inside" title="Export Data">
                                        <i class="fas fa-file-export"></i>
                                    </button>
                                    <div id="exportDropdown" class="soft-dropdown hidden absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-xl z-10">
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="csv">Export as CSV</a>
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="html" id="exportHtmlOption">Export as HTML</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-2">Type your SR ID, Consignment Order #, or Invoice # to search. Select a suggestion or press Enter.</p>
                <div id="quantitySummaryPanel" class="mt-4 p-4 hidden">
                    <div class="summary-content">
                        <i class="fas fa-info-circle summary-icon"></i> <div id="overallSummary"></div>
                    </div>
                    <ul id="consignmentSummaryList" class="mt-2 text-sm font-normal">
                    </ul>
                </div>

                <div id="dashboardContainer" class="mt-6 dashboard-section hidden">
                    <h2 id="dashboardMainTitle" class="dashboard-main-title">Consignment Overview Dashboard</h2>
                    <div id="srProgressBubblesContainer">
                    </div>
                </div>

                <div id="messageBox" class="mt-4 p-4 rounded-md hidden"></div>
                <div id="tableContainer" class="overflow-x-auto mt-4 px-4 py-4 hidden">
                    <table id="invoiceTable" class="min-w-full">
                        <thead>
                            <tr>
                                <th data-sort="SR ID">SR ID</th>
                                <th data-sort="Name of Company">Name of Company</th>
                                <th class="sortable" data-sort="Consignment Order Number">CO No. <i class="fas fa-sort"></i></th>
                                <th data-sort="Quantity Sold">Quantity Sold</th>
                                <th data-sort="Amount">Amount</th>
                                <th data-sort="Invoice No.">Invoice No.</th>
                                <th data-sort="Voucher No.">Voucher No.</th>
                                <th data-sort="Voucher Date">Voucher Date</th>
                                <th data-sort="Status">Status</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-4 text-gray-500 empty-table-message">Enter a search term and press Enter or select a suggestion.</td>
                            </tr>
                        </tbody>
                    </table>
                    <div id="tableLoadingOverlay" class="table-loading-overlay hidden">
                        <div class="loading-dots-container">
                            <div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>
                            <div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="paginationContainer" class="mt-6 p-4 flex justify-center items-center hidden">
                <div class="pagination-join flex">
                    </div>
            </div>
        </div>
    </main>

    <footer class="app-footer mx-auto max-w-screen-lg w-full px-4 sm:px-6 lg:px-8 py-4 md:py-6 text-center rounded-b-2xl md:rounded-b-xl md:mb-8">
        <div class="px-4 sm:px-6 lg:px-8">
            <p class="copyright">&copy; 2025 ConsignTracker. All rights reserved.</p>
            <p class="designer">Built with ❤️ by jTeves.</p>
        </div>
    </footer>

    <div id="detailsModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="print-header">
                    <p>Philippine General Hospital</p>
                    <p>The National University Hospital</p>
                    <p>University of Philippines - Manila</p>
                </div>
                <h2>Sales Report Acknowledgement Slip</h2> <button class="modal-close-button" id="closeModalButton">&times;</button>
            </div>
            <div class="modal-body" id="modalDetailsBody"></div>
            <div class="modal-footer">
                <div class="confirmation-section no-print w-full">
                    <label for="termsCheckbox" class="flex items-start text-sm text-gray-700 cursor-pointer">
                        <input type="checkbox" id="termsCheckbox" class="mr-2 mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 flex-shrink-0">
                        <span>By clicking 'Confirm', you acknowledge that you have reviewed the sales report and agree to the terms, figures, and details it contains. This action signifies your acceptance of the report as accurate and final for the stated period.</span>
                    </label>
                </div>
                <button class="modal-print-button" id="printDetailsButton"></button>
                <div class="print-separator"></div>
                <div class="signature-section">
                    <div class="signature-block-centered">
                        <div class="signature-line"></div>
                        <p class="signature-text">Signature over Printed Name</p>
                    </div>
                    <p class="date-line" id="modalDateLine">Date: _______________</p> </div>
                <p class="modal-note only-print">
                    <strong>Note to Supplier:</strong> Please attach this form to your sales invoice upon submission. Failure to attach may result in delays in verifying and processing your invoice.
                </p>
            </div>
        </div>
    </div>
    <div id="messageModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fas fa-info-circle"></i><h2 id="messageModalTitle"></h2>
                <button class="modal-close-button" id="closeMessageModalButton">&times;</button>
            </div>
            <div class="modal-body" id="messageModalBody"></div>
            <div class="modal-footer">
                <button id="messageModalOkButton">OK</button>
            </div>
        </div>
    </div>
    <div id="suggestionsList" class="hidden"></div>

    <script>
        // Constants for API URL, items per page, and global state variables
        const jsonUrl = "https://raw.githubusercontent.com/moonandjupiter/my-json-data/refs/heads/main/Sheet1_data.json";
        const itemsPerPage = 5;
        let currentPage = 1;
        let allData = [];
        let processedData = [];
        let filteredData = [];
        let lastDisplayedData = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        let lastClickedConsignmentOrder = null;

        let allMatchedSuggestions = [];
        let currentSuggestionOffset = 0;

        const searchInput = document.getElementById('searchInput');
        const clearSearchButton = document.getElementById('clearSearchButton');
        const exportButton = document.getElementById('exportButton');
        const exportDropdown = document.getElementById('exportDropdown');
        const exportHtmlOption = document.getElementById('exportHtmlOption');
        const invoiceTableBody = document.getElementById('invoiceTableBody');

        const messageBox = document.getElementById('messageBox');
        const quantitySummaryPanel = document.getElementById('quantitySummaryPanel');
        const overallSummaryDiv = document.getElementById('overallSummary');
        const consignmentSummaryList = document.getElementById('consignmentSummaryList');
        const suggestionsList = document.getElementById('suggestionsList');
        const sortableTableHeaders = document.querySelectorAll('#invoiceTable th.sortable');
        const tableContainer = document.getElementById('tableContainer');
        const paginationContainer = document.getElementById('paginationContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainContent = document.getElementById('mainContent');
        const tableLoadingOverlay = document.getElementById('tableLoadingOverlay');

        const detailsModalOverlay = document.getElementById('detailsModalOverlay');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalDetailsBody = document.getElementById('modalDetailsBody');
        const printDetailsButton = document.getElementById('printDetailsButton');
        const termsCheckbox = document.getElementById('termsCheckbox');


        const messageModalOverlay = document.getElementById('messageModalOverlay');
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalBody = document.getElementById('messageModalBody');
        const closeMessageModalButton = document.getElementById('closeMessageModalButton');
        const messageModalOkButton = document.getElementById('messageModalOkButton');

        const dashboardContainer = document.getElementById('dashboardContainer');
        const dashboardMainTitle = document.getElementById('dashboardMainTitle');
        const srProgressBubblesContainer = document.getElementById('srProgressBubblesContainer');

        const acknowledgedConsignments = new Set();

        function showMessage(message, type = 'info') {
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-center');
            messageBox.innerHTML = '';

            if (message === "Retrieving consignments..." && type === 'info') {
                messageBox.classList.add('bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-content-center');
                messageBox.textContent = "Retrieving consignments...";
            } else {
                messageBox.classList.add('mt-4', 'p-4', 'rounded-md');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                } else {
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                }
                messageBox.textContent = message;
            }
            messageBox.classList.remove('hidden');
        }

        function hideMessageBox() {
            messageBox.classList.add('hidden');
            messageBox.innerHTML = '';
            messageBox.classList.remove('bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-content-center');
        }

        function showInfoModal(title, message) {
            console.log('Attempting to show info modal...');
            messageModalTitle.textContent = title;
            messageModalBody.textContent = message;
            messageModalOverlay.classList.add('show');
            messageModalOverlay.classList.remove('hidden');
            console.log('Info Modal shown.');
        }

        function hideInfoModal() {
            console.log('Attempting to hide info modal...');
            messageModalOverlay.classList.remove('show');
            messageModalOverlay.classList.add('hidden');
            console.log('Info Modal hidden.');
        }

        function calculateAndDisplaySummary() {
            const totalResults = filteredData.length;
            const resultWord = totalResults === 1 ? 'result' : 'results';
            overallSummaryDiv.textContent = `Found ${totalResults} ${resultWord}:`;

            const consignmentTotals = filteredData.reduce((acc, item) => {
                const consignmentNumber = String(item['Consignment Order Number'] || 'N/A');
                const quantity = parseFloat(String(item['Quantity Sold'] || '0').replace(/[^0-9.-]+/g,"")) || 0;
                const amount = parseFloat(String(item['Amount'] || '0').replace(/[^0-9.-]+/g,"")) || 0;

                if (!acc[consignmentNumber]) {
                    acc[consignmentNumber] = {
                        consignmentOrder: consignmentNumber,
                        quantity: 0,
                        amount: 0
                    };
                }

                if (!isNaN(quantity)) {
                    acc[consignmentNumber].quantity += quantity;
                }
                if (!isNaN(amount)) {
                    acc[consignmentNumber].amount += amount;
                }
                return acc;
            }, {});

            consignmentSummaryList.innerHTML = '';

            if (Object.keys(consignmentTotals).length > 0) {
                const sortedConsignments = Object.entries(consignmentTotals).sort(([keyA, valA], [keyB, valB]) => {
                    return String(valA.consignmentOrder).localeCompare(String(valB.consignmentOrder));
                });

                sortedConsignments.forEach(([compositeKey, totals]) => {
                    const formattedQuantity = totals.quantity.toLocaleString();
                    const formattedAmount = totals.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const pcWord = totals.quantity === 1 ? 'pc' : 'pcs';
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `CO Number ${totals.consignmentOrder} : <span class="font-bold text-blue-700">${formattedQuantity} ${pcWord}</span>, Total Amount <span class="font-bold text-blue-700">${formattedAmount}</span> reported sold.`;
                    consignmentSummaryList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'No consignment breakdown available.';
                consignmentSummaryList.appendChild(listItem);
            }

            if (searchInput.value.trim() !== '' && filteredData.length > 0) {
                quantitySummaryPanel.classList.remove('hidden');
            } else {
                quantitySummaryPanel.classList.add('hidden');
            }
        }

        /**
         * Updates the pagination controls based on the current page and total pages.
         */
        function updatePaginationControls() {
            const paginationJoinDiv = paginationContainer.querySelector('.pagination-join');
            if (!paginationJoinDiv) {
                return;
            }
            paginationJoinDiv.innerHTML = ''; // Clear old buttons

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);

            if (totalPages <= 1) {
                paginationContainer.classList.add('hidden');
                return;
            }
            paginationContainer.classList.remove('hidden');

            // Previous Button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo;';
            prevButton.classList.add('btn', 'pagination-arrow');
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });
            paginationJoinDiv.appendChild(prevButton);

            // Page Number Buttons
            const maxPageButtons = 4;
            let startPage, endPage;

            if (totalPages <= maxPageButtons) {
                startPage = 1;
                endPage = totalPages;
            } else {
                let pagesToShow = maxPageButtons;
                let halfPages = Math.floor(pagesToShow / 2);

                startPage = currentPage - halfPages;
                endPage = currentPage + (pagesToShow - halfPages - 1);

                if (startPage < 1) {
                    endPage += (1 - startPage);
                    startPage = 1;
                }
                if (endPage > totalPages) {
                    startPage -= (endPage - totalPages);
                    endPage = totalPages;
                    if (startPage < 1) startPage = 1;
                }
                 // Ensure we don't exceed maxPageButtons if totalPages is just slightly larger
                if (endPage - startPage + 1 > maxPageButtons) {
                    if (currentPage - startPage < endPage - currentPage) { // current page is closer to startPage
                        endPage = startPage + maxPageButtons - 1;
                    } else { // current page is closer to endPage or in the middle
                        startPage = endPage - maxPageButtons + 1;
                    }
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.add('btn', 'pagination-number');
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    renderTable();
                });
                paginationJoinDiv.appendChild(pageButton);
            }

            // Next Button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '&raquo;';
            nextButton.classList.add('btn', 'pagination-arrow');
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
            paginationJoinDiv.appendChild(nextButton);
        }


        function updateSortIcons() {
            sortableTableHeaders.forEach(header => {
                const sortColumn = header.getAttribute('data-sort');
                const icon = header.querySelector('i');
                if (icon) {
                    if (filteredData.length === 0) {
                        icon.style.visibility = 'hidden';
                        header.classList.remove('sorted-asc', 'sorted-desc');
                    } else {
                        icon.style.visibility = 'visible';
                        icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down');
                        if (sortColumn === currentSortColumn) {
                            icon.classList.add(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                            header.classList.add(currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                        } else {
                            icon.classList.add('fa-sort');
                            header.classList.remove('sorted-asc', 'sorted-desc');
                        }
                    }
                }
            });
        }

        function sortData(column) {
            if (filteredData.length === 0) {
                return;
            }

            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            filteredData.sort((a, b) => {
                const valueA = a[column] || '';
                const valueB = b[column] || '';

                if (column === 'Quantity Sold' || column === 'Amount') {
                    const numA = parseFloat(String(valueA).replace(/[^0-9.-]+/g,"")) || 0;
                    const numB = parseFloat(String(valueB).replace(/[^0-9.-]+/g,"")) || 0;
                    if (numA < numB) return currentSortDirection === 'asc' ? -1 : 1;
                    if (numA > numB) return currentSortDirection === 'asc' ? 1 : -1;
                    return 0;
                }
                if (String(valueA).localeCompare(String(valueB)) < 0) return currentSortDirection === 'asc' ? -1 : 1;
                if (String(valueA).localeCompare(String(valueB)) > 0) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            currentPage = 1;
            renderTable();
            calculateAndDisplaySummary();
        }

        function getStatusHtml(item) {
            const invoiceNo = String(item['Invoice No.'] || '').trim();
            const voucherNo = String(item['Voucher No.'] || '').trim();

            let statusText = '';
            let statusClass = '';

            if (invoiceNo === '' || invoiceNo === '-') {
                statusText = 'awaiting for invoice';
                statusClass = 'status-waiting';
            } else if (voucherNo === '' || voucherNo === '-' || voucherNo === '0') {
                statusText = 'Processing Voucher';
                statusClass = 'status-processing';
            } else {
                statusText = 'complete';
                statusClass = 'status-done';
            }

            return `<span class="status-button ${statusClass}">${statusText}</span>`;
        }

        function renderTable() {
            invoiceTableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const dataToDisplay = filteredData.slice(startIndex, endIndex);

            if (filteredData.length === 0) {
                const message = searchInput.value.trim() === '' ? 'Enter a search term and press Enter or select a suggestion.' : 'No data found for your search.';
                invoiceTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500 empty-table-message">${message}</td></tr>`;

                exportButton.disabled = true;
                tableContainer.classList.add('hidden');
            } else {
                dataToDisplay.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';

                    const invoiceNo = item['Invoice No.'] || '-';
                    let invoiceNoCellContent = invoiceNo;

                    const voucherValue = String(item['Voucher No.'] || '').trim();
                    const hasValidVoucher = voucherValue !== '' && voucherValue !== '0' && voucherValue !== '-';
                    const voucherClass = hasValidVoucher ? 'highlight-voucher' : '';

                    const statusHtml = getStatusHtml(item);

                    const quantitySold = item['Quantity Sold'] ? parseFloat(String(item['Quantity Sold']).replace(/[^0-9.-]+/g,"")).toLocaleString() : '';
                    const amount = item['Amount'] ? parseFloat(String(item['Amount']).replace(/[^0-9.-]+/g,"")).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';

                    row.innerHTML = `
                        <td data-label="SR ID:">${item['SR ID'] || ''}</td>
                        <td data-label="Company:">${item['Name of Company'] || ''}</td>
                        <td data-label="CO No.:">${item['Consignment Order Number'] || ''}</td>
                        <td data-label="Quantity:">${quantitySold}</td>
                        <td data-label="Amount:">${amount}</td>
                        <td data-label="Invoice No.:">${invoiceNoCellContent}</td>
                        <td data-label="Voucher No.:" class="${voucherClass}">${item['Voucher No.'] || '-'}</td>
                        <td data-label="Voucher Date:">${item['Voucher Date'] || '-'}</td>
                        <td data-label="Status:">${statusHtml}</td>
                    `;
                    invoiceTableBody.appendChild(row);
                });

                exportButton.disabled = false;
                tableContainer.classList.remove('hidden');
            }

            updatePaginationControls();
            updateSortIcons();
            addAcknowledgeButtonListeners();
        }

        function mergeData(data) {
            const mergedMap = new Map();

            data.forEach(item => {
                const srId = item['SR ID'] || '';
                const consignmentOrderNumber = item['Consignment Order Number'] || '';
                const key = `${srId}-${consignmentOrderNumber}`;

                const quantity = parseFloat(String(item['Quantity Sold'] || '0').replace(/[^0-9.-]+/g,"")) || 0;
                const amount = parseFloat(String(item['Amount'] || '0').replace(/[^0-9.-]+/g,"")) || 0;

                if (mergedMap.has(key)) {
                    const existing = mergedMap.get(key);
                    existing['Quantity Sold'] += quantity;
                    existing['Amount'] += amount;
                } else {
                    const newItem = { ...item };
                    newItem['Quantity Sold'] = quantity;
                    newItem['Amount'] = amount;
                    mergedMap.set(key, newItem);
                }
            });

            return Array.from(mergedMap.values());
        }

        async function fetchData() {
            loadingOverlay.classList.remove('hidden');
            mainContent.classList.add('hidden');
            console.log('Loading overlay shown, main content hidden.');

            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allData = await response.json();

                processedData = [];
                filteredData = [];
                lastDisplayedData = [];

                hideMessageBox();
                quantitySummaryPanel.classList.add('hidden');
                dashboardContainer.classList.add('hidden');
                renderTable();

                console.log('Raw data fetched successfully. Dashboard and table will load on search.');

                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    console.log('Loading overlay hidden and main content shown after successful fetch (5000ms delay).');
                }, 5000);

            } catch (error) {
                console.error("Error fetching data:", error);
                showMessage(`Failed to load data: ${error.message}`, 'error');
                invoiceTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-red-500 empty-table-message">Error loading data.</td></tr>';
                quantitySummaryPanel.classList.add('hidden');
                dashboardContainer.classList.add('hidden');
                tableContainer.classList.add('hidden');
                paginationContainer.classList.add('hidden');

                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                }, 500);
            }
        }

        function performSearch(searchValue = null) {
            console.log("performSearch called. Search term (raw):", searchInput.value);

            hideMessageBox();
            showMessage("Retrieving consignments...", 'info');
            tableLoadingOverlay.classList.remove('hidden');

            setTimeout(() => {
                invoiceTableBody.innerHTML = '';
                tableLoadingOverlay.classList.add('hidden');

                let searchTerm;
                if (searchValue !== null) {
                    searchTerm = String(searchValue).toLowerCase();
                    searchInput.value = searchTerm;
                    console.log("Searching by suggestion value (Consignment Order Number):", searchTerm);
                } else {
                    searchTerm = searchInput.value.toLowerCase();
                    console.log("Searching by typed input:", searchTerm);
                }

                if (searchTerm) {
                    processedData = mergeData(allData);

                    const relevantCOs = new Set();
                    processedData.forEach(item => {
                        const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                        const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                        const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';

                        if (srId.includes(searchTerm) || consignmentOrderNumber.includes(searchTerm) || invoiceNo.includes(searchTerm)) {
                            if (item['Consignment Order Number']) {
                                relevantCOs.add(item['Consignment Order Number']);
                            }
                        }
                    });

                    filteredData = processedData.filter(item =>
                        relevantCOs.has(item['Consignment Order Number'])
                    );

                    filteredData.sort((a, b) => {
                        const srA = String(a['SR ID'] || '').toLowerCase();
                        const srB = String(b['SR ID'] || '').toLowerCase();
                        if (srA < srB) return -1;
                        if (srA > srB) return 1;
                        return 0;
                    });

                } else {
                    filteredData = [];
                    processedData = [];
                }

                console.log("Filtered Data Length after search:", filteredData.length);
                currentPage = 1;
                calculateAndDisplaySummary();
                renderTable();
                renderDashboard();
                hideMessageBox();

                lastDisplayedData = [...filteredData];

                if (filteredData.length === 0 && searchInput.value.trim() !== '') {
                    showMessage("No matching results found.", 'info');
                }
            }, 500);
        }


        searchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                performSearch();
                suggestionsList.classList.add('hidden');
            }
        });

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderSuggestions(suggestionsToRender, offset) {
            suggestionsList.innerHTML = '';
            const suggestionsPerPage = 5;
            let currentBatch = suggestionsToRender.slice(offset, offset + suggestionsPerPage);

            if (currentBatch.length === 0 && offset > 0) {
                suggestionsList.classList.add('hidden');
                return;
            }

            if (offset === 0 && suggestionsToRender.length <= suggestionsPerPage) {
                currentBatch = suggestionsToRender.sort((a, b) => a.display.localeCompare(b.display));
            } else if (offset === 0 && suggestionsToRender.length > suggestionsPerPage) {
                currentBatch = shuffleArray([...suggestionsToRender]).slice(0, suggestionsPerPage);
            } else if (offset > 0) {
                currentBatch = suggestionsToRender.slice(offset, offset + suggestionsPerPage);
            }


            currentBatch.forEach(suggestion => {
                const suggestionItem = document.createElement('div');
                suggestionItem.textContent = suggestion.display;
                suggestionItem.setAttribute('data-value', suggestion.value);
                suggestionItem.addEventListener('click', (event) => {
                    event.stopPropagation();
                    searchInput.value = suggestion.display;
                    suggestionsList.classList.add('hidden');
                    performSearch(suggestion.value);
                });
                suggestionsList.appendChild(suggestionItem);
            });

            if (suggestionsToRender.length > offset + suggestionsPerPage) {
                const loadMoreItem = document.createElement('div');
                loadMoreItem.textContent = 'Load more results...';
                loadMoreItem.classList.add('load-more-results');
                loadMoreItem.addEventListener('click', (event) => {
                    event.stopPropagation();
                    currentSuggestionOffset += suggestionsPerPage;
                    renderSuggestions(suggestionsToRender, currentSuggestionOffset);
                });
                suggestionsList.appendChild(loadMoreItem);
            }

            if (suggestionsList.children.length > 0) {
                const inputRect = searchInput.getBoundingClientRect();
                suggestionsList.style.top = `${inputRect.bottom + window.scrollY + 4}px`;
                suggestionsList.style.left = `${inputRect.left + window.scrollX}px`;
                suggestionsList.style.width = `${inputRect.width}px`;
                suggestionsList.classList.remove('hidden');
            } else {
                suggestionsList.classList.add('hidden');
            }
        }


        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            suggestionsList.innerHTML = '';
            currentSuggestionOffset = 0;

            if (searchInput.value.length > 0) {
                clearSearchButton.classList.remove('hidden');
            } else {
                clearSearchButton.classList.add('hidden');
            }

            if (searchTerm.length > 2 && allData.length > 0) {
                const matchedItemsMap = new Map();

                allData.forEach(item => {
                    const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                    const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']) : '';
                    const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';
                    const companyName = item['Name of Company'] ? String(item['Name of Company']) : 'Unknown Company';

                    if (srId.includes(searchTerm) || consignmentOrderNumber.toLowerCase().includes(searchTerm) || invoiceNo.includes(searchTerm)) {
                        if (consignmentOrderNumber !== '') {
                            matchedItemsMap.set(consignmentOrderNumber, {
                                display: `${companyName} – ${consignmentOrderNumber}`,
                                value: consignmentOrderNumber
                            });
                        }
                    }
                });

                allMatchedSuggestions = Array.from(matchedItemsMap.values());
                renderSuggestions(allMatchedSuggestions, currentSuggestionOffset);
            } else {
                suggestionsList.classList.add('hidden');
                suggestionsList.innerHTML = '';
                allMatchedSuggestions = [];
                currentSuggestionOffset = 0;
            }
            hideMessageBox();
        });

        clearSearchButton.addEventListener('click', () => {
            searchInput.value = '';
            clearSearchButton.classList.add('hidden');
            hideMessageBox();
            suggestionsList.classList.add('hidden');
            suggestionsList.innerHTML = '';
            allMatchedSuggestions = [];
            currentSuggestionOffset = 0;

            if (lastDisplayedData.length > 0) {
                filteredData = [...lastDisplayedData];
                processedData = mergeData(allData);
            } else {
                filteredData = [];
                processedData = [];
            }

            currentPage = 1;
            renderTable();
            renderDashboard();
        });


        exportButton.addEventListener('click', (event) => {
            event.stopPropagation();
            exportDropdown.classList.toggle('hidden');
            exportDropdown.classList.toggle('show');
        });

        window.addEventListener('click', (event) => {
            const isClickOutsideExport = !exportButton.contains(event.target) && !exportDropdown.contains(event.target);
            const isClickOutsideSearch = !searchInput.contains(event.target) && !suggestionsList.contains(event.target) && !clearSearchButton.contains(event.target);
            const isClickOutsideMessageModal = !messageModalOverlay.classList.contains('hidden') && !messageModalOverlay.contains(event.target) && !event.target.closest('#messageModalOverlay .modal-content');
            const isClickOutsideDetailsModal = !detailsModalOverlay.classList.contains('hidden') && !detailsModalOverlay.contains(event.target) && !event.target.closest('#detailsModalOverlay .modal-content');


            if (isClickOutsideExport) {
                exportDropdown.classList.remove('show');
                exportDropdown.classList.add('hidden');
            }
            if (isClickOutsideSearch) {
                suggestionsList.classList.add('hidden');
            }
            if (isClickOutsideMessageModal) {
                console.log('Click outside message modal detected. Hiding message modal.');
                hideInfoModal();
            }
            if (isClickOutsideDetailsModal) {
                console.log('Click outside details modal detected. Hiding details modal.');
                hideDetailsModal();
            }
        });

        function showDetailsModal(srId, consignmentOrder) {
            console.log('Attempting to show details modal...');
            const clickedItem = processedData.find(item =>
                String(item['SR ID'] || 'N/A') === String(srId) &&
                String(item['Consignment Order Number'] || 'N/A') === String(consignmentOrder)
            );

            const companyName = clickedItem ? (clickedItem['Name of Company'] || 'N/A') : 'N/A';
            const totalQuantity = clickedItem ? (clickedItem['Quantity Sold'] || 0) : 0;
            const totalAmount = clickedItem ? (clickedItem['Amount'] || 0) : 0;
            const displaySrId = clickedItem ? (clickedItem['SR ID'] || 'N/A') : srId;

            modalDetailsBody.innerHTML = `
                <p><strong>Company:</strong> <span>${companyName}</span></p>
                <p><strong>SR ID:</strong> <span>${displaySrId}</span></p>
                <p><strong>C.O.#:</strong> <span>${consignmentOrder}</span></p>
                <p><strong>Total Qty. Sold:</strong> <span>${totalQuantity.toLocaleString()} pcs</span></p>
                <p><strong>Total Amount:</strong> <span>${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></p>
            `;

            // Reset checkbox and disable button
            if(termsCheckbox) { // Check if element exists
                termsCheckbox.checked = false;
                printDetailsButton.disabled = true;
            }


            detailsModalOverlay.classList.add('show');
            detailsModalOverlay.classList.remove('hidden');
            console.log('Details Modal shown.');
        }

        function hideDetailsModal() {
            console.log('Attempting to hide details modal...');
            detailsModalOverlay.classList.remove('show');
            detailsModalOverlay.classList.add('hidden');
            console.log('Details Modal hidden.');
        }

        function updatePrintButtonLabel() {
            if (window.innerWidth <= 767) {
                printDetailsButton.innerHTML = '<i class="fas fa-share-alt"></i> Confirm and Share';
            } else {
                printDetailsButton.innerHTML = '<i class="fas fa-print"></i> Confirm and Print';
            }
        }


        const originalPlaceholder = "Search by, Consignment Order Number, SR ID, or Invoice No.";
        function updateSearchInputPlaceholder() {
            if (window.innerWidth <= 767) {
                searchInput.placeholder = '';
            } else {
                searchInput.placeholder = originalPlaceholder;
            }
        }

        async function generateModalPngBlob() {
            const modalContent = document.querySelector('#detailsModalOverlay .modal-content');
            // Get all elements whose styles will be changed for canvas rendering
            const elementsToStyle = {
                closeButton: modalContent.querySelector('.modal-close-button'),
                printButton: modalContent.querySelector('#printDetailsButton'),
                confirmationSection: modalContent.querySelector('.confirmation-section'),
                signatureSection: modalContent.querySelector('.signature-section'),
                signatureBlockCentered: modalContent.querySelector('.signature-block-centered'),
                signatureLineElement: modalContent.querySelector('.signature-line'), // Renamed to avoid conflict
                signatureText: modalContent.querySelector('.signature-text'),
                dateLine: modalContent.querySelector('#modalDateLine'),
                modalNote: modalContent.querySelector('.modal-note.only-print'),
                printSeparator: modalContent.querySelector('.print-separator')
            };

            const originalCssText = {};
            for (const key in elementsToStyle) {
                if (elementsToStyle[key]) {
                    originalCssText[key] = elementsToStyle[key].style.cssText;
                }
            }

            try {
                // Apply temporary styles for PNG capture, mimicking print styles
                if (elementsToStyle.closeButton) elementsToStyle.closeButton.style.display = 'none';
                if (elementsToStyle.printButton) elementsToStyle.printButton.style.display = 'none';
                if (elementsToStyle.confirmationSection) elementsToStyle.confirmationSection.style.display = 'none';
                if (elementsToStyle.printSeparator) elementsToStyle.printSeparator.style.display = 'none'; // Hide separator for PNG

                if (elementsToStyle.signatureSection) {
                    elementsToStyle.signatureSection.style.display = 'flex';
                    elementsToStyle.signatureSection.style.flexDirection = 'row';
                    elementsToStyle.signatureSection.style.justifyContent = 'space-between';
                    elementsToStyle.signatureSection.style.alignItems = 'baseline';
                    elementsToStyle.signatureSection.style.width = '100%';
                    elementsToStyle.signatureSection.style.marginTop = '1rem';
                    elementsToStyle.signatureSection.style.fontFamily = "'Poppins', sans-serif";
                    elementsToStyle.signatureSection.style.color = '#1F2937';
                }
                if (elementsToStyle.signatureBlockCentered) {
                    elementsToStyle.signatureBlockCentered.style.display = 'flex';
                    elementsToStyle.signatureBlockCentered.style.flexDirection = 'column';
                    elementsToStyle.signatureBlockCentered.style.alignItems = 'flex-start';
                    elementsToStyle.signatureBlockCentered.style.width = '60%';
                    elementsToStyle.signatureBlockCentered.style.margin = '0';
                }
                if (elementsToStyle.signatureLineElement) {
                    elementsToStyle.signatureLineElement.style.width = '100%';
                    elementsToStyle.signatureLineElement.style.marginBottom = '0.25em';
                    elementsToStyle.signatureLineElement.style.borderBottom = '1px solid #A1A1AA';
                }
                if (elementsToStyle.signatureText) {
                    elementsToStyle.signatureText.style.fontSize = '0.75rem';
                    elementsToStyle.signatureText.style.lineHeight = '1.2';
                    elementsToStyle.signatureText.style.width = '100%';
                    elementsToStyle.signatureText.style.marginTop = '0';
                    elementsToStyle.signatureText.style.textAlign = 'left';
                }
                if (elementsToStyle.dateLine) {
                    elementsToStyle.dateLine.style.fontSize = '0.75rem';
                    elementsToStyle.dateLine.style.lineHeight = '1.2';
                    elementsToStyle.dateLine.style.width = '35%';
                    elementsToStyle.dateLine.style.margin = '0';
                    elementsToStyle.dateLine.style.textAlign = 'left';
                }
                if (elementsToStyle.modalNote) {
                    elementsToStyle.modalNote.style.display = 'block';
                    elementsToStyle.modalNote.style.fontSize = '0.7rem';
                    elementsToStyle.modalNote.style.marginTop = '1rem';
                    elementsToStyle.modalNote.style.textAlign = 'left';
                    elementsToStyle.modalNote.style.lineHeight = '1.4';
                    elementsToStyle.modalNote.style.color = '#6B7280';
                }


                const canvas = await html2canvas(modalContent, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    windowWidth: modalContent.scrollWidth,
                    windowHeight: modalContent.scrollHeight
                });

                return new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/png');
                });
            } finally {
                // Revert styles in a finally block
                for (const key in elementsToStyle) {
                    if (elementsToStyle[key]) {
                        elementsToStyle[key].style.cssText = originalCssText[key];
                    }
                }
            }
        }


        function triggerDownload(blob, filename, mimeType) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => URL.revokeObjectURL(url), 10000);

            showMessage("Acknowledgement slip downloaded as PNG.", 'info');
        }

        function updateAcknowledgeButtonsState(consignmentOrder, srIdToUpdate) { // Added srIdToUpdate
            const ackKey = consignmentOrder + '-' + srIdToUpdate; // Use specific key
            acknowledgedConsignments.add(ackKey);
            renderTable();
            renderDashboard();
        }

        function addAcknowledgeButtonListeners() {
            // Target new buttons in dashboard
            document.querySelectorAll('.acknowledge-sr-button').forEach(button => {
                if (!button.disabled) {
                    button.onclick = (event) => {
                        event.stopPropagation();
                        const srId = event.currentTarget.dataset.srId;
                        const consignmentOrder = event.currentTarget.dataset.consignmentOrder;
                        lastClickedConsignmentOrder = consignmentOrder;
                        document.getElementById('detailsModalOverlay').dataset.currentSrId = srId;
                        showDetailsModal(srId, consignmentOrder);
                    };
                }
            });
        }

        function setupStatusButtonDelegation() {
            invoiceTableBody.addEventListener('click', (event) => {
                const clickedButton = event.target.closest('.status-waiting-clickable');
                if (clickedButton) {
                    event.stopPropagation();
                    const statusText = clickedButton.textContent.trim();
                    if (statusText === 'awaiting for invoice') { // Updated text
                    }
                }
            });
        }


        closeModalButton.addEventListener('click', hideDetailsModal);

        if(termsCheckbox && printDetailsButton) {
            termsCheckbox.addEventListener('change', function() {
                printDetailsButton.disabled = !this.checked;
            });
        }


        printDetailsButton.addEventListener('click', async (event) => {
            console.log('Print/Confirm button clicked.');
            event.stopPropagation();

            const currentSrIdForModal = document.getElementById('detailsModalOverlay').dataset.currentSrId;

            if (lastClickedConsignmentOrder && currentSrIdForModal) {
                updateAcknowledgeButtonsState(lastClickedConsignmentOrder, currentSrIdForModal);
                lastClickedConsignmentOrder = null;
                document.getElementById('detailsModalOverlay').dataset.currentSrId = ''; // Clear it
            }

            if (window.innerWidth <= 767) {
                try {
                    console.log('Generating PNG blob for mobile share...');
                    const pngBlob = await generateModalPngBlob();
                    const file = new File([pngBlob], 'acknowledgement_slip.png', { type: 'image/png' });

                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        console.log('Using Web Share API.');
                        await navigator.share({
                            files: [file],
                            title: 'Acknowledgement Slip',
                            text: 'Here is your acknowledgement slip.'
                        });
                        showMessage("Acknowledgement slip shared successfully.", 'info');
                    } else {
                        console.log('Web Share API not available, falling back to download.');
                        triggerDownload(pngBlob, 'acknowledgement_slip.png', 'image/png');
                    }
                } catch (error) {
                    console.error("Error handling share/download:", error);
                    showMessage("Failed to share or download image. Please try again.", 'error');
                }
            } else {
                console.log('Initiating print for desktop.');
                document.body.classList.add('print-active');
                window.print();

                setTimeout(() => {
                    document.body.classList.remove('print-active');
                }, 500);
            }
            hideDetailsModal();
        });


        closeMessageModalButton.addEventListener('click', hideInfoModal);
        messageModalOkButton.addEventListener('click', hideInfoModal);

        function renderDashboard() {
            srProgressBubblesContainer.innerHTML = '';
            const dataToSummarize = filteredData.length > 0 ? filteredData : [];

            if (dataToSummarize.length === 0) {
                dashboardContainer.classList.add('hidden');
                dashboardMainTitle.textContent = "Consignment Overview Dashboard";
                return;
            } else {
                dashboardContainer.classList.remove('hidden');
            }

            const uniqueCOs = new Set();
            const uniqueCompanies = new Set();
            dataToSummarize.forEach(item => {
                uniqueCOs.add(item['Consignment Order Number']);
                uniqueCompanies.add(item['Name of Company']);
            });

            if (uniqueCompanies.size === 1) {
                dashboardMainTitle.textContent = `${Array.from(uniqueCompanies)[0]}`;
            } else if (uniqueCOs.size === 1) {
                dashboardMainTitle.textContent = `Latest update on C.O. ${Array.from(uniqueCOs)[0]}`;
            } else {
                dashboardMainTitle.textContent = "Latest Consignment Updates";
            }

            dataToSummarize.sort((a, b) => {
                const srA = String(a['SR ID'] || '').toLowerCase();
                const srB = String(b['SR ID'] || '').toLowerCase();
                if (srA < srB) return -1;
                if (srA > srB) return 1;
                return 0;
            });

            dataToSummarize.forEach(item => {
                const srId = item['SR ID'] || 'N/A';
                const coNumber = String(item['Consignment Order Number'] || 'N/A');
                const invoiceNo = String(item['Invoice No.'] || '').trim();
                const voucherNo = String(item['Voucher No.'] || '').trim();
                const ackKey = coNumber + '-' + srId;
                const isAcknowledgedForThisSR = acknowledgedConsignments.has(ackKey);


                let statusTextSummary = '';
                let srStepClass = 'inactive';
                let invoiceStepClass = 'inactive';
                let voucherStepClass = 'inactive';
                let acknowledgeButtonHtml = '';
                let collapsibleHeaderStatusHTML = '';


                if ((invoiceNo === '' || invoiceNo === '-') && !isAcknowledgedForThisSR) {
                    srStepClass = 'active';
                    invoiceStepClass = 'step-pending-invoice';
                    voucherStepClass = 'inactive';
                    acknowledgeButtonHtml = `
                        <button class="acknowledge-sr-button ml-2" data-sr-id="${srId}" data-consignment-order="${coNumber}">
                            <i class="fas fa-handshake mr-1"></i> Acknowledge
                        </button>`;
                    collapsibleHeaderStatusHTML = `
                        <span class="badge badge-error gap-1 text-xs py-0.5 px-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-3 h-3 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            Awaiting for Invoice
                        </span>`;

                } else if ( (invoiceNo === '' || invoiceNo === '-') && isAcknowledgedForThisSR) {
                    statusTextSummary = 'Waiting for Invoice';
                    srStepClass = 'active';
                    invoiceStepClass = 'step-pending-invoice';
                    voucherStepClass = 'inactive';
                     acknowledgeButtonHtml = `
                        <button class="acknowledge-sr-button ml-2" disabled>
                            <i class="fas fa-check mr-1"></i> Acknowledged
                        </button>`;
                    collapsibleHeaderStatusHTML = statusTextSummary;
                } else if (voucherNo === '' || voucherNo === '-' || voucherNo === '0') {
                    statusTextSummary = 'Processing Voucher';
                    srStepClass = 'active';
                    invoiceStepClass = 'active';
                    voucherStepClass = 'step-pending-voucher';
                    collapsibleHeaderStatusHTML = statusTextSummary;
                } else {
                    statusTextSummary = 'Completed';
                    srStepClass = 'completed';
                    invoiceStepClass = 'completed';
                    voucherStepClass = 'completed';
                    collapsibleHeaderStatusHTML = statusTextSummary;
                }


                const bubbleHtml = `
                    <div class="collapsible-section">
                        <div class="collapsible-header flex justify-between items-center">
                            <div class="collapsible-header-summary">
                                <span class="sr-id-text">SR ID # ${srId}</span>
                                <span class="status-text-summary mt-1">${collapsibleHeaderStatusHTML}</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-500 collapsible-icon"></i>
                        </div>
                        <div class="collapsible-content">
                            <div class="progress-bar-container">
                                <div class="progress-bar-header">
                                    <h4>Status...</h4>
                                    ${acknowledgeButtonHtml}
                                </div>
                                <div class="progress-bar-stages">
                                    <div class="progress-stage-item ${srStepClass}">
                                        <div class="progress-stage-circle"></div> Sales Report
                                    </div>
                                    <div class="progress-stage-item ${invoiceStepClass}">
                                        <div class="progress-stage-circle"></div> Invoice
                                    </div>
                                    <div class="progress-stage-item ${voucherStepClass}">
                                        <div class="progress-stage-circle"></div> Voucher
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                srProgressBubblesContainer.insertAdjacentHTML('beforeend', bubbleHtml);
            });
            // Event delegation for collapsible headers
            if (!srProgressBubblesContainer.dataset.collapsibleListenerAttached) {
                srProgressBubblesContainer.addEventListener('click', function(event) {
                    const header = event.target.closest('.collapsible-header');
                    if (!header) return;

                    const parentSection = header.closest('.collapsible-section');
                    if (!parentSection) return;

                    const content = parentSection.querySelector('.collapsible-content');
                    const icon = header.querySelector('.collapsible-icon');

                    if (content) {
                        content.classList.toggle('expanded');
                    }
                    if (icon) {
                        icon.classList.toggle('rotate');
                    }
                });
                srProgressBubblesContainer.dataset.collapsibleListenerAttached = 'true';
            }
            addAcknowledgeButtonListeners();
        }


        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired. Initializing...');
            mainContent.classList.add('hidden');
            loadingOverlay.classList.remove('hidden');

            fetchData();
            updatePrintButtonLabel();
            updateSearchInputPlaceholder();
            setupStatusButtonDelegation();
        });

        window.addEventListener('resize', () => {
            updatePrintButtonLabel();
            updateSearchInputPlaceholder();

            if (!suggestionsList.classList.contains('hidden')) {
                const inputRect = searchInput.getBoundingClientRect();
                suggestionsList.style.top = `${inputRect.bottom + window.scrollY + 4}px`;
                suggestionsList.style.left = `${inputRect.left + window.scrollX}px`;
                suggestionsList.style.width = `${inputRect.width}px`;
            }
        });
    </script>

</body>
</html>
