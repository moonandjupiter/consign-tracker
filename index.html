<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Status Search</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensure Poppins font is used and provide a fallback */
        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6; /* Improve readability */
            overflow-x: hidden; /* Prevent horizontal scroll on small screens */
        }

        /* Custom styling for the responsive layout */
        /* Hide table headers on small screens */
        @media (max-width: 767px) { /* Tailwind's 'md' breakpoint is 768px, so this targets screens smaller than that */
            #invoiceTable thead {
                display: none;
            }

            #invoiceTable, #invoiceTable tbody, #invoiceTable tr, #invoiceTable td {
                display: block;
                width: 100%;
            }

            #invoiceTable tr {
                margin-bottom: 15px; /* Add space between rows */
                border: 1px solid #d1d5db; /* Add a border */
                border-radius: 0.5rem; /* Rounded corners */
                background-color: #ffffff; /* White background for default */
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); /* Add a subtle shadow */
                overflow: hidden; /* Ensure rounded corners apply */
            }

            /* Add alternating background colors for rows in mobile view */
            #invoiceTable tbody tr:nth-child(even) {
                background-color: #f9fafb; /* Tailwind gray-50 for even rows */
            }

            #invoiceTable td {
                border-bottom: 1px solid #e5e7eb; /* Tailwind gray-200 */
                position: relative;
                padding: 12px 15px 12px 50%; /* Adjust padding for label and content */
                text-align: right; /* Align data to the right */
                font-size: 0.9rem; /* Slightly smaller text for card items */
                min-height: 40px; /* Ensure a minimum height for the cell */
                display: flex; /* Use flexbox for better label/value alignment */
                align-items: center; /* Vertically center content */
                justify-content: flex-end; /* Align content to the right */
            }

            #invoiceTable td:last-child {
                border-bottom: 0; /* No border on the last item in the card */
            }

            /* Add data labels before the content on small screens */
            #invoiceTable td::before {
                content: attr(data-label);
                position: absolute; /* Keep absolute positioning for the label */
                left: 0;
                width: 45%;
                padding-left: 15px;
                font-weight: 600; /* Semi-bold weight for labels */
                text-align: left; /* Align label to the left */
                color: #4b5563; /* Tailwind gray-600 */
                /* Remove flex-related styles from pseudo-element if any were inherited */
                display: block;
                align-items: initial;
                justify-content: initial;
            }

            /* Emphasize SR ID column in mobile view */
            #invoiceTable td[data-label="SR ID:"] {
                background-color: #e0f2f7; /* A light blue background */
                font-weight: 700; /* Make the text bold */
            }

            /* Highlight Voucher No. on mobile */
            #invoiceTable td[data-label="Voucher No.:"].highlight-voucher {
                /* Removed background-color */
                color: #047857; /* Tailwind emerald-700 */
                font-weight: 600; /* Semi-bold */
            }

            /* Adjust button size and spacing on mobile */
            .mb-6.flex.flex-col.md\:flex-row.gap-4.items-center button {
                width: 100%; /* Make buttons full width on mobile */
                padding: 10px 15px; /* Adjust padding */
                font-size: 1rem; /* Standard font size */
            }

            /* Adjust search and reset button container on mobile */
            .search-reset-container {
                flex-direction: column;
                width: 100%;
            }

            .search-input-container {
                width: 100%;
                margin-bottom: 10px; /* Space between search and reset on mobile */
                position: relative; /* Ensure this is relative for absolute children */
                z-index: 100; /* High z-index for the input container */
            }

            .search-reset-container button {
                width: 100%;
            }

            /* Adjust export options container on mobile */
            .export-options {
                width: 100%;
            }

            .export-options button {
                width: 100%;
            }

            /* Mobile specific dropdown styling */
            .export-dropdown {
                position: static; /* Remove absolute positioning on mobile */
                width: 100%;
                margin-top: 10px; /* Space below the button */
                box-shadow: none; /* Remove shadow on mobile */
                border: 1px solid #d1d5db; /* Add border on mobile */
            }

            .export-dropdown a {
                padding: 10px; /* Adjust padding */
                text-align: center; /* Center text */
            }

            /* Mobile header adjustments */
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .version-number {
                margin-top: 5px;
                font-size: 0.8rem;
            }

            /* Summary panel adjustments for mobile */
            #quantitySummaryPanel {
                font-size: 0.9rem;
                padding: 10px;
            }

            #consignmentSummaryList {
                margin-top: 5px;
                font-size: 0.85rem;
                list-style: disc; /* Add bullet points */
                padding-left: 20px; /* Add padding for bullet points */
            }

            #consignmentSummaryList li {
                margin-bottom: 3px;
            }

            /* Mobile suggestion list styling */
            #suggestionsList {
                position: absolute; /* Changed to absolute for better control */
                width: 100%;
                margin-top: 0; /* Remove default margin-top */
                border-radius: 0.5rem;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
                z-index: 99; /* High z-index, lower than input container */
                background-color: white; /* Ensure background is white */
                border: 1px solid #d1d5db; /* Add border */
                border-top: none; /* No top border */
                left: 0; /* Align with the left edge of the container */
                top: 100%; /* Position directly below the input container */
                max-height: 150px; /* Limit height */
                overflow-y: auto; /* Add scroll if needed */
            }
            #suggestionsList div {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            /* Style for the empty table message on mobile */
            #invoiceTable td.empty-table-message {
                text-align: left; /* Align text to the left */
                justify-content: flex-start; /* Align flex content to the start */
                padding-left: 15px; /* Restore left padding */
                padding-right: 15px; /* Ensure right padding */
            }

            /* Ensure the ::before pseudo-element is hidden for this specific cell */
            #invoiceTable td.empty-table-message::before {
                content: none;
            }

            /* Mobile specific input and icon positioning */
            .search-input-container input {
                padding-left: 45px; /* Increased padding for icon */
            }

            .search-input-container i {
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
                pointer-events: none;
                z-index: 101;
            }

            /* Mobile adjustments for loading overlay */
            #loadingOverlay {
                justify-content: center;
                padding: 0 1rem;
            }

            .loading-text {
                font-size: 2rem;
                margin-top: 30px;
                white-space: nowrap;
            }

            .version-suffix {
                font-size: 0.7em;
                color: #93c5fd;
                font-weight: 600;
                vertical-align: super;
                margin-left: 0.2em;
            }
        }

        /* Default table styling for larger screens (md and up) */
        @media (min-width: 768px) {
            #invoiceTable th,
            #invoiceTable td {
                border-bottom: 1px solid #e5e7eb;
                padding: 12px 16px;
                text-align: left;
            }
            #invoiceTable thead th {
                border-bottom-width: 2px;
                border-top: none;
                background-color: #f3f4f6;
                color: #4b5563;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.8rem;
                cursor: pointer;
                padding-right: 25px;
                position: relative;
            }

            /* Style for sort icons in table headers */
            #invoiceTable thead th i {
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
                font-size: 0.7em;
                visibility: hidden;
            }

            /* Show sort icon when parent th has 'sortable' class and data is filtered */
            #invoiceTable thead th.sortable i {
                visibility: visible;
            }

            /* Highlight Voucher No. on desktop */
            #invoiceTable td.highlight-voucher {
                color: #047857;
                font-weight: 600;
            }

            #invoiceTable tbody tr:last-child td {
                border-bottom: none;
            }
            /* Optional: Add alternating row colors for better readability */
            #invoiceTable tbody tr:nth-child(even) {
                background-color: #f9fafb;
            }
            #invoiceTable tbody tr:hover {
                background-color: #eef2ff;
                transition: background-color 0.2s ease-in-out;
            }

            /* Desktop header adjustments */
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .version-number {
                font-size: 0.9rem;
            }
            /* Summary panel adjustments for desktop */
            #quantitySummaryPanel {
                font-size: 1rem;
                padding: 1rem;
            }

            #consignmentSummaryList {
                margin-top: 8px;
                font-size: 0.9rem;
                list-style: disc;
                padding-left: 25px;
            }

            #consignmentSummaryList li {
                margin-bottom: 4px;
            }

            /* Desktop suggestion list styling */
            #suggestionsList {
                position: absolute;
                width: max-content;
                min-width: 100%;
                max-height: 300px;
                overflow-y: auto;
                background-color: white;
                border: 1px solid #d1d5db;
                border-top: none;
                border-bottom-left-radius: 0.5rem;
                border-bottom-right-radius: 0.5rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 20;
                top: 100%;
                left: 0;
                padding-right: 15px;
            }

            #suggestionsList div {
                padding: 10px 15px;
                cursor: pointer;
                font-size: 0.9rem;
                color: #4b5563;
                white-space: nowrap;
                max-width: none;
            }

            #suggestionsList div:hover {
                background-color: #f3f4f6;
            }
        }

        /* General button styling improvements */
        button {
            transition: all 0.15s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button i {
            margin-right: 8px;
        }

        /* Style for disabled export button */
        #exportButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Style for the search input container and icon */
        .search-input-container {
            position: relative;
            flex-grow: 1;
            overflow: visible;
        }

        /* Default padding for input (desktop and general) */
        .search-input-container input {
            padding-left: 40px;
        }

        /* Default icon positioning (desktop and general) */
        .search-input-container i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
            z-index: 1;
        }

        /* Header styling */
        .header {
            background-color: #1d4ed8;
            color: white;
            padding: 1.5rem;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .header-content {
            display: flex;
        }

        .version-number {
            color: #93c5fd;
            font-weight: 400;
        }

        /* Styling for the summary panel content */
        .summary-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-icon {
            font-size: 1.5rem;
            color: #1e3a8a;
        }

        /* Loading Overlay Styles */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1d4ed8;
            background-image: radial-gradient(circle at center, #1d4ed8 0%, #1e40af 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.5s ease-out;
        }

        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            font-size: 2.5rem;
            font-weight: 700;
            margin-top: 40px;
            animation: fadeInOut 2s infinite alternate;
        }

        .version-suffix {
            font-size: 1.5rem;
            color: #93c5fd;
            font-weight: 600;
            vertical-align: super;
            margin-left: 0.2em;
        }

        .loading-dots-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .loading-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #93c5fd;
            animation: bounce 1.4s infinite ease-in-out;
        }

        /* Specific colors for each dot */
        .loading-dot:nth-child(1) { background-color: #4285F4; }
        .loading-dot:nth-child(2) { background-color: #EA4335; animation-delay: 0.1s; }
        .loading-dot:nth-child(3) { background-color: #FBBC05; animation-delay: 0.2s; }
        .loading-dot:nth-child(4) { background-color: #34A853; animation-delay: 0.3s; }


        /* Keyframe Animations */
        @keyframes fadeInOut {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        /* New CSS for loading dots in message box */
        .loading-message-dots {
            display: inline-block;
            margin-left: 8px;
        }

        .loading-message-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
            margin: 0 2px;
            animation: pulse 1.4s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="loading-dots-container">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
        <h1 class="loading-text">ConsignTracker <span class="version-suffix">v2</span></h1>
    </div>

    <div id="mainContent" class="hidden">
        <div class="container mx-auto max-w-screen-lg bg-white rounded-xl shadow-2xl border border-gray-200 mt-10 mb-10">
            <div class="header">
                <div class="header-content">
                    <div>
                        <h1 class="text-3xl font-bold">ConsignTracker</h1>
                        <p class="text-blue-200 mt-1 text-sm">Smart lookup for consignors: reported sales, invoices, and vouchers at a glance.</p>
                    </div>
                    <div class="version-number">Version: 2.0 build 6</div>
                </div>
            </div>

            <div class="p-6">
                <div class="mb-6 flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex gap-4 flex-grow search-reset-container">
                        <div class="search-input-container">
                            <input type="text" id="searchInput" placeholder="Search by, Consignment Order Number, SR ID, or Invoice No."
                                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent text-gray-700 shadow-sm">
                            <i class="fas fa-search"></i>
                            <div id="suggestionsList" class="hidden"></div>
                        </div>
                        <button id="resetButton"
                                class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-opacity-50 transition duration-150 ease-in-out shadow-sm">
                            <i class="fas fa-sync-alt"></i> Reset
                        </button>
                    </div>

                    <div class="export-options relative">
                        <button id="exportButton" disabled
                                class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50 transition duration-150 ease-in-out shadow-sm">
                            <i class="fas fa-download"></i> Export <i class="fas fa-caret-down ml-2"></i>
                        </button>
                        <div id="exportDropdown" class="export-dropdown hidden absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-xl z-10">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="csv">Export as CSV</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="html" id="exportHtmlOption">Export as HTML</a>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-2">Type your SR ID, Consignment Order #, or Invoice # to search. Select a suggestion or press Enter.</p>
                <div id="quantitySummaryPanel" class="mt-4 p-4 bg-blue-100 border border-blue-200 rounded-lg text-blue-800 font-semibold hidden">
                    <div class="summary-content">
                        <i class="fas fa-info-circle summary-icon"></i> <div id="overallSummary"></div>
                    </div>
                    <ul id="consignmentSummaryList" class="mt-2 text-sm font-normal">
                    </ul>
                    </div>

                <div id="tableContainer" class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm mt-4 px-4">
                    <table id="invoiceTable" class="min-w-full bg-white">
                        <thead class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left" data-sort="SR ID">SR ID</th>
                                <th class="py-3 px-6 text-left" data-sort="Name of Company">Name of Company</th>
                                <th class="py-3 px-6 text-left sortable" data-sort="Consignment Order Number">Consignment Order Number <i class="fas fa-sort"></i></th>
                                <th class="py-3 px-6 text-left" data-sort="Quantity Sold">Quantity Sold</th>
                                <th class="py-3 px-6 text-left" data-sort="Amount">Amount</th>
                                <th class="py-3 px-6 text-left sortable" data-sort="Invoice No.">Invoice No. <i class="fas fa-sort"></i></th>
                                <th class="py-3 px-6 text-left" data-sort="Voucher No.">Voucher No.</th>
                                <th class="py-3 px-6 text-left" data-sort="Voucher Date">Voucher Date</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody" class="text-gray-700 text-sm font-light">
                            <tr>
                                <td colspan="8" class="text-center py-4 text-gray-500 empty-table-message">Enter a search term and press Enter or select a suggestion.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="paginationContainer" class="mt-6 flex flex-col md:flex-row justify-between items-center">
                    <div class="flex gap-4 mb-4 md:mb-0">
                        <button id="prevPageButton"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out shadow-sm">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button id="nextPageButton"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out shadow-sm">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <span id="pageInfo" class="text-gray-700 text-sm"></span>
                </div>

                <div id="messageBox" class="mt-4 p-4 rounded-md hidden"></div>

            </div>
        </div>
    </div>
    <script>
        const jsonUrl = "https://raw.githubusercontent.com/moonandjupiter/my-json-data/refs/heads/main/Sheet1_data.json";
        const itemsPerPage = 5;
        let currentPage = 1;
        let allData = [];
        let filteredData = []; // This will now only be updated on search/reset
        let currentSortColumn = null;
        let currentSortDirection = 'asc'; // 'asc' or 'desc'

        const searchInput = document.getElementById('searchInput');
        const resetButton = document.getElementById('resetButton');
        const exportButton = document.getElementById('exportButton');
        const exportDropdown = document.getElementById('exportDropdown');
        const exportHtmlOption = document.getElementById('exportHtmlOption');
        const invoiceTableBody = document.getElementById('invoiceTableBody');
        const prevPageButton = document.getElementById('prevPageButton');
        const nextPageButton = document.getElementById('nextPageButton');
        const pageInfoSpan = document.getElementById('pageInfo');
        const messageBox = document.getElementById('messageBox');
        const quantitySummaryPanel = document.getElementById('quantitySummaryPanel');
        const overallSummaryDiv = document.getElementById('overallSummary');
        const consignmentSummaryList = document.getElementById('consignmentSummaryList');
        const suggestionsList = document.getElementById('suggestionsList');
        const sortableTableHeaders = document.querySelectorAll('#invoiceTable th.sortable');
        const tableContainer = document.getElementById('tableContainer');
        const paginationContainer = document.getElementById('paginationContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainContent = document.getElementById('mainContent');


        // Function to show messages
        function showMessage(message, type = 'info') {
            // Clear all relevant classes first to ensure a clean slate
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-center');
            messageBox.innerHTML = ''; // Clear previous content

            if (message === "Loading results, please wait..." && type === 'info') {
                messageBox.classList.add('bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-center');
                messageBox.innerHTML = `
                    <span>${message}</span>
                    <span class="loading-message-dots">
                        <span class="loading-message-dot"></span>
                        <span class="loading-message-dot"></span>
                        <span class="loading-message-dot"></span>
                    </span>
                `;
            } else {
                messageBox.classList.add('mt-4', 'p-4', 'rounded-md'); // Re-add base styling
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                } else {
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                }
                messageBox.textContent = message; // Use textContent for simple messages
            }
            messageBox.classList.remove('hidden'); // Ensure message box is visible
        }

        // Function to hide messages
        function hideMessageBox() {
            messageBox.classList.add('hidden');
            messageBox.innerHTML = ''; // Clear content when hidden
            messageBox.classList.remove('bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'flex', 'items-center', 'justify-center'); // Also remove styling classes
        }

        // Function to calculate and display the total quantity of the filtered data and per consignment
        function calculateAndDisplaySummary() {
            const totalResults = filteredData.length;
            const resultWord = totalResults === 1 ? 'result' : 'results';
            overallSummaryDiv.textContent = `Found ${totalResults} ${resultWord}:`;

            const consignmentTotals = filteredData.reduce((acc, item) => {
                const consignmentNumber = item['Consignment Order Number'] || 'N/A';
                const quantity = parseInt(item['Quantity Sold'], 10);
                
                // Initialize the accumulator for this consignmentNumber if it doesn't exist
                if (!acc[consignmentNumber]) {
                    acc[consignmentNumber] = 0;
                }
                
                // Add the quantity to the accumulator for this consignmentNumber
                if (!isNaN(quantity)) {
                    acc[consignmentNumber] += quantity;
                }
                return acc;
            }, {}); // Initial accumulator is an empty object

            consignmentSummaryList.innerHTML = '';

            if (Object.keys(consignmentTotals).length > 0) {
                const sortedConsignments = Object.entries(consignmentTotals).sort(([a], [b]) => a.localeCompare(b));
                sortedConsignments.forEach(([consignment, total]) => {
                    const formattedTotal = total.toLocaleString();
                    const pcWord = total === 1 ? 'pc' : 'pcs';
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `CO Number ${consignment} : <span class="font-bold text-blue-700">${formattedTotal} ${pcWord}</span> reported sold.`;
                    consignmentSummaryList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'No consignment breakdown available.';
                consignmentSummaryList.appendChild(listItem);
            }

            if (searchInput.value.trim() !== '' && filteredData.length > 0) {
                quantitySummaryPanel.classList.remove('hidden');
            } else {
                quantitySummaryPanel.classList.add('hidden');
            }
        }

        // Function to update pagination button states and info
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            pageInfoSpan.textContent = filteredData.length === 0 ? 'No data' : `Page ${currentPage} of ${totalPages}`;

            prevPageButton.disabled = currentPage === 1 || filteredData.length === 0;
            nextPageButton.disabled = currentPage >= totalPages || filteredData.length === 0;
        }

        // Function to update sort icons in table headers
        function updateSortIcons() {
            sortableTableHeaders.forEach(header => {
                const sortColumn = header.getAttribute('data-sort');
                const icon = header.querySelector('i');
                if (icon) {
                    if (filteredData.length === 0) {
                        icon.style.visibility = 'hidden';
                        header.classList.remove('sorted-asc', 'sorted-desc');
                    } else {
                        icon.style.visibility = 'visible';
                        icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down');
                        if (sortColumn === currentSortColumn) {
                            icon.classList.add(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                            header.classList.add(currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                        } else {
                            icon.classList.add('fa-sort');
                            header.classList.remove('sorted-asc', 'sorted-desc');
                        }
                    }
                }
            });
        }

        // Function to sort data
        function sortData(column) {
            if (filteredData.length === 0) {
                return;
            }

            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            filteredData.sort((a, b) => {
                const valueA = a[column] || '';
                const valueB = b[column] || '';

                if (valueA < valueB) {
                    return currentSortDirection === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return currentSortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });

            currentPage = 1;
            renderTable();
            calculateAndDisplaySummary();
        }

        // Function to render the table for the current page
        function renderTable() {
            invoiceTableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const dataToDisplay = filteredData.slice(startIndex, endIndex);

            if (filteredData.length === 0) {
                const message = searchInput.value.trim() === '' ? 'Enter a search term and press Enter or select a suggestion.' : 'No data found for your search.';
                invoiceTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500 empty-table-message">${message}</td></tr>`;

                // Explicitly hide table and pagination when no data is found
                tableContainer.style.display = 'none';
                paginationContainer.style.display = 'none';

            } else {
                dataToDisplay.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    // Determine if voucher number exists to apply highlight class
                    // A voucher is considered valid if it's not empty, not '0', and not '-'
                    const voucherValue = String(item['Voucher No.'] || '').trim();
                    const hasValidVoucher = voucherValue !== '' && voucherValue !== '0' && voucherValue !== '-';
                    const voucherClass = hasValidVoucher ? 'highlight-voucher' : '';

                    row.innerHTML = `
                        <td data-label="SR ID:" class="px-6 py-3">${item['SR ID'] || ''}</td>
                        <td data-label="Company:" class="px-6 py-3">${item['Name of Company'] || ''}</td>
                        <td data-label="Order Number:" class="px-6 py-3">${item['Consignment Order Number'] || ''}</td>
                        <td data-label="Quantity:" class="px-6 py-3">${item['Quantity Sold'] || ''}</td>
                        <td data-label="Amount:" class="px-6 py-3">${item['Amount'] || ''}</td>
                        <td data-label="Invoice No.:" class="px-6 py-3">${item['Invoice No.'] || ''}</td>
                        <td data-label="Voucher No.:" class="px-6 py-3 ${voucherClass}">${item['Voucher No.'] || ''}</td>
                        <td data-label="Voucher Date:" class="px-6 py-3">${item['Voucher Date'] || ''}</td>
                    `;
                    invoiceTableBody.appendChild(row);
                });

                // Explicitly show table and pagination when data is present
                tableContainer.style.display = 'block';
                paginationContainer.style.display = 'flex';
            }

            updatePaginationControls();
            exportButton.disabled = filteredData.length === 0;
            updateSortIcons();
        }

        // Function to fetch data from the JSON URL
        async function fetchData() {
            // Show loading overlay immediately
            loadingOverlay.classList.remove('hidden');
            mainContent.classList.add('hidden');

            // Hide table and pagination initially to prevent flicker if they were visible
            tableContainer.style.display = 'none';
            paginationContainer.style.display = 'none';

            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allData = await response.json();
                filteredData = []; // Reset filtered data on initial load
                hideMessageBox();
                quantitySummaryPanel.classList.add('hidden');

            } catch (error) {
                console.error("Error fetching data:", error);
                showMessage(`Failed to load data: ${error.message}`, 'error');
                // Still hide overlay even on error, but show error message
                invoiceTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500 empty-table-message">Error loading data.</td></tr>';
                quantitySummaryPanel.classList.add('hidden');
                // Ensure main content is visible even on error
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                }, 500); // Shorter delay for error
                return; // Exit if data fetching failed
            } finally {
                // After data is fetched (successfully or not), render the table and then hide the overlay
                renderTable(); // This will show the table/pagination if data is present
                // Add a slightly longer delay for the animation to play before hiding the overlay
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                }, 3000); // Increased to 3 seconds for a longer animation
            }
        }

        // Function to perform the search
        // Accepts an optional searchValue to filter by a specific key value (used for suggestion clicks)
        function performSearch(searchValue = null) {
            // Show loading message and hide table/pagination immediately
            showMessage("Loading results, please wait...", 'info');
            tableContainer.style.display = 'none';
            paginationContainer.style.display = 'none';
            quantitySummaryPanel.classList.add('hidden'); // Hide summary panel during loading

            // Delay the actual search and rendering
            setTimeout(() => {
                if (searchValue !== null) {
                    const searchConsignmentNumber = String(searchValue).toLowerCase();
                    filteredData = allData.filter(item => {
                        const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                        return consignmentOrderNumber === searchConsignmentNumber;
                    });

                } else {
                    const searchTerm = searchInput.value.toLowerCase();

                    if (searchTerm) {
                        let exactMatchFound = false;
                        let exactMatchValue = null;

                        for (const item of allData) {
                            const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                            const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                            const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';

                            if (srId === searchTerm || consignmentOrderNumber === searchTerm || invoiceNo === searchTerm) {
                                exactMatchFound = true;
                                if (srId === searchTerm) exactMatchValue = item['SR ID'];
                                else if (consignmentOrderNumber === searchTerm) exactMatchValue = item['Consignment Order Number'];
                                else if (invoiceNo === searchTerm) exactMatchValue = item['Invoice No.'];
                                break;
                            }
                        }

                        if (exactMatchFound && exactMatchValue !== null) {
                            filteredData = allData.filter(item => {
                                const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                                const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                                const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';
                                return srId === searchTerm || consignmentOrderNumber === searchTerm || invoiceNo === searchTerm;
                            });

                        } else {
                            filteredData = allData.filter(item => {
                                const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                                const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']).toLowerCase() : '';
                                const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';

                                return srId.includes(searchTerm) ||
                                    consignmentOrderNumber.includes(searchTerm) ||
                                    invoiceNo.includes(searchTerm);
                            });
                        }
                    } else {
                        filteredData = [];
                    }
                }

                currentPage = 1;
                calculateAndDisplaySummary();
                renderTable();
                
                // Ensure message box is hidden after search completes, regardless of results
                hideMessageBox();

                // If no results for a non-empty search, show "No matching results found."
                if (filteredData.length === 0 && searchInput.value.trim() !== '') {
                    showMessage("No matching results found.", 'info');
                }

            }, 1500);
        }

        // Optional: Allow pressing Enter in the search field to trigger search
        searchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                performSearch();
                suggestionsList.classList.add('hidden');
            }
        });

        // Event listener for input changes in the search field for suggestions
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            suggestionsList.innerHTML = '';

            if (searchTerm.length > 2 && allData.length > 0) {
                const matchedItems = new Map();

                allData.forEach(item => {
                    const srId = item['SR ID'] ? String(item['SR ID']).toLowerCase() : '';
                    const consignmentOrderNumber = item['Consignment Order Number'] ? String(item['Consignment Order Number']) : 'N/A';
                    const invoiceNo = item['Invoice No.'] ? String(item['Invoice No.']).toLowerCase() : '';
                    const companyName = item['Name of Company'] ? String(item['Name of Company']) : 'Unknown Company';

                    if (srId.includes(searchTerm) || consignmentOrderNumber.toLowerCase().includes(searchTerm) || invoiceNo.includes(searchTerm)) {
                        const suggestionValue = consignmentOrderNumber;
                        const suggestionKey = suggestionValue;

                        if (suggestionValue !== 'N/A' && !matchedItems.has(suggestionKey)) {
                            matchedItems.set(suggestionKey, {
                                display: `${companyName} – ${consignmentOrderNumber}`,
                                value: suggestionValue
                            });
                        }
                    }
                });

                if (matchedItems.size > 0) {
                    const sortedSuggestions = Array.from(matchedItems.values()).sort((a, b) => a.display.localeCompare(b.display));

                    sortedSuggestions.forEach(suggestion => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.textContent = suggestion.display;
                        suggestionItem.setAttribute('data-value', suggestion.value);
                        suggestionItem.classList.add('px-4', 'py-2', 'cursor-pointer', 'hover:bg-gray-100', 'text-gray-700');
                        suggestionItem.addEventListener('click', () => {
                            searchInput.value = suggestion.display;
                            suggestionsList.classList.add('hidden');
                            performSearch(suggestion.value); // Trigger search with animation
                        });
                        suggestionsList.appendChild(suggestionItem);
                    });
                    suggestionsList.classList.remove('hidden');
                } else {
                    suggestionsList.classList.add('hidden');
                }
            } else {
                suggestionsList.classList.add('hidden');
            }
        });

        // Event listener for the reset button
        resetButton.addEventListener('click', () => {
            searchInput.value = '';
            filteredData = [];
            currentPage = 1;
            hideMessageBox();
            currentSortColumn = null;
            currentSortDirection = 'asc';
            calculateAndDisplaySummary();
            renderTable();
            suggestionsList.classList.add('hidden');
            suggestionsList.innerHTML = '';

            // Ensure table and pagination are hidden on reset
            tableContainer.style.display = 'none';
            paginationContainer.style.display = 'none';
        });

        // Hide the dropdown if the user clicks outside of it
        window.addEventListener('click', (event) => {
            if (!exportButton.contains(event.target) && !exportDropdown.contains(event.target) && !searchInput.contains(event.target) && !suggestionsList.contains(event.target)) {
                exportDropdown.classList.add('hidden');
                suggestionsList.classList.add('hidden');
            }
        });

        // Function to update the HTML export option label based on screen size
        function updateHtmlOptionLabel() {
            if (window.innerWidth <= 767) {
                exportHtmlOption.textContent = 'Export for Mobile Browser';
            } else {
                exportHtmlOption.textContent = 'Export as HTML';
            }
        }

        // Update label on page load and window resize
        window.addEventListener('load', updateHtmlOptionLabel);
        window.addEventListener('resize', updateHtmlOptionLabel);

        // Event listener for the previous page button
        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        // Event listener for the next page button
        nextPageButton.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        // Add event listener for the export button to toggle the dropdown visibility
        exportButton.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            exportDropdown.classList.toggle('hidden');
        });

        // Add event listeners for the export dropdown options
        exportDropdown.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const format = link.getAttribute('data-format');

                if (format === 'csv') {
                    exportTableToCSV();
                } else if (format === 'html') {
                    exportTableToHTML();
                }

                exportDropdown.classList.add('hidden');
            });
        });

        // Function to export table data to CSV
        function exportTableToCSV() {
            if (filteredData.length === 0) {
                showMessage("No data to export.", 'info');
                return;
            }

            const headers = Object.keys(filteredData[0]);
            const csvRows = [];

            csvRows.push(headers.map(header => `"${header.replace(/"/g, '""')}"`).join(','));

            filteredData.forEach(item => {
                const values = headers.map(header => {
                    const value = item[header] === null || item[header] === undefined ? '' : String(item[header]);
                    return `"${value.replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'invoice_data.csv');

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => URL.revokeObjectURL(link.href), 10000);

            showMessage("Data exported as CSV.", 'success');
        }

        // Function to export table data to HTML
        function exportTableToHTML() {
            if (filteredData.length === 0) {
                showMessage("No data to export.", 'info');
                return;
            }

            const headers = Object.keys(filteredData[0]);
            let htmlString = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Invoice Data Export</title>
                    <style>
                        body { font-family: sans-serif; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <h1>Invoice Data Export</h1>
                    <table>
                        <thead>
                            <tr>
                                ${headers.map(header => `<th>${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredData.forEach(item => {
                htmlString += '<tr>';
                headers.forEach(header => {
                    const value = item[header] === null || item[header] === undefined ? '' : String(item[header]);
                    htmlString += `<td>${value}</td>`;
                });
                htmlString += '</tr>';
            });

            htmlString += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob([htmlString], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');

            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'invoice_data.html');

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => URL.revokeObjectURL(link.href), 10000);

            showMessage("Data exported as HTML.", 'success');
        }

        // Add event listeners for sortable headers
        sortableTableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortColumn = header.getAttribute('data-sort');
                if (sortColumn) {
                    sortData(sortColumn);
                }
            });
        });

        // Initial data fetch when the page loads, wrapped in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>

</body>
</html>
